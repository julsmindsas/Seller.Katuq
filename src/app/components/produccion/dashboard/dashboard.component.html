<app-breadcrumb [title]="'Produccion'" [items]="['Produccion/Tablero']" [active_item]="'Tablero'"></app-breadcrumb>

<!-- Sección principal -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12">
            <!-- Card principal -->
            <div class="card shadow-sm border-0 mb-4">
                <!-- Loader -->
                <div class="loader-box" *ngIf="loading">
                    <div class="loader-8"></div>
                </div>

                <!-- Header del módulo -->
                <div class="module-header px-4 py-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1 fw-bold text-primary"><i class="pi pi-box me-2"></i>Producción</h5>
                        <p class="text-muted small mb-0">Gestión de producción y seguimiento de artículos</p>
                    </div>
                    
                    <!-- Botón de recomendaciones KAI -->
                    <button pButton type="button" icon="pi pi-brain" label="Recomendaciones KAI" 
                        class="p-button-info p-button-sm"
                        (click)="mostrarRecomendacionesProduccion()"></button>
                </div>
                
                <!-- Alertas de producción -->
                <div class="px-4 py-3 bg-light border-bottom" *ngIf="!loading && (pedidosUrgentes?.length > 0 || pedidosEnRiesgo?.length > 0)">
                    <div class="d-flex flex-column">
                        <div class="alert alert-warning mb-2" *ngIf="pedidosUrgentes?.length > 0">
                            <div class="d-flex align-items-center">
                                <i class="pi pi-exclamation-triangle fs-4 me-3"></i>
                                <div>
                                    <h6 class="mb-1 fw-bold">Producción Urgente</h6>
                                    <p class="mb-0">
                                        Hay <strong>{{ pedidosUrgentes?.length }}</strong> artículos que requieren atención inmediata
                                        <span *ngIf="pedidosUrgentes?.length > 0">
                                            (Más urgente: {{ pedidosUrgentes[0]?.nombreArticulo }} - Entrega: {{ pedidosUrgentes[0]?.detallePedido[0]?.fechaEntrega | date:'dd/MM/yyyy' }})
                                        </span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mb-0" *ngIf="pedidosEnRiesgo?.length > 0">
                            <div class="d-flex align-items-center">
                                <i class="pi pi-clock fs-4 me-3"></i>
                                <div>
                                    <h6 class="mb-1 fw-bold">Producción en Riesgo</h6>
                                    <p class="mb-0">
                                        Hay <strong>{{ pedidosEnRiesgo?.length }}</strong> artículos que podrían retrasarse
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de KPI avanzados de producción -->
                <div class="metrics-container p-3 mb-3 border-bottom bg-white" *ngIf="!loading">
                    <div class="row">
                        <div class="col-12 mb-2">
                            <h6 class="fw-bold text-primary mb-2">
                                <i class="pi pi-chart-line me-2"></i>
                                Métricas Avanzadas de Producción
                            </h6>
                        </div>
                        
                        <!-- KPIs de estado de producción -->
                        <div class="col-md-4">
                            <div class="card shadow-sm h-100">
                                <div class="card-body p-3">
                                    <h6 class="card-title text-muted mb-3">Estado de Producción</h6>
                                    <div class="d-flex flex-column gap-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-danger fw-bold">Urgentes</span>
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="width: 100px; height: 6px;">
                                                    <div class="progress-bar bg-danger" [style.width.%]="(pedidosUrgentes?.length / ordersEnsamble?.length) * 100 || 0"></div>
                                                </div>
                                                <span class="text-danger">
                                                    {{ pedidosUrgentes?.length || 0 }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-warning fw-bold">En Riesgo</span>
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="width: 100px; height: 6px;">
                                                    <div class="progress-bar bg-warning" [style.width.%]="(pedidosEnRiesgo?.length / ordersEnsamble?.length) * 100 || 0"></div>
                                                </div>
                                                <span class="text-warning">
                                                    {{ pedidosEnRiesgo?.length || 0 }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-success fw-bold">Al día</span>
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="width: 100px; height: 6px;">
                                                    <div class="progress-bar bg-success" [style.width.%]="(pedidosNormales?.length / ordersEnsamble?.length) * 100 || 0"></div>
                                                </div>
                                                <span class="text-success">{{ pedidosNormales?.length || 0 }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- KPIs de eficiencia por proceso -->
                        <div class="col-md-4">
                            <div class="card shadow-sm h-100">
                                <div class="card-body p-3">
                                    <h6 class="card-title text-muted mb-3">Eficiencia por Proceso</h6>
                                    <div class="d-flex flex-column gap-2">
                                        <div class="d-flex justify-content-between align-items-center" *ngFor="let proceso of procesosEficiencia">
                                            <span class="fw-bold">{{ proceso.nombre }}</span>
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-2" style="width: 100px; height: 6px;">
                                                    <div class="progress-bar" 
                                                         [ngClass]="{
                                                            'bg-success': proceso.eficiencia >= 80,
                                                            'bg-warning': proceso.eficiencia < 80 && proceso.eficiencia >= 50,
                                                            'bg-danger': proceso.eficiencia < 50
                                                         }"
                                                         [style.width.%]="proceso.eficiencia"></div>
                                                </div>
                                                <span [ngClass]="{
                                                    'text-success': proceso.eficiencia >= 80,
                                                    'text-warning': proceso.eficiencia < 80 && proceso.eficiencia >= 50,
                                                    'text-danger': proceso.eficiencia < 50
                                                }">
                                                    {{ proceso.eficiencia }}%
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- KPI de capacidad y carga -->
                        <div class="col-md-4">
                            <div class="card shadow-sm h-100">
                                <div class="card-body p-3">
                                    <h6 class="card-title text-muted mb-3">Capacidad y Carga</h6>
                                    <div class="capacity-container">
                                        <div class="capacity-gauge mb-3">
                                            <div class="capacity-value">
                                                <span class="value">{{ capacidadUtilizada || 0 }}%</span>
                                                <span class="label">Utilizada</span>
                                            </div>
                                            <div class="capacity-fill" [style.width.%]="capacidadUtilizada || 0" 
                                                 [ngClass]="{
                                                    'bg-success': capacidadUtilizada < 70,
                                                    'bg-warning': capacidadUtilizada >= 70 && capacidadUtilizada < 90,
                                                    'bg-danger': capacidadUtilizada >= 90
                                                 }"></div>
                                        </div>
                                        <div class="capacity-stats">
                                            <div class="capacity-stat">
                                                <span class="stat-value">{{ ensamblesPendientes }}</span>
                                                <span class="stat-label">Pendientes</span>
                                            </div>
                                            <div class="capacity-stat">
                                                <span class="stat-value">{{ ensamblesProceso }}</span>
                                                <span class="stat-label">En proceso</span>
                                            </div>
                                            <div class="capacity-stat">
                                                <span class="stat-value">{{ ensamblesCompletados }}</span>
                                                <span class="stat-label">Completados</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-body p-0">
                        <p-tabView [scrollable]="false" (onChange)="handleChange($event)">
                        <!-- TAB DE ENSAMBLE -->
                            <p-tabPanel header="Ensamble">
                            <!-- Filtros de búsqueda -->
                            <div class="filtros-container bg-light p-3 border-bottom">
                                <div class="d-flex flex-column">
                                    <!-- Encabezado de filtros -->
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="mb-0 text-muted">
                                            <i class="pi pi-filter text-primary me-2"></i>
                                            <span>Filtros de búsqueda</span>
                                        </h6>
                                    </div>
                                    
                                    <!-- Filtros -->
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-4 col-sm-6">
                                            <label for="proceso" class="form-label small text-muted mb-1">Proceso</label>
                                                <p-dropdown [options]="filterProcessCombo"
                                                    [(ngModel)]="selectedProcesosFilter"
                                                placeholder="Seleccione un proceso" 
                                                optionLabel="label"
                                                    optionValue="value"
                                                styleClass="w-100"
                                                (onChange)="filterOrderByProcess($event)">
                                                <ng-template let-item pTemplate="item">
                                                    <div class="d-flex align-items-center">
                                                        <i class="pi pi-tag me-2 text-primary"></i>
                                                        <span>{{ item.label }}</span>
                                                    </div>
                                                </ng-template>
                                            </p-dropdown>
                                        </div>
                                        <div class="col-md-4 col-sm-6">
                                            <label for="fechaInicial" class="form-label small text-muted mb-1">Fecha Inicial</label>
                                            <p-calendar id="fechaInicial" 
                                                [(ngModel)]="fechaInicial"
                                                [showIcon]="true"
                                                dateFormat="dd/mm/yy"
                                                [readonlyInput]="true"
                                                styleClass="w-100"
                                                [inputStyleClass]="'form-control form-control-sm rounded'">
                                            </p-calendar>
                                        </div>
                                        <div class="col-md-4 col-sm-6">
                                            <label for="fechaFinal" class="form-label small text-muted mb-1">Fecha Final</label>
                                            <p-calendar id="fechaFinal" 
                                                [(ngModel)]="fechaFinal"
                                                [showIcon]="true"
                                                dateFormat="dd/mm/yy"
                                                [readonlyInput]="true"
                                                styleClass="w-100"
                                                [inputStyleClass]="'form-control form-control-sm rounded'">
                                            </p-calendar>
                                            </div>
                                            </div>
                                    
                                    <!-- Botones de acción para filtros -->
                                    <div class="row mt-3">
                                        <div class="col-md-8">
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-primary" (click)="refrescarDatosEnsamble()">
                                                    <i class="pi pi-search me-1"></i>Buscar
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary" (click)="clear(dtEnsamble)">
                                                    <i class="pi pi-refresh me-1"></i>Limpiar
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary" (click)="filtrarParaHoy()">
                                                    <i class="pi pi-calendar-today me-1"></i>Hoy
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary" (click)="filtrarParaManana()">
                                                    <i class="pi pi-calendar me-1"></i>Mañana
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary" (click)="filtrarParaPasadoManana()">
                                                    <i class="pi pi-calendar-plus me-1"></i>Pasado mañana
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button pButton 
                                                type="button" 
                                                label="Cerrar Producto" 
                                                icon="pi pi-inbox" 
                                                class="p-button-outlined"
                                                (click)="cerrarProductosSeleccionados(cerrarProductoModal)">
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Selector de columnas moderno -->
                            <div class="mb-3 d-flex align-items-center gap-2 px-3 pt-3 justify-content-between">
                                <div class="column-selector-container">
                                    <p-multiSelect [options]="columns"
                                                  [(ngModel)]="selectedColumns"
                                                  optionLabel="header"
                                                  display="chip"
                                                  [panelStyle]="{ 'min-width': '280px', 'max-width': '340px', 'border-radius': '12px', 'box-shadow': '0 4px 20px rgba(0,0,0,0.08)' }"
                                                  styleClass="modern-multiselect"
                                                  [showToggleAll]="false"
                                                  [filter]="true"
                                                  defaultLabel="Columnas a mostrar"
                                                  selectedItemsLabel="{0} columnas">
                                        <ng-template let-option pTemplate="item">
                                            <div class="column-option-item">
                                                <i [ngClass]="option.icon" class="option-icon"></i>
                                                <div>
                                                    <span class="option-title">{{ option.header }}</span>
                                                    <div class="option-description">{{ option.description }}</div>
                                                </div>
                                            </div>
                                        </ng-template>
                                        <ng-template pTemplate="selectedItems" let-value>
                                            <div class="selected-columns-chip">
                                                <i class="pi pi-table me-1"></i> {{ value?.length || 0 }} columnas
                                            </div>
                                        </ng-template>
                                    </p-multiSelect>
                                    <button pButton pRipple type="button" icon="pi pi-undo" 
                                            class="reset-columns-btn"
                                            pTooltip="Restaurar columnas"
                                            tooltipPosition="top"
                                            (click)="resetColumnConfig()">
                                    </button>
                                </div>
                                
                                <!-- Control de densidad de visualización -->
                                <div class="density-control-container">
                                    <span class="density-label me-2">Densidad:</span>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn" 
                                                [ngClass]="{'btn-primary': tableDensity === 'compact', 'btn-outline-secondary': tableDensity !== 'compact'}"
                                                (click)="setTableDensity('compact')"
                                                pTooltip="Vista compacta" tooltipPosition="top">
                                            <i class="pi pi-align-justify"></i>
                                        </button>
                                        <button type="button" class="btn" 
                                                [ngClass]="{'btn-primary': tableDensity === 'normal', 'btn-outline-secondary': tableDensity !== 'normal'}"
                                                (click)="setTableDensity('normal')"
                                                pTooltip="Vista normal" tooltipPosition="top">
                                            <i class="pi pi-list"></i>
                                        </button>
                                        <button type="button" class="btn" 
                                                [ngClass]="{'btn-primary': tableDensity === 'expanded', 'btn-outline-secondary': tableDensity !== 'expanded'}"
                                                (click)="setTableDensity('expanded')"
                                                pTooltip="Vista expandida" tooltipPosition="top">
                                            <i class="pi pi-th-large"></i>
                                        </button>
                                    </div>
                                    <button pButton 
                                            class="ms-2 p-button-outlined p-button-sm"
                                            icon="pi pi-arrows-alt" 
                                            pTooltip="Ajustar columnas automáticamente" 
                                            tooltipPosition="top"
                                            (click)="autoAdjustColumns()">
                                    </button>
                                </div>
                            </div>

                            <!-- Tabla de Producción Moderna -->
                            <div class="px-3 pb-3">
                                <div class="production-table-container">
                                    <p-table #dtEnsamble 
                                        [value]="ordersEnsamble" 
                                        dataKey="nombreArticulo" 
                                        [rows]="10"
                                        [rowsPerPageOptions]="[5,10,25,50]" 
                                        [loading]="loading"
                                        styleClass="modern-production-table density-{{tableDensity}}" 
                                        [paginator]="true"
                                        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} artículos"
                                        [globalFilterFields]="['nombreProducto', 'nombreArticulo']">
                                        
                                        <ng-template pTemplate="header">
                                            <tr>
                                                <td class="action-column"></td>
                                                <th *ngFor="let col of selectedColumns" 
                                                    [ngClass]="{'text-start': col.field === 'nombreArticulo' || col.field === 'nombreProducto' || col.field === 'tracking' || col.field === 'fechaEntrega' || col.field === 'horarioEntrega',
                                                              'text-end': col.field === 'cantidadTotalProducto' || col.field === 'cantidadTotalProductoEnsamble'}">
                                                    <div class="header-cell" pTooltip="{{ col.description }}" tooltipPosition="top">
                                                        <i [ngClass]="col.icon"></i>
                                                        <span>{{ col.header }}</span>
                                                    </div>
                                            </th>
                                        </tr>
                                    </ng-template>

                                        <ng-template pTemplate="body" let-row>
                                            <tr class="product-row">
                                                <td class="action-column">
                                                    <button type="button" 
                                                        pButton 
                                                        pRipple 
                                                        icon="pi pi-sitemap"
                                                        class="process-menu-btn"
                                                        pTooltip="Ver procesos de fabricación"
                                                        tooltipPosition="right"
                                                        (click)="seleccionarProcesoACerrar(processSelecteModal, row)">
                                                    </button>
                                            </td>
                                                <td *ngFor="let col of selectedColumns"
                                                    [ngClass]="{'text-start': col.field === 'nombreArticulo' || col.field === 'nombreProducto' || col.field === 'tracking' || col.field === 'fechaEntrega' || col.field === 'horarioEntrega',
                                                                'text-end': col.field === 'cantidadTotalProducto' || col.field === 'cantidadTotalProductoEnsamble',
                                                                'numeric-cell': col.field === 'cantidadTotalProducto' || col.field === 'cantidadTotalProductoEnsamble'}">
                                                    
                                                    <ng-container [ngSwitch]="col.field">
                                                        <!-- Tracking/Proceso -->
                                                        <ng-container *ngSwitchCase="'tracking'">
                                                            <button pButton 
                                                                icon="pi pi-cog"
                                                                class="process-action-btn"
                                                                pTooltip="Ver proceso de fabricación"
                                                                tooltipPosition="top"
                                                                (click)="mostrarTracking(trackinModal, row)">
                                                            </button>
                                                        </ng-container>
                                                        
                                                        <!-- Estado de Proceso -->
                                                        <ng-container *ngSwitchCase="'proceso'">
                                                            <div class="process-status-indicator" 
                                                                 [ngClass]="getProcessStatusClass(row)"
                                                                 pTooltip="{{getProcessStatusTooltip(row)}}"
                                                                 tooltipPosition="top">
                                                                <i [class]="getProcessStatusIcon(row)"></i>
                                                            </div>
                                                        </ng-container>
                                                        
                                                        <!-- Cantidades con estilo numérico -->
                                                        <ng-container *ngSwitchCase="'cantidadTotalProducto'">
                                                            <div class="quantity-value">{{ row[col.field] }}</div>
                                                        </ng-container>
                                                        
                                                        <ng-container *ngSwitchCase="'cantidadTotalProductoEnsamble'">
                                                            <div class="quantity-value">{{ row[col.field] }}</div>
                                                        </ng-container>
                                                        
                                                        <!-- Fechas y horarios -->
                                                        <ng-container *ngSwitchCase="'fechaEntrega'">
                                                            <div class="date-cell" pTooltip="{{ row[col.field] }}" tooltipPosition="top">
                                                                <i class="pi pi-calendar-plus date-icon"></i>
                                                                <span>{{ row[col.field] }}</span>
                                                            </div>
                                                        </ng-container>
                                                        
                                                        <ng-container *ngSwitchCase="'horarioEntrega'">
                                                            <div class="time-cell" pTooltip="{{ row[col.field] }}" tooltipPosition="top">
                                                                <i class="pi pi-clock time-icon"></i>
                                                                <span>{{ row[col.field] }}</span>
                                                            </div>
                                                        </ng-container>
                                                        
                                                        <!-- Artículo - columna principal -->
                                                        <ng-container *ngSwitchCase="'nombreArticulo'">
                                                            <div class="article-name-container" 
                                                                 pTooltip="{{ row[col.field] }}" 
                                                                 tooltipPosition="top">
                                                                <div class="article-name">
                                                                    {{ row[col.field] }}
                                                                </div>
                                                            </div>
                                                        </ng-container>
                                                        
                                                        <!-- Producto -->
                                                        <ng-container *ngSwitchCase="'nombreProducto'">
                                                            <div class="product-name-container"
                                                                 pTooltip="{{ row[col.field] }}" 
                                                                 tooltipPosition="top">
                                                                <div class="product-name">
                                                                    {{ row[col.field] }}
                                                                </div>
                                                            </div>
                                                        </ng-container>
                                                        
                                                        <!-- Default para otras columnas -->
                                                        <ng-container *ngSwitchDefault>
                                                            <span>{{ row[col.field] }}</span>
                                                        </ng-container>
                                                    </ng-container>
                                            </td>
                                        </tr>
                                    </ng-template>

                                    <ng-template pTemplate="emptymessage">
                                        <tr>
                                                <td [attr.colspan]="selectedColumns.length + 1">
                                                    <div class="empty-state">
                                                        <div class="empty-icon-container">
                                                            <i class="pi pi-box"></i>
                                                        </div>
                                                        <h5>Sin artículos disponibles</h5>
                                                        <p>No se encontraron artículos que coincidan con los criterios establecidos.</p>
                                                    </div>
                                                </td>
                                        </tr>
                                    </ng-template>
                                </p-table>
                                </div>
                            </div>
                            </p-tabPanel>

                        <!-- TAB DE LISTA DE PEDIDOS -->
                            <p-tabPanel header="Lista pedidos">
                                <app-list-orders [isFromProduction]="true" #listOrders
                                (producirPedido)="producirPedido($event)">
                            </app-list-orders>
                            </p-tabPanel>
                        </p-tabView>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Modales-->
<!-- Modal Vista pedido para imprimir -->
<ng-template #modalContent let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">Vista pedido para imprimir</h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div [innerHtml]="htmlModal" id="htmlPdf"></div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-outline-dark" (click)="modal.close('Save click')">Cerrar</button>
        <button type="button" class="btn btn-outline-dark" (click)="imprimirToPdf()">Imprimir</button>
    </div>
</ng-template>

<!-- Modal Clientes -->
<ng-template #clientesModal let-modal>
    <div class="modal-header modern-modal-header">
        <h4 class="modal-title">
            <i class="pi pi-user me-2"></i>
            <span>Información del Cliente</span>
        </h4>
        <button type="button" class="close modern-close-btn" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <i class="pi pi-times"></i>
        </button>
    </div>
    <div class="modal-body">
        <app-clientes #clientes name="clientes" id="clientes" [isEdit]="true"
            [clienteEdit]="clienteSeleccionado"></app-clientes>
    </div>
</ng-template>

<!-- Modal Datos de Entrega -->
<ng-template #datosEnregaModal let-modal>
    <div class="modal-header modern-modal-header">
        <h4 class="modal-title">
            <i class="pi pi-truck me-2"></i>
            <span>Datos de Entrega</span>
        </h4>
        <button type="button" class="close modern-close-btn" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <i class="pi pi-times"></i>
        </button>
    </div>
    <div class="modal-body">
    </div>
</ng-template>

<!-- Modal Cerrar Artículo -->
<ng-template #cerrarArticuloModal let-modal>
    <div class="modal-header modern-modal-header bg-primary text-white">
        <h4 class="modal-title">
            <i class="pi pi-box me-2"></i>
            <span>Configuración {{selectedProcesos}}</span>
        </h4>
        <button type="button" class="close modern-close-btn" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <i class="pi pi-times"></i>
        </button>
    </div>
    <div class="modal-body">
        <app-cerrararticulo #cerrarArticuloApp [selectedOrdersEnsamble]="selectedOrdersEnsamble"
            [processSelected]="selectedProcesos" [isEdit]="true"></app-cerrararticulo>
    </div>
    <div class="modal-footer modern-modal-footer">
        <button type="button" class="btn-modal-secondary" (click)="modal.close('Cross click')">
            <i class="pi pi-times me-2"></i>Cancelar
        </button>
        <button type="button" class="btn-modal-primary" (click)="modal.close('cerrar')">
            <i class="pi pi-check me-2"></i>Guardar
        </button>
    </div>
</ng-template>

<!-- Modal Notas -->
<ng-template #notasModal let-modal>
    <div class="modal-header modern-modal-header">
        <h4 class="modal-title">
            <i class="pi pi-file-edit me-2"></i>
            <span>Notas del Pedido</span>
        </h4>
        <button type="button" class="close modern-close-btn" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <i class="pi pi-times"></i>
        </button>
    </div>
    <div class="modal-body">
        <app-notas #notaspedidos [pedido]="pedidoSeleccionado" [isEdit]="true"></app-notas>
    </div>
</ng-template>

<!-- Modal Cambio Estado Pago -->
<ng-template #cambioEstadoPagoModal let-modal>
    <div class="modal-header modern-modal-header">
        <h4 class="modal-title">
            <i class="pi pi-credit-card me-2"></i>
            <span>Cambiar estado de pago</span>
        </h4>
        <button type="button" class="close modern-close-btn" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <i class="pi pi-times"></i>
        </button>
    </div>
    <div class="modal-body">
        <div class="estado-pago-content">
            <p class="mb-3">Estás a punto de cambiar el estado de pago. Por favor, selecciona el nuevo estado:</p>
            <div class="estado-select-container">
                <select class="form-control modern-select" [(ngModel)]="pedidoSeleccionado.estadoPago">
            <option *ngFor="let estado of estadosPago" [value]="estado">{{estado}}</option>
        </select>
                <i class="pi pi-chevron-down select-icon"></i>
            </div>
        </div>
    </div>
    <div class="modal-footer modern-modal-footer">
        <button type="button" class="btn-modal-secondary" (click)="modal.dismiss('cancel')">
            <i class="pi pi-times me-2"></i>Cancelar
        </button>
        <button type="button" class="btn-modal-primary" (click)="cambiarEstadoPago(pedidoSeleccionado)">
            <i class="pi pi-check me-2"></i>Confirmar
        </button>
    </div>
</ng-template>

<!-- Modal Procesos Seleccionados -->
<ng-template #processSelecteModal let-modal>
    <div class="modal-header modern-modal-header bg-primary text-white">
        <h4 class="modal-title">
            <i class="pi pi-sitemap me-2"></i>
            <span>Procesos de Fabricación</span>
        </h4>
        <button type="button" class="close modern-close-btn" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <i class="pi pi-times"></i>
        </button>
    </div>
    <div class="modal-body">
        <div class="proceso-selection-container">
            <div class="proceso-info mb-4">
                <div class="proceso-info-header">
                    <i class="pi pi-box me-2"></i>
                    <h5 class="mb-0">{{selectedOrdersEnsamble[0]?.nombreProducto}}</h5>
                </div>
                <div class="proceso-info-subtitle">
                    <i class="pi pi-tag me-2"></i>
                    <span>{{selectedOrdersEnsamble[0]?.nombreArticulo}}</span>
                </div>
            </div>
            
            <div class="procesos-list-container">
                <h6 class="procesos-list-title">Seleccione un proceso para continuar:</h6>
                <div class="procesos-list">
                    <div *ngFor="let proceso of filterProcess" 
                        class="proceso-item" 
                        [ngClass]="{'proceso-disabled': !proceso.statusJararquiaProcess, 
                                   'proceso-selected': selectedProcesos === proceso.label}" 
                        (click)="selectProcess(proceso)">
                        <div class="proceso-icon" [ngClass]="{
                            'icon-complete': proceso.status === 'TOTALMENTE', 
                            'icon-partial': proceso.status === 'PARCIALMENTE',
                            'icon-pending': proceso.status === 'SIN PRODUCIR'
                        }">
                            <i [class]="'pi ' + proceso.icon"></i>
                        </div>
                        <div class="proceso-content">
                            <span class="proceso-name">{{proceso.label}}</span>
                            <span class="proceso-status">{{proceso.status}}</span>
                        </div>
                        <div class="proceso-action">
                            <i class="pi pi-chevron-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer modern-modal-footer">
        <button type="button" class="btn-modal-secondary" (click)="modal.dismiss('cancel')">
            <i class="pi pi-times me-2"></i>Cancelar
        </button>
        <button type="button" class="btn-modal-primary" [disabled]="!selectedProcesos" (click)="cerrarArticuloEnsamble(cerrarArticuloModal, {label: selectedProcesos})">
            <i class="pi pi-arrow-right me-2"></i>Continuar
        </button>
    </div>
</ng-template>

<!-- Modal Cerrar Producto -->
<ng-template #cerrarProductoModal let-modal>
    <div class="modal-header modern-modal-header bg-success text-white">
        <h4 class="modal-title">
            <i class="pi pi-box me-2"></i>
            <span>Cerrar productos para el macro {{procesoGlobal}}</span>
        </h4>
        <button type="button" class="close modern-close-btn" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <i class="pi pi-times"></i>
        </button>
    </div>
    <div class="modal-body">
        <app-produccion-cerrarproducto [productsToClose]="productsToClose"></app-produccion-cerrarproducto>
    </div>
</ng-template>

<!-- Modal Tracking -->
<ng-template #trackinModal let-modal>
    <div class="modal-header modern-modal-header bg-gradient-primary text-white">
        <h4 class="modal-title d-flex align-items-center">
            <i class="pi pi-history me-2"></i>
            <span>Seguimiento de Fabricación</span>
        </h4>
        <button type="button" class="close modern-close-btn" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <i class="pi pi-times"></i>
        </button>
    </div>
    <div class="modal-subheader p-3 bg-light border-bottom">
        <div class="tracking-header-container">
            <div class="tracking-product-section">
                <div class="product-info-item">
                    <i class="pi pi-box text-primary me-2"></i>
                    <span class="info-label text-dark">Artículo:</span>
                    <span class="info-value text-dark">{{articuloEnsambleSelected?.nombreArticulo}}</span>
                </div>
                <div class="product-info-item">
                    <i class="pi pi-tag text-secondary me-2"></i>
                    <span class="info-label text-dark">Producto:</span>
                    <span class="info-value text-dark">{{articuloEnsambleSelected?.nombreProducto}}</span>
                </div>
            </div>
            <div class="tracking-meta-section">
                <div class="meta-info-item">
                    <i class="pi pi-calendar text-success me-2"></i>
                    <span class="info-label text-dark">Entrega:</span>
                    <span class="info-value badge bg-light text-dark">{{articuloEnsambleSelected?.fechaEntrega}}</span>
                </div>
                <div class="meta-info-item">
                    <i class="pi pi-hashtag text-info me-2"></i>
                    <span class="info-label text-dark">Cantidad:</span>
                    <span class="info-value badge bg-primary">{{articuloEnsambleSelected?.cantidadTotalProducto}}</span>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-body tracking-modal-body">
        <app-tracking [articuloEnsamble]="articuloEnsambleSelected"></app-tracking>
    </div>
    <div class="modal-footer tracking-modal-footer d-flex justify-content-between align-items-center">
        <div class="tracking-legend">
            <div class="legend-item">
                <span class="status-indicator status-complete"></span>
                <span class="legend-text">Completado</span>
            </div>
            <div class="legend-item">
                <span class="status-indicator status-partial"></span>
                <span class="legend-text">En proceso</span>
            </div>
            <div class="legend-item">
                <span class="status-indicator status-pending"></span>
                <span class="legend-text">Pendiente</span>
            </div>
        </div>
        <button type="button" class="btn-modal-secondary" (click)="modal.close('cerrar')">
            <i class="pi pi-times me-2"></i>
            <span>Cerrar</span>
        </button>
    </div>
</ng-template>
<!--Fin Modales-->

<style>
/* Variables globales */
:root {
    --primary-color: #6366f1;
    --primary-light: rgba(99, 102, 241, 0.1);
    --primary-lightest: rgba(99, 102, 241, 0.05);
    --secondary-color: #3b82f6;
    --secondary-light: rgba(59, 130, 246, 0.1);
    --secondary-dark: #1e40af;
    --text-dark: #374151;
    --text-medium: #6b7280;
    --text-light: #9ca3af;
    --border-color: #e5e7eb;
    --border-hover: #d1d5db;
    --surface-0: #ffffff;
    --surface-50: #f9fafb;
    --surface-100: #f3f4f6;
    --surface-200: #e5e7eb;
    --accent-purple: #8b5cf6;
    --accent-blue: #3b82f6;
    --accent-cyan: #06b6d4;
    --accent-green: #10b981;
    --accent-orange: #f59e0b;
    --error-color: #ef4444;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --transition-fast: 0.15s ease;
    --transition-normal: 0.25s ease;
    --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

/* Selector de columnas */
.column-selector-container {
    display: flex;
    align-items: center;
    background-color: var(--surface-50);
    border-radius: var(--radius-md);
    padding: 0.5rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    transition: all var(--transition-normal);
}

.column-selector-container:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--border-hover);
}

.modern-multiselect {
    border: none !important;
    box-shadow: none !important;
}

.modern-multiselect .p-multiselect-label {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
    color: var(--text-medium);
}

.modern-multiselect .p-multiselect-trigger {
    width: 2rem;
    color: var(--text-medium);
}

.column-option-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0;
}

.option-icon {
    color: var(--primary-color);
    font-size: 1rem;
}

.option-title {
    font-weight: 500;
    color: var(--text-dark);
    font-size: 0.875rem;
}

.option-description {
    color: var(--text-light);
    font-size: 0.75rem;
    margin-top: 0.125rem;
}

.selected-columns-chip {
    background-color: var(--primary-light);
    color: var(--primary-color);
    border-radius: var(--radius-md);
    padding: 0.25rem 0.75rem;
    font-size: 0.8125rem;
    font-weight: 500;
    display: flex;
    align-items: center;
}

.reset-columns-btn {
    width: 2rem !important;
    height: 2rem !important;
    margin-left: 0.5rem;
    background-color: var(--surface-50) !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-medium) !important;
    border-radius: var(--radius-md) !important;
    transition: all var(--transition-normal);
}

.reset-columns-btn:hover {
    background-color: var(--primary-lightest) !important;
    color: var(--primary-color) !important;
    border-color: var(--primary-color) !important;
    transform: translateY(-1px);
}

/* Contenedor de tabla */
.production-table-container {
    background-color: var(--surface-0);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    transition: all var(--transition-normal);
}

.production-table-container:hover {
    box-shadow: var(--shadow-lg);
}

/* Tabla moderna */
.modern-production-table {
    font-family: var(--font-sans);
}

.modern-production-table .p-datatable-header {
    background-color: var(--surface-0);
    border: none;
    padding: 1rem;
}

/* Encabezados */
.modern-production-table .p-datatable-thead > tr > th {
    background-color: var(--surface-50);
    color: var(--text-medium);
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border: none;
    padding: 0.75rem 1rem;
    transition: all var(--transition-normal);
}

.modern-production-table .p-datatable-thead > tr > th:first-child {
    border-top-left-radius: var(--radius-md);
}

.modern-production-table .p-datatable-thead > tr > th:last-child {
    border-top-right-radius: var(--radius-md);
}

.header-cell {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.header-cell i {
    color: var(--primary-color);
    opacity: 0.8;
    font-size: 0.875rem;
}

/* Celdas y filas */
.modern-production-table .p-datatable-tbody > tr > td {
    border: none;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    color: var(--text-dark);
    vertical-align: middle;
    background-color: transparent;
    transition: all var(--transition-normal);
}

.product-row {
    border-bottom: 1px solid var(--border-color);
    transition: all var(--transition-normal);
}

.product-row:hover {
    background-color: var(--primary-lightest) !important;
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
}

.product-row:last-child {
    border-bottom: none;
}

/* Columna de acciones */
.action-column {
    width: 3rem;
    text-align: center;
    padding: 0.5rem !important;
}

.process-menu-btn {
    width: 2rem !important;
    height: 2rem !important;
    background-color: transparent !important;
    border: none !important;
    color: var(--text-medium) !important;
    border-radius: 50% !important;
    transition: all var(--transition-normal);
}

.process-menu-btn:hover {
    background-color: var(--primary-light) !important;
    color: var(--primary-color) !important;
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
}

/* Botón de proceso */
.process-action-btn {
    width: 2.25rem !important;
    height: 2.25rem !important;
    background: linear-gradient(135deg, var(--accent-blue), var(--secondary-color)) !important;
    border: none !important;
    color: white !important;
    border-radius: 50% !important;
    transition: all var(--transition-normal);
    box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
}

.process-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
}

.process-action-btn .pi-cog {
    font-size: 1rem;
}

/* Valores numéricos */
.quantity-value {
    font-family: 'Inter', monospace;
    font-weight: 600;
    font-size: 0.9375rem;
    color: var(--secondary-color);
    background-color: var(--secondary-light);
    border-radius: var(--radius-md);
    padding: 0.25rem 0.5rem;
    display: inline-block;
    min-width: 2.5rem;
    text-align: center;
}

/* Mejoras para los contenedores de nombres */
.article-name-container, .product-name-container {
    padding: 0.75rem 0.5rem;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    min-width: 200px;
    max-width: 350px;
    transition: all 0.2s ease;
    overflow: visible;
    position: relative;
}

.article-name-container:hover, .product-name-container:hover {
    background-color: var(--surface-50);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    z-index: 10;
}

/* Estilos específicos para los nombres */
.article-name, .product-name {
    font-size: 0.9rem;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.article-name {
    font-weight: 600;
    color: var(--text-dark);
}

.product-name {
    font-weight: 500;
    font-size: 0.85rem;
    color: var(--text-medium);
}

/* Ajuste de columnas en la tabla */
.modern-production-table th[data-field="nombreArticulo"],
.modern-production-table th[data-field="nombreProducto"] {
    min-width: 250px !important;
    max-width: 350px !important;
}

/* Estilos para el modo de densidad */
.modern-production-table.density-compact .article-name,
.modern-production-table.density-compact .product-name {
    -webkit-line-clamp: 1;
}

.modern-production-table.density-expanded .article-name,
.modern-production-table.density-expanded .product-name {
    -webkit-line-clamp: 3;
}

/* Estilos para tooltips más grandes */
:host ::ng-deep .p-tooltip {
    max-width: 300px;
    white-space: pre-wrap;
}

/* Fechas y horas */
.date-cell, .time-cell {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.8125rem;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-md);
    max-width: 300px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.date-cell {
    background-color: rgba(59, 130, 246, 0.08);
    color: var(--accent-blue);
}

.time-cell {
    background-color: rgba(139, 92, 246, 0.08);
    color: var(--accent-purple);
}

.date-icon, .time-icon {
    font-size: 0.75rem;
}

/* Estado vacío */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 1rem;
    text-align: center;
}

.empty-icon-container {
    width: 4rem;
    height: 4rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--accent-blue), var(--secondary-color));
    border-radius: 50%;
    margin-bottom: 1rem;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
}

.empty-icon-container i {
    font-size: 1.75rem;
    color: white;
}

.empty-state h5 {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
    font-size: 1.125rem;
}

.empty-state p {
    color: var(--text-medium);
    max-width: 300px;
    margin: 0 auto;
    font-size: 0.875rem;
}

/* Paginador */
.modern-production-table .p-paginator {
    background-color: var(--surface-50);
    border: none;
    padding: 0.5rem;
    border-radius: 0 0 var(--radius-md) var(--radius-md);
}

.modern-production-table .p-paginator .p-paginator-pages .p-paginator-page {
    min-width: 2.25rem;
    height: 2.25rem;
    margin: 0 0.125rem;
    border-radius: var(--radius-md);
    transition: all var(--transition-normal);
}

.modern-production-table .p-paginator .p-paginator-pages .p-paginator-page.p-highlight {
    background: linear-gradient(135deg, var(--accent-blue), var(--secondary-color));
    color: white;
    font-weight: 600;
    box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
}

.modern-production-table .p-paginator button {
    width: 2.25rem;
    height: 2.25rem;
    border-radius: var(--radius-md);
}

.modern-production-table .p-paginator button:not(.p-highlight):hover {
    background-color: var(--primary-light);
    color: var(--primary-color);
}

/* Estilos para el control de densidad */
.density-control-container {
    display: flex;
    align-items: center;
    background-color: var(--surface-50);
    border-radius: var(--radius-md);
    padding: 0.5rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.density-label {
    font-size: 0.8125rem;
    color: var(--text-medium);
    font-weight: 500;
}

.density-control-container .btn-group {
    border-radius: var(--radius-sm);
    overflow: hidden;
}

.density-control-container .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.2rem;
    height: 2.2rem;
    padding: 0;
    border-radius: 0;
}

.density-control-container .btn i {
    font-size: 0.875rem;
}

.density-control-container .btn.btn-primary {
    background: linear-gradient(135deg, var(--accent-blue), var(--secondary-color));
    border-color: var(--secondary-color);
}

.density-control-container .p-button-outlined {
    border-color: var(--border-color);
    color: var(--text-medium);
    transition: all var(--transition-normal);
}

.density-control-container .p-button-outlined:hover {
    background-color: var(--primary-lightest);
    color: var(--primary-color);
    border-color: var(--primary-color);
    transform: translateY(-1px);
}
</style>