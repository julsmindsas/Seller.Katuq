<!-- <app-breadcrumb [title]="'Asistencia'" [items]="['IA']" [active_item]="'Asistencia'"></app-breadcrumb> -->
<div class="modern-chat-container" [ngClass]="{'floating-mode': isFloating}">
  <div class="chat-card">
    <header class="chat-header">
      <div class="chat-header-content">
        <!-- <img src="assets/images/kai-avatar.png" alt="KAI" class="chat-logo" onerror="this.src='assets/images/default-avatar.png'"> -->
        <h4>{{ 'KAI - Tu asistente personal' | translate }}</h4>
        <p class="subtitle" *ngIf="!isFloating">{{ 'Consulta y obtén respuestas rápidas para mejorar tu desempeño' | translate }}</p>
      </div>
    </header>

    <div class="messages-container chat-history" #chatHistoryContainer role="log" aria-live="polite" (scroll)="onChatScroll()">
      <div class="chat-messages-wrapper">
        <!-- Mensaje de bienvenida inicial -->
        <ng-container *ngIf="!chats?.message?.length">
          <div class="welcome-message">
            <!-- <img src="assets/images/kai-avatar.png" alt="KAI" class="ai-avatar" onerror="this.src='assets/images/default-avatar.png'"> -->
            <div class="welcome-text">
              <h3>{{ '¡Hola! Soy KAI, tu asistente personal.' | translate }}</h3>
              <p>{{ '¿En qué puedo ayudarte hoy? Puedes preguntarme sobre cualquier tema relacionado con tu trabajo.' | translate }}</p>
            </div>
          </div>
        </ng-container>

        <!-- Mensajes del chat -->
        <ng-container *ngFor="let chat of chats?.message">
          <div class="message-row" [ngClass]="{'user-message': chat.sender === profile.id, 'assistant-message': chat.sender !== profile.id}">
            <!-- <img *ngIf="chat.sender !== profile.id" [src]="chatUser?.profile" alt="KAI" class="ai-avatar" onerror="this.src='assets/images/default-avatar.png'"> -->
            <div class="message-content">
              <!-- Mensaje del usuario -->
              <ng-container *ngIf="chat.sender === profile.id">
                <p>{{ chat.text }}</p>
              </ng-container>
              <!-- Mensaje del asistente con parpadeo de palabras -->
              <ng-container *ngIf="chat.sender !== profile.id">
                <div class="blinking-words">
                  <ng-container *ngFor="let word of chat.text.split(' '); let idx = index">
                    <span class="blink-word" [style.animationDelay]="(idx * 0.1) + 's'">{{ word }}</span><span>&nbsp;</span>
                  </ng-container>
                </div>
              </ng-container>
              <!-- Imagen en la respuesta, si existe -->
              <div *ngIf="chat.image" class="image-content">
                <img [src]="chat.image" alt="Imagen de respuesta" class="response-image" onerror="this.src='assets/images/default-avatar.png'">
              </div>
              <time class="message-timestamp">{{ chat.time }}</time>
            </div>
          </div>
        </ng-container>

        <!-- Indicador de escritura -->
        <div *ngIf="chatUser?.typing" class="message-row assistant-message typing-indicator">
          <div class="avatar-container">
            <!-- <img [src]="chatUser?.profile" alt="KAI" class="ai-avatar" onerror="this.src='assets/images/default-avatar.png'"> -->
          </div>
          <div class="typing-animation">
            <span></span><span></span><span></span>
          </div>
          <div class="typing-text">{{ 'Procesando...' | translate }}</div>
        </div>
      </div>
    </div>

    <footer class="chat-input-area">
      <form #chatForm="ngForm" (ngSubmit)="sendMessage(chatForm)" class="input-form">
        <textarea
          class="message-input"
          [class.error]="error"
          placeholder="{{ 'Escribe un mensaje...' | translate }}"
          [(ngModel)]="chatText"
          name="message"
          rows="1"
          (input)="autoResize($event)"
          (keydown.enter)="handleEnter($event, chatForm)"
          aria-label="Mensaje"></textarea>
        <button type="submit" class="send-button" [disabled]="!chatText?.trim()" aria-label="Enviar mensaje">
          <i class="fas fa-paper-plane"></i>
        </button>
        <button type="button" class="emoji-button" (click)="toggleEmojiPicker()" aria-label="Emoji picker">
          <img src="assets/images/smiley.png" alt="Emoji">
        </button>
        <div class="emoji-picker-container" *ngIf="showEmojiPicker">
          <emoji-mart (emojiClick)="addEmoji($event)" set="apple" useButton="true"></emoji-mart>
        </div>
      </form>
    </footer>
  </div>
</div>