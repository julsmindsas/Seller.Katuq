<div class="chat-container" [ngClass]="{'floating-mode': isFloating, 'dark-mode': isDarkMode}">
  <!-- Header del chat -->
  <div class="chat-header">
    <div class="header-content">
      <div class="avatar-container">
        <img src="assets/images/kai/kai.gif" alt="KAI" class="avatar-img" onerror="this.src='assets/images/default-avatar.png'">
      </div>
      <div class="header-info">
        <h4 class="assistant-name">KAI 
          <span class="status-indicator" [ngClass]="{'online': chatUser?.online, 'typing': chatUser?.typing}"></span>
        </h4>
        <p class="assistant-status">{{ chatUser?.typing ? 'Escribiendo...' : 'En línea' }}</p>
      </div>
    </div>
    
    <div class="header-actions">
      <button class="action-button toggle-theme" (click)="toggleDarkMode()" aria-label="Cambiar tema">
        <i class="fa" [ngClass]="isDarkMode ? 'fa-sun-o' : 'fa-moon-o'"></i>
      </button>
      <button *ngIf="isFloating" class="action-button close" aria-label="Cerrar chat">
        <i class="fa fa-times"></i>
      </button>
    </div>
  </div>

  <!-- Área de mensajes con scroll independiente -->
  <div class="messages-area" #chatHistoryContainer (scroll)="onChatScroll()">
    <!-- Mensaje de bienvenida -->
    <div class="welcome-message" *ngIf="!chats?.message?.length">
      <h3>¡Hola! Soy KAI, tu asistente personal.</h3>
      <p>¿En qué puedo ayudarte hoy? Puedes preguntarme sobre cualquier tema relacionado con tu trabajo.</p>
    </div>

    <!-- Mensajes del chat -->
    <ng-container *ngFor="let chat of chats?.message; let i = index">
      <!-- Mensajes del usuario -->
      <div class="message-row user-message" *ngIf="chat.sender === profile.id" [@messageAnimation]>
        <div class="message-bubble">
          <p class="message-text">{{ chat.text }}</p>
          <span class="message-time">{{ chat.time }}</span>
        </div>
      </div>

      <!-- Mensajes del asistente -->
      <div class="message-row assistant-message" *ngIf="chat.sender !== profile.id" [@messageAnimation]>
        <div class="avatar-container small">
          <img src="assets/images/kai/kai.gif" alt="KAI" class="avatar-img" onerror="this.src='assets/images/default-avatar.png'">
        </div>
        <div class="message-bubble">
          <!-- Texto con animación de escritura -->
          <div *ngIf="!isHtml(chat.text)" class="typing-animation">
            <ng-container *ngFor="let word of chat.text.split(' '); let idx = index">
              <span class="typing-word" [style.animation-delay]="(idx * 0.05) + 's'">{{ word }}</span><span>&nbsp;</span>
            </ng-container>
          </div>
          
          <!-- Contenido HTML formateado -->
          <div *ngIf="isHtml(chat.text)" class="formatted-content" [innerHTML]="sanitizeHtml(chat.text)"></div>

          <!-- Imagen si existe -->
          <img *ngIf="chat.image" [src]="chat.image" class="message-image" alt="Imagen de respuesta" onerror="this.src='assets/images/default-avatar.png'">
          
          <span class="message-time">{{ chat.time }}</span>
        </div>
      </div>
    </ng-container>

    <!-- Indicador de escritura - Removimos la animación fadeAnimation aquí -->
    <div class="message-row assistant-message typing-indicator" *ngIf="chatUser?.typing">
      <div class="avatar-container small">
        <img src="assets/images/kai/kai.gif" alt="KAI" class="avatar-img" onerror="this.src='assets/images/default-avatar.png'">
      </div>
      <div class="message-bubble typing">
        <div class="dots-container">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
        <span class="typing-text">Pensando...</span>
      </div>
    </div>
  </div>

  <!-- Área de input fija en la parte inferior -->
  <div class="input-area">
    <form #chatForm="ngForm" (ngSubmit)="sendMessage(chatForm)" class="input-form">
      <div class="input-wrapper">
        <textarea 
          class="message-input" 
          [class.error]="error" 
          placeholder="Escribe un mensaje..." 
          [(ngModel)]="chatText" 
          name="message" 
          rows="1" 
          (input)="autoResize($event)"
          (keydown.enter)="handleEnter($event, chatForm)" 
          aria-label="Mensaje">
        </textarea>

        <button type="button" class="emoji-button" (click)="toggleEmojiPicker()" aria-label="Emoji picker">
          <i class="fa fa-smile-o"></i>
        </button>
      </div>

      <button 
        type="submit" 
        class="send-button" 
        [disabled]="!chatText?.trim()" 
        [ngClass]="{'disabled': !chatText?.trim()}"
        aria-label="Enviar mensaje">
        <i class="fa fa-paper-plane"></i>
      </button>
    </form>

    <!-- Emoji picker - Removimos la animación fadeAnimation aquí -->
    <div class="emoji-picker-container" *ngIf="showEmojiPicker">
      <emoji-mart (emojiClick)="addEmoji($event)" set="apple" useButton="true"></emoji-mart>
    </div>
  </div>
</div>