<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-body pb-0">
                    <p-table #dt1 [value]="orders" dataKey="nroPedido" [rows]="50" [showCurrentPageReport]="true"
                        [rowsPerPageOptions]="[5,10,25,50]" [loading]="loading" [resizableColumns]="true"
                        [reorderableColumns]="true" [autoLayout]="true" [scrollable]="true"
                        [scrollHeight]="'calc(100vh - 400px)'" [paginator]="true"
                        currentPageReportTemplate="{{ 'Mostrando {first} a {last} de {totalRecords} pedidos' | translate }}"
                        [globalFilterFields]="['nroPedido','documento','validacion','formaDePago','estadoPago']"
                        styleClass="p-datatable-sm p-datatable-customers p-datatable-gridlines"
                        style="font-size: 0.9em;">

                        <!-- CAPTION: Botones y filtros generales -->
                        <ng-template pTemplate="caption">
                            <div class="d-flex flex-wrap justify-content-between align-items-center p-2">
                                <div class="d-flex align-items-center mb-md-0 mb-2">
                                    <span class="me-2 text-muted">{{ 'Columnas:' | translate }}</span>
                                    <p-multiSelect [options]="displayedColumns" 
                                        [(ngModel)]="selectedColumns" 
                                        optionLabel="header" 
                                        defaultLabel="{{ 'Seleccionar' | translate }}"
                                        selectedItemsLabel="{0} columnas"
                                        styleClass="me-2 p-multiselect-sm"
                                        [style]="{'min-width': '200px'}"
                                        (onChange)="onColumnSelectionChange()">
                                    </p-multiSelect>
                                    <button pButton pRipple type="button" icon="pi pi-refresh" 
                                        pTooltip="{{ 'Restaurar columnas' | translate }}"
                                        class="p-button-outlined p-button-sm p-button-secondary" 
                                        (click)="resetColumnConfig()">
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button pButton type="button" label="{{ 'Actualizar' | translate }}" icon="pi pi-refresh"
                                        class="p-button-sm p-button-outlined"
                                        (click)="onRefresh()"></button>
                                    <button pButton type="button" label="{{ 'Limpiar filtros' | translate }}" icon="pi pi-filter-slash"
                                        class="p-button-sm p-button-outlined p-button-secondary"
                                        (click)="onClear()"></button>
                                </div>
                            </div>
                        </ng-template>

                        <!-- HEADER: Encabezados y filtros -->
                        <ng-template pTemplate="header">
                            <tr class="p-table-tr-th" style="font-size: 0.85em; background-color: #f8f9fa;">
                                <!-- Recorremos todas las columnas -->
                                <ng-container *ngFor="let col of selectedColumns">
                                    <th *ngIf="isColumnVisible(col.field)">
                                        <div>
                                            {{ col.header | translate }}
                                            <!-- Si es una columna con filtro de texto -->
                                            <p-columnFilter *ngIf="['nroPedido', 'nroFactura', 'shippingOrder', 'cliente', 'ciudad', 'zonaCobro', 'formaEntrega', 'horarioEntrega', 'fechaHoraEmpacado', 'fechaYHorarioDespachado', 'empacador', 'transportador'].includes(col.field)" 
                                                type="text" 
                                                [field]="col.field"
                                                [placeholder]="col.header | translate" 
                                                matchMode="contains" 
                                                display="menu"
                                                [showMenu]="true">
                                            </p-columnFilter>
                                            
                                            <!-- Si es una columna con filtro de fecha -->
                                            <p-columnFilter *ngIf="['fechaCreacion', 'fechaEntrega'].includes(col.field)"
                                                [matchMode]="'customDate'" 
                                                [field]="col.field" 
                                                type="date"
                                                display="menu" 
                                                [showMatchModes]="false" 
                                                [showOperator]="false"
                                                [showAddButton]="false" 
                                                [showMenu]="true">
                                                <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                                                    <p-calendar (onSelect)="filter($event)" dateFormat="yy-mm-dd"></p-calendar>
                                                </ng-template>
                                            </p-columnFilter>
                                            
                                            <!-- Si es una columna con filtro de selección múltiple -->
                                            <p-columnFilter *ngIf="['estadoPago', 'estadoProceso'].includes(col.field)"
                                                [field]="col.field" 
                                                matchMode="in" 
                                                display="menu"
                                                [showMenu]="true">
                                                <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                                                    <p-multiSelect [ngModel]="value" 
                                                        [options]="col.field === 'estadoPago' ? estadosPago : estadosProcesos"
                                                        placeholder="{{ 'Seleccione' | translate }}" 
                                                        (onChange)="filter($event.value)"
                                                        style="width:100%; font-size:0.8em;">
                                                    </p-multiSelect>
                                                </ng-template>
                                            </p-columnFilter>
                                        </div>
                                    </th>
                                </ng-container>
                            </tr>
                        </ng-template>

                        <!-- CUERPO: filas y row expansion -->
                        <ng-template pTemplate="body" let-pedido let-expanded="expanded" let-rowIndex="rowIndex">
                            <tr class="p-table-tr-td" [ngClass]="{'table-row-odd': rowIndex % 2 !== 0}" style="font-size: 0.85em;">
                                <!-- Botón para row expansion (Detalles) -->
                                <td *ngIf="isColumnVisible('detalles')" style="width: 5rem;">
                                    <button type="button" pButton pRipple [pRowToggler]="pedido"
                                        class="p-button-text p-button-rounded p-button-plain"
                                        [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                                </td>
                                <!-- Opciones: Conserva los iconos según corresponda -->
                                <td *ngIf="isColumnVisible('opciones')">
                                    <div class="action-buttons-wrapper">
                                        <button pButton pRipple type="button" icon="pi pi-file-pdf" 
                                            class="p-button-rounded p-button-text p-button-sm" 
                                            pTooltip="{{ 'Imprimir Pdf' | translate }}"
                                            (click)="printPdf(pedido)"></button>
                                        
                                        <button pButton pRipple type="button" icon="pi pi-tag" 
                                            *ngIf="hasTags(pedido)"
                                            class="p-button-rounded p-button-text p-button-sm" 
                                            pTooltip="{{ 'Tarjeta' | translate }}"
                                            (click)="viewTags(pedido)"></button>
                                                
                                        <button pButton pRipple type="button" icon="pi pi-file" 
                                            class="p-button-rounded p-button-text p-button-sm" 
                                            pTooltip="{{ 'Rótulo' | translate }}"
                                            (click)="printLabel(pedido)"></button>
                                                
                                        <button pButton pRipple type="button" icon="pi pi-inbox" 
                                            *ngIf="pedido.estadoProceso != 'Empacado' && pedido.estadoProceso != 'Despachado' && pedido.estadoProceso != 'Entregado'"
                                            class="p-button-rounded p-button-text p-button-sm" 
                                            pTooltip="{{ 'Empacar' | translate }}"
                                            (click)="changeStatus(pedido,1)"></button>
                                                
                                        <button pButton pRipple type="button" icon="pi pi-box" 
                                            *ngIf="pedido.estadoProceso == 'Empacado' && pedido.estadoProceso != 'Despachado' && pedido.estadoProceso != 'Entregado'"
                                            class="p-button-rounded p-button-text p-button-sm" 
                                            pTooltip="{{ 'Desempacar' | translate }}"
                                            (click)="changeStatus(pedido,2)"></button>
                                                
                                        <button pButton pRipple type="button" icon="pi pi-send" 
                                            *ngIf="pedido.estadoProceso != 'Despachado' && pedido.estadoProceso != 'Entregado'"
                                            class="p-button-rounded p-button-text p-button-sm" 
                                            pTooltip="{{ 'Despachar' | translate }}"
                                            (click)="changeStatus(pedido,4)"></button>
                                                
                                        <button pButton pRipple type="button" icon="pi pi-check-circle" 
                                            *ngIf="pedido.estadoProceso == 'Despachado'"
                                            class="p-button-rounded p-button-text p-button-sm" 
                                            pTooltip="{{ 'Entregar' | translate }}"
                                            (click)="changeStatus(pedido,5)"></button>
                                    </div>
                                </td>
                                
                                <!-- Columnas dinámicas -->
                                <ng-container *ngFor="let col of selectedColumns">
                                    <ng-container *ngIf="col.field !== 'detalles' && col.field !== 'opciones' && isColumnVisible(col.field)">
                                        <!-- Estado de Pago -->
                                        <td *ngIf="col.field === 'estadoPago'">
                                            <span [ngClass]="{
                                                'badge bg-warning': pedido?.estadoPago === 'Pendiente' || pedido?.estadoPago === 'Pospendiente',
                                                'badge bg-success': pedido?.estadoPago === 'Aprobado' || pedido?.estadoPago === 'PreAprobado',
                                                'badge bg-danger': pedido?.estadoPago === 'Rechazado' || pedido?.estadoPago === 'Cancelado' || pedido?.estadoPago === 'Precancelado'
                                            }">{{ pedido?.estadoPago }}</span>
                                        </td>
                                        
                                        <!-- Estado de Proceso -->
                                        <td *ngIf="col.field === 'estadoProceso'">
                                            <span [ngClass]="{
                                                'badge bg-secondary': pedido?.estadoProceso === 'SinProducir',
                                                'badge bg-info': pedido?.estadoProceso === 'Producido' || pedido?.estadoProceso === 'ProducidoTotalmente' || pedido?.estadoProceso === 'ProducidoParcialmente',
                                                'badge bg-primary': pedido?.estadoProceso === 'Empacado',
                                                'badge bg-warning': pedido?.estadoProceso === 'Despachado' || pedido?.estadoProceso === 'ParaDespachar',
                                                'badge bg-success': pedido?.estadoProceso === 'Entregado',
                                                'badge bg-danger': pedido?.estadoProceso === 'Rechazado'
                                            }">{{ pedido?.estadoProceso }}</span>
                                        </td>
                                        
                                        <!-- Cliente con notas -->
                                        <td *ngIf="col.field === 'cliente'" class="text-nowrap">
                                            <div class="d-flex align-items-center">
                                                <span>{{ pedido.cliente?.nombres_completos }} {{ pedido.cliente?.apellidos_completos }}</span>
                                                <button pButton pRipple type="button" icon="pi pi-info-circle" 
                                                    class="p-button-rounded p-button-text p-button-sm ms-1" 
                                                    pTooltip="{{ 'Ver notas del cliente' | translate }}"
                                                    (click)="viewNotes(pedido)"></button>
                                            </div>
                                        </td>
                                        
                                        <!-- Valores monetarios -->
                                        <td *ngIf="col.field === 'totalEnvio'" class="text-end text-nowrap">{{ pedido.totalEnvio | currency }}</td>
                                        <td *ngIf="col.field === 'faltaPorPagar'" class="text-end text-nowrap">{{ pedido?.faltaPorPagar | currency }}</td>
                                        
                                        <!-- Fechas -->
                                        <td *ngIf="col.field === 'fechaCreacion'" class="text-nowrap">{{ pedido.fechaCreacion | date: 'dd/MM/yyyy' }}</td>
                                        <td *ngIf="col.field === 'fechaHoraEmpacado'" class="text-nowrap">{{ pedido.fechaHoraEmpacado | date: 'dd-MM-yyyy HH:mm' }}</td>
                                        <td *ngIf="col.field === 'fechaYHorarioDespachado'" class="text-nowrap">{{ pedido.fechaYHorarioDespachado | date: 'dd-MM-yyyy HH:mm' }}</td>
                                        
                                        <!-- Fechas de configuración -->
                                        <td *ngIf="col.field === 'fechaEntrega'" class="text-nowrap">
                                            {{ convertFechaEntregaString(pedido.carrito?.[0]?.configuracion?.datosEntrega?.fechaEntrega) }}
                                        </td>
                                        <td *ngIf="col.field === 'formaEntrega'" class="text-nowrap">{{ pedido.carrito?.[0]?.configuracion?.datosEntrega?.formaEntrega }}</td>
                                        <td *ngIf="col.field === 'horarioEntrega'" class="text-nowrap">{{ pedido.carrito?.[0]?.configuracion?.datosEntrega?.horarioEntrega }}</td>
                                        
                                        <!-- Datos básicos -->
                                        <td *ngIf="col.field === 'nroPedido'" class="text-nowrap">{{ pedido.nroPedido }}</td>
                                        <td *ngIf="col.field === 'nroFactura'" class="text-nowrap">{{ pedido?.nroFactura }}</td>
                                        <td *ngIf="col.field === 'shippingOrder'" class="text-nowrap">{{ pedido?.shippingOrder }}</td>
                                        <td *ngIf="col.field === 'ciudad'" class="text-nowrap">{{ pedido.envio?.ciudad }}</td>
                                        <td *ngIf="col.field === 'zonaCobro'" class="text-nowrap">{{ pedido.envio?.zonaCobro }}</td>
                                        <td *ngIf="col.field === 'asesorAsignado'" class="text-nowrap">{{ pedido.asesorAsignado?.name }}</td>
                                        <td *ngIf="col.field === 'empacador'" class="text-nowrap">{{ pedido.empacador }}</td>
                                        <td *ngIf="col.field === 'despachador'" class="text-nowrap">{{ pedido.despachador?.name }}</td>
                                        <td *ngIf="col.field === 'transportador'" class="text-nowrap">{{ pedido.transportador }}</td>
                                        
                                        <!-- Observaciones detalladas -->
                                        <td *ngIf="col.field === 'observaciones'">
                                            <div class="pedido-envio" style="font-size: 0.8em;">
                                                <ng-container
                                                    *ngIf="pedido?.envio?.nombres && pedido?.envio?.apellidos && pedido.envio.celular && pedido.envio.direccionEntrega && pedido.envio.observaciones">
                                                    <div class="card p-2 mb-0">
                                                        <div class="row g-1">
                                                            <div class="col-12">
                                                                <strong>{{ 'Nombre:' | translate }}</strong>
                                                                {{ pedido?.envio?.nombres }} {{ pedido.envio.apellidos }}
                                                            </div>
                                                            <div class="col-12">
                                                                <strong>{{ 'Teléfono:' | translate }}</strong>
                                                                {{ pedido.envio.celular }}
                                                            </div>
                                                            <div class="col-12">
                                                                <strong>{{ 'WhatsApp:' | translate }}</strong>
                                                                {{ pedido.envio.celular }}
                                                            </div>
                                                            <div class="col-12">
                                                                <strong>{{ 'Dirección:' | translate }}</strong>
                                                                {{ pedido.envio.direccionEntrega }}
                                                            </div>
                                                            <div class="col-12">
                                                                <strong>{{ 'Observaciones:' | translate }}</strong>
                                                                {{ pedido.envio.observaciones }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </ng-container>
                                                <ng-container
                                                    *ngIf="!pedido?.envio?.nombres || !pedido.envio.apellidos || !pedido.envio.celular || !pedido.envio.direccionEntrega || !pedido.envio.observaciones">
                                                    <strong>{{ 'No hay observaciones' | translate }}</strong>
                                                </ng-container>
                                            </div>
                                        </td>
                                        
                                        <!-- Entregado (botón de detalles) -->
                                        <td *ngIf="col.field === 'entregado'">
                                            <button pButton type="button" label="{{ 'Ver detalles de Entrega' | translate }}"
                                                class="p-button-outlined p-button-sm"
                                                (click)="viewDetails(pedido)">
                                            </button>
                                        </td>
                                    </ng-container>
                                </ng-container>
                            </tr>
                        </ng-template>

                        <!-- EXPANSIÓN DE FILAS: Productos del carrito -->
                        <ng-template pTemplate="rowexpansion" let-pedido>
                            <tr style="font-size: 0.85em;">
                                <td [attr.colspan]="selectedColumns.length">
                                    <div class="p-3">
                                        <p-table [value]="pedido.carrito" dataKey="id" styleClass="p-datatable-sm">
                                            <ng-template pTemplate="header">
                                                <tr>
                                                    <th>{{ 'Imagen' | translate }}</th>
                                                    <th>{{ 'Producto' | translate }}</th>
                                                    <th>{{ 'Cantidad' | translate }}</th>
                                                </tr>
                                            </ng-template>
                                            <ng-template pTemplate="body" let-item>
                                                <tr>
                                                    <td style="width: 50px">
                                                        <img style="width: 40px; height: 40px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px;"
                                                            [src]="item.producto?.crearProducto?.imagenesPrincipales?.[0]?.urls"
                                                            [alt]="item.producto?.crearProducto?.imagenesPrincipales?.[0]?.nombreImagen" />
                                                    </td>
                                                    <td>{{ item.producto?.crearProducto?.titulo }}</td>
                                                    <td>{{ item.cantidad }}</td>
                                                </tr>
                                            </ng-template>
                                            <ng-template pTemplate="emptymessage">
                                                <tr>
                                                    <td colspan="3">{{ 'No hay productos en el carrito para este pedido.' | translate }}</td>
                                                </tr>
                                            </ng-template>
                                        </p-table>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>

                        <!-- MENSAJE SI LA TABLA ESTÁ VACÍA -->
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td [attr.colspan]="selectedColumns.length">{{ 'Productos no encontrados.' | translate }}</td>
                            </tr>
                        </ng-template>

                        <!-- FOOTER: Totales (adaptar el colspan en función del número de columnas visibles) -->
                        <ng-template pTemplate="footer">
                            <tr style="font-size: 0.85em;" *ngIf="getVisibleColumnsCount() > 0">
                                <td [attr.colspan]="getVisibleColumnsCount()" class="text-end">
                                    <strong>{{ 'Total Envío:' | translate }}</strong> {{ calculateTotalEnvio(orders) | currency }} | 
                                    <strong>{{ 'Falta Por Pagar:' | translate }}</strong> {{ calculateFaltaPorPagar(orders) | currency }}
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>
        </div>
    </div>
</div> 