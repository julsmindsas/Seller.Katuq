<app-breadcrumb [title]="'Despachos' | translate" [items]="['Despachos' | translate]"
    [active_item]="'Despachos' | translate" class="mb-3"></app-breadcrumb>

<!-- Sección principal -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12">
            <!-- Card principal -->
            <div class="card shadow-sm border-0 mb-4">
                <!-- Loader -->
                <div class="loader-box" *ngIf="loading">
                    <div class="loader-8"></div>
                </div>

                <!-- Header del módulo -->
                <div
                    class="module-header px-4 py-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1 fw-bold text-primary"><i class="pi pi-truck me-2"></i>{{ 'Gestión de Despachos'
                            | translate }}</h5>
                        <p class="text-muted small mb-0">{{ 'Administra pedidos y órdenes de envío' | translate }}</p>
                    </div>

                    <!-- Botones de KAI y alertas -->
                    <div class="btn-group">
                        <button pButton type="button" icon="pi pi-brain" label="{{ 'Recomendaciones KAI' | translate }}"
                            class="p-button-info p-button-sm" (click)="mostrarRecomendacionesOptimizacion()"></button>
                        <button pButton type="button" icon="pi pi-refresh" 
                            pTooltip="{{ 'Reiniciar alertas de prioridad' | translate }}"
                            class="p-button-secondary p-button-sm" (click)="reiniciarControlAlertas()"></button>
                    </div>
                </div>

                <!-- Alertas de priorización -->
                <div class="px-4 py-3 bg-light border-bottom"
                    *ngIf="!loading && (obtenerConteoPedidosUrgentesNoDespachados() > 0 || obtenerConteoPedidosEnRiesgoNoDespachados() > 0 || obtenerConteoPedidosSinProducirUrgentes() > 0)">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="alert alert-warning mb-2" *ngIf="obtenerConteoPedidosUrgentesNoDespachados() > 0">
                                <div class="d-flex align-items-center">
                                    <i class="pi pi-exclamation-triangle fs-4 me-3"></i>
                                    <div>
                                        <h6 class="mb-1 fw-bold">{{ 'Pedidos Urgentes' | translate }}</h6>
                                        <p class="mb-0">
                                            {{ 'Hay' | translate }} <strong>{{ obtenerConteoPedidosUrgentesNoDespachados()
                                                }}</strong> {{ 'pedidos que requieren atención inmediata' | translate }}
                                            <span *ngIf="obtenerPrimerPedidoUrgenteNoDespachado()">
                                                ({{ 'Más urgente' | translate }}: #{{
                                                obtenerPrimerPedidoUrgenteNoDespachado().nroPedido }} - {{
                                                obtenerPrimerPedidoUrgenteNoDespachado().diasRestantes }} {{ 'día(s)
                                                restante(s)' | translate }})
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info mb-2" *ngIf="obtenerConteoPedidosSinProducirUrgentes() > 0">
                                <div class="d-flex align-items-center">
                                    <i class="pi pi-exclamation-circle fs-4 me-3"></i>
                                    <div>
                                        <h6 class="mb-1 fw-bold">{{ 'Pedidos Urgentes Sin Producir' | translate }}</h6>
                                        <p class="mb-0">
                                            {{ 'Hay' | translate }} <strong>{{ obtenerConteoPedidosSinProducirUrgentes()
                                                }}</strong> {{ 'pedidos sin iniciar producción con fecha de entrega cercana' | translate }}
                                            <span class="text-danger ms-2">
                                                <i class="pi pi-arrow-right"></i> {{ 'Requieren prioridad de producción' | translate }}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info mb-0" *ngIf="obtenerConteoPedidosEnRiesgoNoDespachados() > 0">
                                <div class="d-flex align-items-center">
                                    <i class="pi pi-clock fs-4 me-3"></i>
                                    <div>
                                        <h6 class="mb-1 fw-bold">{{ 'Pedidos en Riesgo' | translate }}</h6>
                                        <p class="mb-0">
                                            {{ 'Hay' | translate }} <strong>{{ obtenerConteoPedidosEnRiesgoNoDespachados()
                                                }}</strong> {{ 'pedidos que podrían retrasarse' | translate }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botón para ver detalles de alertas -->
                        <div class="ms-3">
                            <button pButton type="button" icon="pi pi-info-circle" 
                                label="{{ 'Ver Detalles' | translate }}"
                                class="p-button-outlined p-button-sm p-button-warning"
                                pTooltip="{{ 'Ver resumen detallado de todas las alertas' | translate }}"
                                (click)="mostrarResumenAlertas()"></button>
                        </div>
                    </div>
                </div>

                <!-- Filtros de búsqueda -->
                <div class="card-body p-0">
                    <div class="filtros-container bg-light p-3 border-bottom">
                        <div class="d-flex flex-column">
                            <!-- Encabezado de filtros -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0 text-muted">
                                    <i class="pi pi-filter text-primary me-2"></i>
                                    <span>{{ 'Filtros de búsqueda' | translate }}</span>
                                </h6>
                                <div class="btn-group">
                                    <button pButton type="button" icon="pi pi-truck"
                                        label="{{ 'Transportadores' | translate }}"
                                        class="p-button-outlined p-button-sm p-button-secondary"
                                        (click)="openModal(transportadoresModal)"></button>
                                    <button pButton type="button" icon="pi pi-send"
                                        label="{{ 'Generar Orden' | translate }}"
                                        class="p-button-outlined p-button-sm p-button-secondary"
                                        (click)="openModal(generarOrdenEnvioModal)"></button>
                                    <button pButton type="button" icon="pi pi-list" label="{{ 'Órdenes' | translate }}"
                                        class="p-button-outlined p-button-sm p-button-secondary"
                                        (click)="viewAllDispatchOrders()"></button>
                                    <button pButton type="button" icon="pi pi-calculator" 
                                        label="{{ 'Análisis de Transportadores' | translate }}"
                                        class="p-button-outlined p-button-sm p-button-info"
                                        (click)="mostrarRecomendacionTransportadores()"></button>
                                </div>
                            </div>

                            <!-- Filtros de fecha -->
                            <div class="row g-3 align-items-end">
                                <div class="col-md-3 col-sm-6">
                                    <label class="form-label small text-muted mb-1">{{ 'Desde' | translate }}</label>
                                    <p-calendar [(ngModel)]="fechaInicial" [showIcon]="true" dateFormat="dd/mm/yy"
                                        [readonlyInput]="true" styleClass="w-100"
                                        [inputStyleClass]="'form-control form-control-sm rounded'"></p-calendar>
                                </div>
                                <div class="col-md-3 col-sm-6">
                                    <label class="form-label small text-muted mb-1">{{ 'Hasta' | translate }}</label>
                                    <p-calendar [(ngModel)]="fechaFinal" [showIcon]="true" dateFormat="dd/mm/yy"
                                        [readonlyInput]="true" styleClass="w-100"
                                        [inputStyleClass]="'form-control form-control-sm rounded'"></p-calendar>
                                </div>
                                <div class="col-md-3 col-sm-6">
                                    <div class="btn-group w-100">
                                        <button class="btn btn-sm btn-outline-primary" (click)="filtrarParaHoy()">
                                            <i class="pi pi-calendar-today me-1"></i>{{ 'Hoy' | translate }}
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" (click)="filtrarParaManana()">
                                            <i class="pi pi-calendar me-1"></i>{{ 'Mañana' | translate }}
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary"
                                            (click)="filtrarParaPasadoManana()">
                                            <i class="pi pi-calendar-plus me-1"></i>{{ 'Pasado' | translate }}
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 text-end">
                                    <div class="btn-group w-100">
                                        <button class="btn btn-sm btn-primary" (click)="buscarPorFechas()">
                                            <i class="pi pi-search me-1"></i>{{ 'Buscar' | translate }}
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" (click)="clear()">
                                            <i class="pi pi-refresh me-1"></i>{{ 'Limpiar' | translate }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Panel de KPI avanzados -->
                    <div class="metrics-container p-3 mb-3 border-bottom bg-white" *ngIf="!loading">
                        <div class="row">
                            <div class="col-12 mb-2">
                                <h6 class="fw-bold text-primary mb-2">
                                    <i class="pi pi-chart-line me-2"></i>
                                    {{ 'Métricas Avanzadas de Despacho' | translate }}
                                </h6>
                            </div>

                            <!-- Sección 1: KPIs generales -->
                            <div class="col-md-4">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-muted mb-3">{{ 'Estado de Pedidos' | translate }}
                                        </h6>
                                        <div class="d-flex flex-column gap-2">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-danger fw-bold">{{ 'Urgentes' | translate }}</span>
                                                <div class="d-flex align-items-center">
                                                    <div class="progress flex-grow-1 me-2"
                                                        style="width: 100px; height: 6px;">
                                                        <div class="progress-bar bg-danger"
                                                            [style.width.%]="(pedidosUrgentes.length / orders.length) * 100">
                                                        </div>
                                                    </div>
                                                    <span class="text-danger">
                                                        {{ obtenerConteoPedidosUrgentesNoDespachados() }}<span
                                                            class="text-muted small">/{{ pedidosUrgentes.length
                                                            }}</span>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-warning fw-bold">{{ 'En Riesgo' | translate }}</span>
                                                <div class="d-flex align-items-center">
                                                    <div class="progress flex-grow-1 me-2"
                                                        style="width: 100px; height: 6px;">
                                                        <div class="progress-bar bg-warning"
                                                            [style.width.%]="(pedidosEnRiesgo.length / orders.length) * 100">
                                                        </div>
                                                    </div>
                                                    <span class="text-warning">
                                                        {{ obtenerConteoPedidosEnRiesgoNoDespachados() }}<span
                                                            class="text-muted small">/{{ pedidosEnRiesgo.length
                                                            }}</span>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-info fw-bold">{{ 'Sin Producir' | translate }}</span>
                                                <div class="d-flex align-items-center">
                                                    <div class="progress flex-grow-1 me-2"
                                                        style="width: 100px; height: 6px;">
                                                        <div class="progress-bar bg-info"
                                                            [style.width.%]="(pedidosSinProducir.length / orders.length) * 100">
                                                        </div>
                                                    </div>
                                                    <span class="text-info">
                                                        {{ pedidosSinProducir.length }}<span
                                                            class="text-muted small" *ngIf="obtenerConteoPedidosSinProducirUrgentes() > 0">
                                                            <i class="pi pi-exclamation-triangle text-danger ms-1" pTooltip="{{ 'Urgentes' | translate }}: {{ obtenerConteoPedidosSinProducirUrgentes() }}"></i>
                                                        </span>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="text-success fw-bold">{{ 'Normales' | translate }}</span>
                                                <div class="d-flex align-items-center">
                                                    <div class="progress flex-grow-1 me-2"
                                                        style="width: 100px; height: 6px;">
                                                        <div class="progress-bar bg-success"
                                                            [style.width.%]="(pedidosNormales.length / orders.length) * 100">
                                                        </div>
                                                    </div>
                                                    <span class="text-success">{{ pedidosNormales.length }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección 2: Zonas críticas -->
                            <div class="col-md-4">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-muted mb-3">{{ 'Zonas Críticas' | translate }}</h6>
                                        <div class="d-flex flex-column gap-2">
                                            <ng-container
                                                *ngIf="obtenerZonasCriticas().length > 0; else noZonasCriticas">
                                                <div class="d-flex justify-content-between align-items-center"
                                                    *ngFor="let zona of obtenerZonasCriticas()">
                                                    <span class="fw-bold">{{ zona.zona }}</span>
                                                    <div class="d-flex align-items-center">
                                                        <div class="progress flex-grow-1 me-2"
                                                            style="width: 100px; height: 6px;">
                                                            <div class="progress-bar" [ngClass]="{
                                                                    'bg-danger': zona.porcentaje > 50,
                                                                    'bg-warning': zona.porcentaje <= 50 && zona.porcentaje > 20,
                                                                    'bg-success': zona.porcentaje <= 20
                                                                 }" [style.width.%]="zona.porcentaje"></div>
                                                        </div>
                                                        <span [ngClass]="{
                                                            'text-danger': zona.porcentaje > 50,
                                                            'text-warning': zona.porcentaje <= 50 && zona.porcentaje > 20,
                                                            'text-success': zona.porcentaje <= 20
                                                         }">{{ zona.porcentaje | number:'1.0-0' }}%</span>
                                                    </div>
                                                </div>
                                            </ng-container>
                                            <ng-template #noZonasCriticas>
                                                <div class="text-center text-muted py-2">
                                                    <i class="pi pi-check-circle fs-3 mb-2"></i>
                                                    <p class="mb-0">{{ 'No hay zonas críticas actualmente' | translate
                                                        }}</p>
                                                </div>
                                            </ng-template>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección 3: Predicción de carga -->
                            <div class="col-md-4">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body p-3">
                                        <h6 class="card-title text-muted mb-3">{{ 'Predicción de Carga (7 días)' |
                                            translate }}</h6>
                                        <div class="d-flex flex-column gap-2">
                                            <ng-container
                                                *ngIf="metricasLogistica?.prediccionCargaProximosDias as prediccion">
                                                <div class="d-flex justify-content-between align-items-center"
                                                    *ngFor="let item of (prediccion | keyvalue: orderByDate)?.slice(0, 7)">
                                                    <span class="fw-bold small">{{ formatearFecha(item.key) }}</span>
                                                    <div class="d-flex align-items-center">
                                                        <div class="progress flex-grow-1 me-2 position-relative"
                                                            style="width: 100px; height: 8px;">
                                                            <!-- Pedidos confirmados -->
                                                            <div class="progress-bar bg-primary"
                                                                [style.width.%]="(item.value.confirmados / 15) * 100"></div>
                                                            
                                                            <!-- Pedidos pendientes de producción (patrón rayado) -->
                                                            <div *ngIf="item.value.pendientesProduccion > 0" class="progress-bar bg-info"
                                                                [style.width.%]="(item.value.pendientesProduccion / 15) * 100"
                                                                style="opacity: 0.7; background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent); background-size: 1rem 1rem;"></div>
                                                        </div>
                                                        <div class="text-nowrap">
                                                            <span class="text-primary">{{ item.value.confirmados }}</span>
                                                            <span class="text-info" *ngIf="item.value.pendientesProduccion > 0">
                                                                +<span class="badge bg-info rounded-pill">{{ item.value.pendientesProduccion }}</span>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div *ngIf="(prediccion | keyvalue)?.length === 0" class="text-center text-muted py-2">
                                                    <i class="pi pi-calendar fs-3 mb-2"></i>
                                                    <p class="mb-0">{{ 'No hay datos disponibles' | translate }}</p>
                                                </div>
                                                <!-- Leyenda para explicar código de colores -->
                                                <div class="d-flex justify-content-between mt-3 pt-2 border-top">
                                                    <div class="d-flex align-items-center small text-muted">
                                                        <div class="d-inline-block me-2" style="width: 12px; height: 12px; background-color: var(--bs-primary);"></div>
                                                        {{ 'Confirmados' | translate }}
                                                    </div>
                                                    <div class="d-flex align-items-center small text-muted">
                                                        <div class="d-inline-block me-2" style="width: 12px; height: 12px; background-color: var(--bs-info); background-image: linear-gradient(45deg, rgba(255,255,255,.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.15) 50%, rgba(255,255,255,.15) 75%, transparent 75%, transparent); background-size: 10px 10px;"></div>
                                                        {{ 'Sin Producir' | translate }}
                                                    </div>
                                                </div>
                                            </ng-container>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen estadístico -->
                    <div class="row g-3 p-3 mb-2">
                        <div class="col-md-2">
                            <div class="stat-card stat-primary">
                                <div class="stat-icon">
                                    <i class="pi pi-shopping-cart"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">{{ 'Total Pedidos' | translate }}</div>
                                    <div class="stat-value">{{ orders.length }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card stat-success">
                                <div class="stat-icon">
                                    <i class="pi pi-dollar"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">{{ 'Subtotal' | translate }}</div>
                                    <div class="stat-value">{{ calculateSubtotal() | currency }}</div>
                                </div>
                            </div>
                        </div>
                        <!-- <div class="col-md-2">
                            <div class="stat-card stat-info">
                                <div class="stat-icon">
                                    <i class="pi pi-percentage"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">{{ 'Descuento' | translate }}</div>
                                    <div class="stat-value">{{ calculateDescuento() | currency }}</div>
                                </div>
                            </div>
                        </div> -->
                        <div class="col-md-2">
                            <div class="stat-card stat-warning">
                                <div class="stat-icon">
                                    <i class="pi pi-truck"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">{{ 'Envío' | translate }}</div>
                                    <div class="stat-value">{{ calculateTotalEnvio() | currency }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card stat-secondary">
                                <div class="stat-icon">
                                    <i class="pi pi-credit-card"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">{{ 'Anticipos' | translate }}</div>
                                    <div class="stat-value">{{ calculateAnticipo() | currency }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card stat-danger">
                                <div class="stat-icon">
                                    <i class="pi pi-wallet"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">{{ 'Por Cobrar' | translate }}</div>
                                    <div class="stat-value">{{ calculateFaltaPorPagar() | currency }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla principal de pedidos con componente -->
                    <div class="p-3">
                        <app-tabla-pedidos [orders]="orders" [loading]="loading" [estadosProcesos]="estadosProcesos"
                            [estadosPago]="estadosPago" (onViewDetails)="openDetalleEntrega($event)"
                            (onPrintPdf)="pdfOrder(modalContent, $event)" (onViewTags)="verTarjetasPedido($event)"
                            (onPrintLabel)="descargarRotulo($event)"
                            (onChangeStatus)="cambiarEstado($event.pedido, $event.status)"
                            (onRefreshData)="refrescar($event)" (onClearFilters)="clear($event)"
                            (onViewNotes)="verNotasCliente($event)"
                            (onViewFullObservaciones)="mostrarDetallesEnvio($event)">
                        </app-tabla-pedidos>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de detalle de entrega -->
<ng-template #detalleEntregaModal let-modal>
    <app-detalle-entrega [pedido]="detallePedidoEntregado" (onClose)="modal.dismiss('Cross click')"
        (onImageClick)="openFullImage($event)">
    </app-detalle-entrega>
</ng-template>

<!-- Modal para gestión de transportadores -->
<ng-template #transportadoresModal let-modal>
    <app-transportadores [vendors]="vendors" [editMode]="editTransporter" [selectedTransporter]="dataEditTransporter"
        (onSave)="onSaveTransportador($event)" (onEdit)="onEditTransportador($event)"
        (onDelete)="deleteTransporter($event)" (onClose)="modal.dismiss('Cross click')">
    </app-transportadores>
</ng-template>

<!-- Modal de contenido para imprimir PDF -->
<ng-template #modalContent let-modal>
    <app-imprimir-pdf [pedido]="pedidoSeleccionado" [htmlContent]="htmlModal" (onClose)="modal.dismiss('Cross click')"
        (onPrint)="modal.close('Save click')">
    </app-imprimir-pdf>
</ng-template>

<!-- Modal para generar órdenes de envío -->
<ng-template #generarOrdenEnvioModal let-modal>
    <app-generar-orden [orders]="orders" [pedidosSeleccionados]="pedidosSeleccionados"
        [nuevaOrdenEnvio]="nuevaOrdenEnvio" [nroShippingOrder]="nroShippingOrder"
        (onClose)="modal.dismiss('Cross click')" (onSave)="onSubmitOrdenEnvio($event)"
        (onAddOrder)="agregarPedido1($event)" (onRemoveOrder)="retirarPedido($event)" (onPrintOrder)="imprimirOrden()"
        (onDispatchOrder)="despacharOrden()">
    </app-generar-orden>
</ng-template>

<!-- Modal para editar órdenes de envío -->
<ng-template #pantallaOrdenEnvioModal let-modal>
    <app-generar-orden [orders]="orders" [pedidosSeleccionados]="pedidosSeleccionados"
        [nuevaOrdenEnvio]="nuevaOrdenEnvio" [nroShippingOrder]="nroShippingOrder" [isEditMode]="true"
        (onClose)="modal.dismiss('Cross click')" (onSave)="onSubmitOrdenEnvio($event)"
        (onAddOrder)="agregarPedido1($event)" (onRemoveOrder)="retirarPedido($event)" (onPrintOrder)="imprimirOrden()"
        (onDispatchOrder)="despacharOrden()">
    </app-generar-orden>
</ng-template>

<!-- Modal para visualizar órdenes de despacho -->
<ng-template #dispatchOrdersModal let-modal>
    <app-ordenes-despacho [dispatchOrders]="dispatchOrders" (onClose)="modal.dismiss('Cross click')"
        (onPrintOrder)="imprimirOrderToAction($event)" (onViewOrder)="handleOrderView($event)"
        (onDispatchOrder)="handleOrderDispatch($event)" (onDispatchPedido)="handlePedidoDispatch($event)">
    </app-ordenes-despacho>
</ng-template>