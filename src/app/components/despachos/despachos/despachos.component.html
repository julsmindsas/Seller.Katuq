<app-breadcrumb [title]="'Despachos' | translate" [items]="['Despachos' | translate]" [active_item]="'Despachos' | translate" class="mb-3"></app-breadcrumb>

<!-- Sección principal -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12">
            <!-- Card principal -->
            <div class="card shadow-sm border-0 mb-4">
                <!-- Loader -->
                <div class="loader-box" *ngIf="loading">
                    <div class="loader-8"></div>
                </div>

                <!-- Header del módulo -->
                <div class="module-header px-4 py-3 bg-white border-bottom d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1 fw-bold text-primary"><i class="pi pi-truck me-2"></i>{{ 'Gestión de Despachos' | translate }}</h5>
                        <p class="text-muted small mb-0">{{ 'Administra pedidos y órdenes de envío' | translate }}</p>
                    </div>
                </div>

                <!-- Filtros de búsqueda -->
                <div class="card-body p-0">
                    <div class="filtros-container bg-light p-3 border-bottom">
                        <div class="d-flex flex-column">
                            <!-- Encabezado de filtros -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0 text-muted">
                                    <i class="pi pi-filter text-primary me-2"></i>
                                    <span>{{ 'Filtros de búsqueda' | translate }}</span>
                                </h6>
                                <div class="btn-group">
                                    <button pButton type="button" icon="pi pi-truck" label="{{ 'Transportadores' | translate }}" 
                                        class="p-button-outlined p-button-sm p-button-secondary"
                                        (click)="openModal(transportadoresModal)"></button>
                                    <button pButton type="button" icon="pi pi-send" label="{{ 'Generar Orden' | translate }}" 
                                        class="p-button-outlined p-button-sm p-button-secondary"
                                        (click)="openModal(generarOrdenEnvioModal)"></button>
                                    <button pButton type="button" icon="pi pi-list" label="{{ 'Órdenes' | translate }}" 
                                        class="p-button-outlined p-button-sm p-button-secondary"
                                        (click)="viewAllDispatchOrders()"></button>
                                </div>
                            </div>
                            
                            <!-- Filtros de fecha -->
                            <div class="row g-3 align-items-end">
                                <div class="col-md-3 col-sm-6">
                                    <label class="form-label small text-muted mb-1">{{ 'Desde' | translate }}</label>
                                    <p-calendar [(ngModel)]="fechaInicial" 
                                        [showIcon]="true"
                                        dateFormat="dd/mm/yy"
                                        [readonlyInput]="true"
                                        styleClass="w-100"
                                        [inputStyleClass]="'form-control form-control-sm rounded'"></p-calendar>
                                </div>
                                <div class="col-md-3 col-sm-6">
                                    <label class="form-label small text-muted mb-1">{{ 'Hasta' | translate }}</label>
                                    <p-calendar [(ngModel)]="fechaFinal" 
                                        [showIcon]="true"
                                        dateFormat="dd/mm/yy"
                                        [readonlyInput]="true"
                                        styleClass="w-100"
                                        [inputStyleClass]="'form-control form-control-sm rounded'"></p-calendar>
                                </div>
                                <div class="col-md-3 col-sm-6">
                                    <div class="btn-group w-100">
                                        <button class="btn btn-sm btn-outline-primary" (click)="filtrarParaHoy()">
                                            <i class="pi pi-calendar-today me-1"></i>{{ 'Hoy' | translate }}
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" (click)="filtrarParaManana()">
                                            <i class="pi pi-calendar me-1"></i>{{ 'Mañana' | translate }}
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" (click)="filtrarParaPasadoManana()">
                                            <i class="pi pi-calendar-plus me-1"></i>{{ 'Pasado' | translate }}
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 text-end">
                                    <div class="btn-group w-100">
                                        <button class="btn btn-sm btn-primary" (click)="buscarPorFechas()">
                                            <i class="pi pi-search me-1"></i>{{ 'Buscar' | translate }}
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" (click)="clear()">
                                            <i class="pi pi-refresh me-1"></i>{{ 'Limpiar' | translate }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen estadístico -->
                    <div class="row g-3 p-3 mb-2">
                        <div class="col-md-2">
                            <div class="stat-card stat-primary">
                                <div class="stat-icon">
                                    <i class="pi pi-shopping-cart"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">{{ 'Total Pedidos' | translate }}</div>
                                    <div class="stat-value">{{ orders.length }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card stat-success">
                                <div class="stat-icon">
                                    <i class="pi pi-dollar"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">{{ 'Subtotal' | translate }}</div>
                                    <div class="stat-value">{{ calculateSubtotal() | currency }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card stat-info">
                                <div class="stat-icon">
                                    <i class="pi pi-percentage"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">{{ 'Descuento' | translate }}</div>
                                    <div class="stat-value">{{ calculateDescuento() | currency }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card stat-warning">
                                <div class="stat-icon">
                                    <i class="pi pi-truck"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">{{ 'Envío' | translate }}</div>
                                    <div class="stat-value">{{ calculateTotalEnvio() | currency }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card stat-secondary">
                                <div class="stat-icon">
                                    <i class="pi pi-credit-card"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">{{ 'Anticipos' | translate }}</div>
                                    <div class="stat-value">{{ calculateAnticipo() | currency }}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card stat-danger">
                                <div class="stat-icon">
                                    <i class="pi pi-wallet"></i>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">{{ 'Por Cobrar' | translate }}</div>
                                    <div class="stat-value">{{ calculateFaltaPorPagar() | currency }}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla principal de pedidos con componente -->
                    <div class="p-3">
                        <app-tabla-pedidos 
                            [orders]="orders" 
                            [loading]="loading"
                            [estadosProcesos]="estadosProcesos"
                            [estadosPago]="estadosPago"
                            (onViewDetails)="openDetalleEntrega($event)"
                            (onPrintPdf)="pdfOrder(modalContent, $event)"
                            (onViewTags)="verTarjetasPedido($event)"
                            (onPrintLabel)="descargarRotulo($event)"
                            (onChangeStatus)="cambiarEstado($event.pedido, $event.status)"
                            (onRefreshData)="refrescar($event)"
                            (onClearFilters)="clear($event)"
                            (onViewNotes)="verNotasCliente($event)">
                        </app-tabla-pedidos>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de detalle de entrega -->
<ng-template #detalleEntregaModal let-modal>
    <app-detalle-entrega 
        [pedido]="detallePedidoEntregado"
        (onClose)="modal.dismiss('Cross click')"
        (onImageClick)="openFullImage($event)">
    </app-detalle-entrega>
</ng-template>

<!-- Modal para gestión de transportadores -->
<ng-template #transportadoresModal let-modal>
    <app-transportadores
        [vendors]="vendors"
        [editMode]="editTransporter"
        [selectedTransporter]="dataEditTransporter"
        (onSave)="onSaveTransportador($event)"
        (onEdit)="onEditTransportador($event)"
        (onDelete)="deleteTransporter($event)"
        (onClose)="modal.dismiss('Cross click')">
    </app-transportadores>
</ng-template>

<!-- Modal de contenido para imprimir PDF -->
<ng-template #modalContent let-modal>
    <app-imprimir-pdf
        [pedido]="pedidoSeleccionado"
        [htmlContent]="htmlModal"
        (onClose)="modal.dismiss('Cross click')"
        (onPrint)="modal.close('Save click')">
    </app-imprimir-pdf>
</ng-template>

<!-- Modal para generar órdenes de envío -->
<ng-template #generarOrdenEnvioModal let-modal>
    <app-generar-orden
        [orders]="orders"
        [pedidosSeleccionados]="pedidosSeleccionados"
        [nuevaOrdenEnvio]="nuevaOrdenEnvio"
        [nroShippingOrder]="nroShippingOrder"
        (onClose)="modal.dismiss('Cross click')"
        (onSave)="onSubmitOrdenEnvio($event)"
        (onAddOrder)="agregarPedido1($event)"
        (onRemoveOrder)="retirarPedido($event)"
        (onPrintOrder)="imprimirOrden()"
        (onDispatchOrder)="despacharOrden()">
    </app-generar-orden>
</ng-template>

<!-- Modal para editar órdenes de envío -->
<ng-template #pantallaOrdenEnvioModal let-modal>
    <app-generar-orden
        [orders]="orders"
        [pedidosSeleccionados]="pedidosSeleccionados"
        [nuevaOrdenEnvio]="nuevaOrdenEnvio"
        [nroShippingOrder]="nroShippingOrder"
        [isEditMode]="true"
        (onClose)="modal.dismiss('Cross click')"
        (onSave)="onSubmitOrdenEnvio($event)"
        (onAddOrder)="agregarPedido1($event)"
        (onRemoveOrder)="retirarPedido($event)"
        (onPrintOrder)="imprimirOrden()"
        (onDispatchOrder)="despacharOrden()">
    </app-generar-orden>
</ng-template>

<!-- Modal para visualizar órdenes de despacho -->
<ng-template #dispatchOrdersModal let-modal>
    <app-ordenes-despacho
        [dispatchOrders]="dispatchOrders"
        (onClose)="modal.dismiss('Cross click')"
        (onPrintOrder)="imprimirOrderToAction($event)"
        (onViewOrder)="handleOrderView($event)"
        (onDispatchOrder)="handleOrderDispatch($event)"
        (onDispatchPedido)="handlePedidoDispatch($event)">
    </app-ordenes-despacho>
</ng-template>