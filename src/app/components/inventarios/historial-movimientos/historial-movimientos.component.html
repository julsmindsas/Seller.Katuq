<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center bg-light py-2">
        <h5 class="m-0">
            <i class="pi pi-history me-2"></i>
            Historial de Movimientos
        </h5>
        <p-button icon="pi pi-question-circle"
            pTooltip="Aquí podrás ver el historial de todos los movimientos de inventario realizados"
            tooltipPosition="left" styleClass="p-button-text p-button-rounded">
        </p-button>
    </div>
    <div class="card-body">
        <div class="card mb-3">
            <div class="card-header bg-light d-flex justify-content-between align-items-center py-2"
                (click)="toggleFiltros()" style="cursor: pointer">
                <h6 class="m-0">
                    <i class="pi pi-filter me-2"></i>
                    Filtros de búsqueda
                </h6>
                <button type="button" class="btn btn-link btn-sm p-0">
                    <i [class]="mostrarFiltros ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"></i>
                </button>
            </div>
            <div class="card-body" [hidden]="!mostrarFiltros">
                <form [formGroup]="formFiltros" (ngSubmit)="buscarMovimientos()" class="mb-3">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="pi pi-calendar me-1"></i>
                                    Fecha Inicio
                                </label>
                                <p-calendar formControlName="fechaInicio" [showIcon]="true" dateFormat="dd/mm/yy"
                                    pTooltip="Selecciona la fecha inicial del rango a consultar" tooltipPosition="top">
                                </p-calendar>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="pi pi-calendar me-1"></i>
                                    Fecha Fin
                                </label>
                                <p-calendar formControlName="fechaFin" [showIcon]="true" dateFormat="dd/mm/yy"
                                    pTooltip="Selecciona la fecha final del rango a consultar" tooltipPosition="top">
                                </p-calendar>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="pi pi-box me-1"></i>
                                    Producto
                                </label>
                                <p-dropdown [options]="productos" formControlName="producto" optionLabel="titulo"
                                    [showClear]="true" [filter]="true" placeholder="Selecciona un producto"
                                    pTooltip="Filtra por un producto específico" tooltipPosition="top">
                                </p-dropdown>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="pi pi-building me-1"></i>
                                    Bodega
                                </label>
                                <p-dropdown [options]="bodegas" formControlName="bodega" optionLabel="nombre"
                                    [showClear]="true" [filter]="true" placeholder="Selecciona una bodega"
                                    pTooltip="Filtra por una bodega específica" tooltipPosition="top">
                                </p-dropdown>
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="pi pi-sort me-1"></i>
                                    Ordenar por
                                </label>
                                <p-dropdown [options]="[
                                    {label: 'Fecha', value: 'fecha', icon: 'pi pi-calendar'},
                                    {label: 'Cantidad', value: 'cantidad', icon: 'pi pi-sort-numeric-down'},
                                    {label: 'Producto', value: 'producto', icon: 'pi pi-box'}
                                ]" formControlName="orderBy" [showClear]="true"
                                    placeholder="Selecciona el campo de ordenamiento"
                                    pTooltip="Selecciona cómo quieres ordenar los resultados" tooltipPosition="top">
                                    <ng-template let-option pTemplate="item">
                                        <div class="d-flex align-items-center">
                                            <i [class]="option.icon" class="me-2"></i>
                                            <span>{{option.label}}</span>
                                        </div>
                                    </ng-template>
                                </p-dropdown>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="pi pi-sort-alt me-1"></i>
                                    Dirección
                                </label>
                                <p-dropdown [options]="[
                                    {label: 'Ascendente', value: 'asc', icon: 'pi pi-sort-up'},
                                    {label: 'Descendente', value: 'desc', icon: 'pi pi-sort-down'}
                                ]" formControlName="orderDirection" [showClear]="true"
                                    placeholder="Selecciona la dirección"
                                    pTooltip="Selecciona el orden ascendente o descendente" tooltipPosition="top">
                                    <ng-template let-option pTemplate="item">
                                        <div class="d-flex align-items-center">
                                            <i [class]="option.icon" class="me-2"></i>
                                            <span>{{option.label}}</span>
                                        </div>
                                    </ng-template>
                                </p-dropdown>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12 text-end">
                            <button pButton type="submit" label="Buscar" icon="pi pi-search"
                                class="p-button-primary me-2"
                                pTooltip="Buscar movimientos con los filtros seleccionados" tooltipPosition="top">
                            </button>
                            <button pButton type="button" label="Exportar Excel" icon="pi pi-file-excel"
                                class="p-button-success me-2" (click)="exportarExcel()"
                                pTooltip="Exportar los resultados a Excel" tooltipPosition="top">
                            </button>
                            <button pButton type="button" label="Limpiar" icon="pi pi-refresh"
                                class="p-button-secondary" (click)="clear(dt)" pTooltip="Limpiar todos los filtros"
                                tooltipPosition="top">
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="d-flex align-items-center justify-content-between mb-2">
            <h6 class="m-0"><i class="pi pi-list me-2"></i>Resultados</h6>
            <div>
                <button pButton icon="pi pi-list" class="p-button-text p-button-rounded p-button-sm"
                    pTooltip="Vista compacta" tooltipPosition="left"></button>
                <button pButton icon="pi pi-th-large" class="p-button-text p-button-rounded p-button-sm"
                    pTooltip="Vista detallada" tooltipPosition="left"></button>
            </div>
        </div>

        <p-table #dt [value]="movimientos" [loading]="loading" [paginator]="true" [rows]="rows"
            [totalRecords]="totalRecords" [rowsPerPageOptions]="[10,25,50]" [showCurrentPageReport]="true"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
            (onPage)="onPageChange($event)" styleClass="p-datatable-sm p-datatable-gridlines" [scrollable]="true"
            scrollHeight="450px" [resizableColumns]="true" [reorderableColumns]="true" responsiveLayout="scroll">
            <ng-template pTemplate="caption">
                <div class="d-flex justify-content-end">
                    <span class="p-input-icon-left">
                        <i class="pi pi-search"></i>
                        <input pInputText type="text" placeholder="Buscar en toda la tabla"
                            (input)="dt.filterGlobal($event.target.value, 'contains')" />
                    </span>
                </div>
            </ng-template>
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 130px" pSortableColumn="fecha">
                        <div class="d-flex align-items-center">
                            <span>Fecha</span>
                            <p-sortIcon field="fecha" class="ms-2"></p-sortIcon>
                        </div>
                    </th>
                    <th style="width: 180px" pSortableColumn="producto">
                        <div class="d-flex align-items-center">
                            <span>Producto</span>
                            <p-sortIcon field="producto" class="ms-2"></p-sortIcon>
                        </div>
                    </th>
                    <th style="width: 100px">Código</th>
                    <th style="width: 130px">Bodega</th>
                    <th style="width: 90px" pSortableColumn="tipo">
                        <div class="d-flex align-items-center">
                            <span>Tipo</span>
                            <p-sortIcon field="tipo" class="ms-2"></p-sortIcon>
                        </div>
                    </th>
                    <th style="width: 90px" pSortableColumn="cantidad" class="text-center">
                        <div class="d-flex align-items-center justify-content-center">
                            <span>Cantidad</span>
                            <p-sortIcon field="cantidad" class="ms-2"></p-sortIcon>
                        </div>
                    </th>
                    <th style="width: 130px">Observaciones</th>
                    <th style="width: 110px">Orden Compra</th>
                    <th style="width: 110px">Usuario</th>
                    <th style="width: 70px" class="text-center">Acciones</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-movimiento>
                <tr class="cursor-pointer" (click)="verDocumento(movimiento)">
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="pi pi-calendar-plus me-2 text-primary"></i>
                            <span pTooltip="{{movimiento.fecha._seconds * 1000 | date:'dd/MM/yyyy HH:mm'}}"
                                tooltipPosition="top">
                                {{movimiento.fecha._seconds * 1000 | date:'dd/MM/yyyy'}}
                            </span>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="pi pi-box me-2 text-primary"></i>
                            <span pTooltip="{{movimiento.producto.crearProducto?.titulo}}" tooltipPosition="top"
                                class="text-truncate d-inline-block" style="max-width: 130px">
                                {{movimiento.producto.crearProducto?.titulo}}
                            </span>
                        </div>
                    </td>
                    <td>
                        <span pTooltip="Código de referencia del producto" tooltipPosition="top">
                            {{movimiento.producto.identificacion.referencia}}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="pi pi-building me-2 text-primary"></i>
                            <span pTooltip="{{movimiento.bodega.nombre}}" tooltipPosition="top"
                                class="text-truncate d-inline-block" style="max-width: 90px">
                                {{movimiento.bodega.nombre}}
                            </span>
                        </div>
                    </td>
                    <td>
                        <span class="badge" [ngClass]="getTipoMovimientoClass(movimiento.tipo)"
                            pTooltip="Tipo de movimiento realizado" tooltipPosition="top">
                            {{movimiento.tipo}}
                        </span>
                    </td>
                    <td class="text-center">
                        <span pTooltip="Cantidad movida" tooltipPosition="top" class="fw-bold">
                            {{movimiento.cantidad}}
                        </span>
                    </td>
                    <td>
                        <span pTooltip="{{movimiento.observaciones}}" tooltipPosition="top"
                            class="text-truncate d-inline-block" style="max-width: 110px">
                            {{movimiento.observaciones}}
                        </span>
                    </td>
                    <td>
                        <span pTooltip="Número de orden de compra" tooltipPosition="top">
                            {{movimiento.ordenCompraId}}
                        </span>
                    </td>
                    <td>
                        <span pTooltip="Usuario que realizó el movimiento" tooltipPosition="top"
                            class="text-truncate d-inline-block" style="max-width: 90px">
                            {{movimiento.usuario}}
                        </span>
                    </td>
                    <td class="text-center">
                        <button pButton type="button" icon="pi pi-eye"
                            class="p-button-rounded p-button-text p-button-sm" pTooltip="Ver detalles del movimiento"
                            tooltipPosition="top" (click)="$event.stopPropagation(); verDocumento(movimiento)">
                        </button>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="10" class="text-center">
                        <div class="p-4">
                            <i class="pi pi-info-circle" style="font-size: 2rem"></i>
                            <p class="mt-2">No se encontraron movimientos con los filtros seleccionados</p>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="paginatorleft">
                <div class="p-2">
                    Total: {{totalRecords}} movimientos
                </div>
            </ng-template>
        </p-table>
    </div>
</div>