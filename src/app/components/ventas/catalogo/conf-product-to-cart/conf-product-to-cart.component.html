<div class="modal-header">
    <h4 class="modal-title">{{'Configuración del producto' | translate}}</h4>
</div>
<div class="container-fluid modal-body">
    <div>
        <div class="row">
            <!-- Columna izquierda: Información del producto -->
            <div class="col-xl-6 xl-cs-65 box-col-6">
                <div class="card">
                    <div class="card-body">
                        <section>
                            <ks-carousel [id]="101" [images]="imagesRect" [config]="libConfigCarouselFixed">
                            </ks-carousel>
                        </section>
                        <section class="product-compact-info">
                            <div class="product-page-details">
                                <h3 class="product-title">{{producto?.crearProducto?.titulo}}</h3>
                                <div class="product-meta">
                                    <div class="meta-item">
                                        <span class="meta-label">{{'Referencia:' | translate}}</span>
                                        <span>{{producto?.identificacion?.referencia}}</span>
                                    </div>
                                    <div class="meta-item">
                                        <span class="meta-label">{{'Cantidad mínima:' | translate}}</span>
                                        <span>{{producto?.disponibilidad?.cantidadMinVenta}}</span>
                                    </div>
                                    <div class="meta-item">
                                        <span class="meta-label">{{'Tiempo de entrega:' | translate}}</span>
                                        <span>{{getTituloTiempoEntrega()}}</span>
                                    </div>
                                    <div class="meta-item">
                                        <span class="meta-label">{{'Disponibilidad:' | translate}}</span>
                                        <span 
                                            [class]="getStockStatusClass()"
                                            [title]="getStockStatusMessage()">
                                            {{getStockDisplayText()}}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Alerta de stock -->
                                <div *ngIf="shouldShowStockAlert()" 
                                     [class]="getStockAlertClass()" 
                                     class="p-2 small mb-2">
                                    <i [class]="getStockAlertIcon() + ' me-1'"></i>
                                    {{getStockAlertMessage()}}
                                </div>
                                
                                <div class="alert alert-light p-2 small">
                                    <i class="fa fa-info-circle me-1"></i>
                                    {{'NO se incluye valor del domicilio. Incluye impuestos.' | translate}}
                                </div>
                            </div>
                            <div>
                                <!-- Precio y botón de tabla de cantidades optimizado para evitar saltos de línea -->
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div>
                                        <p class="product-price f-28 mb-0" title="{{'precio' | translate}}">
                                            {{producto?.precio?.precioUnitarioConIva |
                                            currency:'USD':'symbol':'1.0-0'}}*
                                        </p>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-secondary btn-sm" data-toggle="tooltip"
                                            data-placement="top"
                                            title="{{'Ver tabla de precios por volumen' | translate}}"
                                            (click)="mostrarTabla = !mostrarTabla">
                                            <i class="fa fa-table me-1"></i>
                                            {{'Tabla de Cantidades' | translate}}
                                        </button>
                                    </div>
                                </div>

                                <div *ngIf="mostrarTabla" class="mt-2 mb-3">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-compact">
                                            <thead>
                                                <tr>
                                                    <th>{{'Desde' | translate}}</th>
                                                    <th>{{'Hasta' | translate}}</th>
                                                    <th>{{'Valor Unitario Con IVA' | translate}}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let item of producto.precio.preciosVolumen">
                                                    <td>{{item.numeroUnidadesInicial}} UND</td>
                                                    <td>{{item.numeroUnidadesLimite}} UND</td>
                                                    <td>{{item.valorUnitarioPorVolumenConIVA | currency}}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <hr>

                                <!-- Solo mostrar resumen inicial sin scroll -->
                                <div class="product-description-summary mb-2">
                                    <div [innerHTML]="getDescriptionSummary(producto?.crearProducto?.descripcion)">
                                    </div>
                                    <button class="toggle-text-btn"
                                        (click)="mostrarDescripcionCompleta = !mostrarDescripcionCompleta">
                                        {{mostrarDescripcionCompleta ? 'Ver menos' : 'Ver más' | translate}}
                                        <i class="fa"
                                            [ngClass]="mostrarDescripcionCompleta ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                    </button>
                                </div>

                                <!-- Descripción completa solo cuando se solicita -->
                                <div *ngIf="mostrarDescripcionCompleta" class="product-description-full">
                                    <div [innerHTML]="producto?.crearProducto?.descripcion"></div>
                                </div>

                                <hr>
                                <!-- Resto del contenido solo si se selecciona ver más detalles -->
                                <div *ngIf="mostrarDetallesCompletos">
                                    <ngb-accordion [closeOthers]="true" class="details-accordion">
                                        <ngb-panel id="detallesPanel" title="{{ 'Detalles del producto' | translate }}">
                                            <ng-template ngbPanelContent>
                                                <table class="product-page-width">
                                                    <tbody>
                                                        <tr>
                                                            <td><b>{{'Marca :' | translate}}</b></td>
                                                            <td>{{producto?.identificacion?.marca}}</td>
                                                        </tr>
                                                        <tr>
                                                            <td><b>{{'Habilitado :' | translate}} &nbsp;&nbsp;&nbsp;</b>
                                                            </td>
                                                            <td class="txt-success">{{'In stock' | translate}}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </ng-template>
                                        </ngb-panel>

                                        <ngb-panel id="calificacionPanel" title="{{ 'Calificación' | translate }}">
                                            <ng-template ngbPanelContent>
                                                <div class="rating">
                                                    <form [formGroup]="ratingForm" class="rating">
                                                        <ngx-star-rating formControlName="rating"
                                                            [id]="'rating'"></ngx-star-rating>
                                                        <div>Rating: {{ratingForm.value.rating}}</div>
                                                    </form>
                                                </div>
                                            </ng-template>
                                        </ngb-panel>
                                    </ngb-accordion>
                                </div>

                                <!-- Botón para ver más detalles del producto -->
                                <button class="btn btn-link btn-sm text-decoration-none ps-0"
                                    (click)="mostrarDetallesCompletos = !mostrarDetallesCompletos">
                                    <i class="fa"
                                        [ngClass]="mostrarDetallesCompletos ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                    {{mostrarDetallesCompletos ? 'Ocultar detalles' : 'Ver más detalles' | translate}}
                                </button>

                                <!-- Panel colapsable de preferencias seleccionadas -->
                                <div *ngIf="productPreference?.length > 0" class="mt-3">
                                    <ngb-accordion #prefAcc="ngbAccordion">
                                        <ngb-panel id="seleccionesPanel">
                                            <ng-template ngbPanelHeader>
                                                <div class="d-flex align-items-center">
                                                    <button ngbPanelToggle class="accordion-button">
                                                        <i class="fa fa-check-circle me-2"></i>
                                                        {{'Preferencias seleccionadas' | translate}}
                                                    </button>
                                                </div>
                                            </ng-template>
                                            <ng-template ngbPanelContent>
                                                <div class="table-responsive">
                                                    <table class="table table-dashed table-compact">
                                                        <thead>
                                                            <tr>
                                                                <th>Imagen</th>
                                                                <th>Título</th>
                                                                <th>Subtitulo</th>
                                                                <th>Valor Unitario sin IVA</th>
                                                                <th>% IVA</th>
                                                                <th>Valor IVA</th>
                                                                <th>Precio Total con IVA</th>
                                                                <th>Cantidad</th>
                                                                <th></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <!-- Sección de Preferencia -->
                                                            <tr *ngIf="hasPreferencia()">
                                                                <td colspan="8"><strong>Sección de Preferencias</strong>
                                                                </td>
                                                            </tr>
                                                            <ng-container *ngFor="let preference of productPreference">
                                                                <tr *ngIf="preference.tipo === 'preferencia'">
                                                                    <td>

                                                                        <img [src]="preference?.imagen"
                                                                            [alt]="preference.titulo" appImageOptimizer
                                                                            [quality]="0.3" [width]="40" [height]="40"
                                                                            [lazy]="true" loading="lazy" priority
                                                                            class="rounded">
                                                                    </td>
                                                                    <td>{{ preference.titulo }}</td>
                                                                    <td>{{ preference.subtitulo }}</td>
                                                                    <td>{{ preference.valorUnitarioSinIva |
                                                                        currency:'USD':'symbol':'1.2-2'}}</td>
                                                                    <td>{{ preference.porcentajeIva + '%' }}</td>
                                                                    <td>{{ preference.valorIva |
                                                                        currency:'USD':'symbol':'1.2-2'}}</td>
                                                                    <td>{{ preference.precioTotalConIva |
                                                                        currency:'USD':'symbol':'1.2-2' }}
                                                                    </td>
                                                                    <td>
                                                                        <!-- <div class="quantity-controls" style="white-space: nowrap;">
                                                                            <button
                                                                                (click)="decrementarCantidad(preference); $event.stopPropagation()">-</button>
                                                                            <span>{{preference.cantidad}}</span>
                                                                            <button
                                                                                (click)="incrementarCantidad(preference); $event.stopPropagation()">+</button>
                                                                        </div> -->
                                                                    </td>
                                                                </tr>
                                                            </ng-container>

                                                            <!-- Sección de Adición -->
                                                            <tr *ngIf="hasAdicion()">
                                                                <td colspan="8"><strong>Sección de adiciones</strong>
                                                                </td>
                                                            </tr>
                                                            <ng-container *ngFor="let preference of productPreference">
                                                                <tr *ngIf="preference.tipo === 'adicion'">
                                                                    <td>
                                                                        <img [src]="preference?.imagen"
                                                                            alt="{{preference.titulo}}" width="40"
                                                                            height="40" class="rounded">
                                                                    </td>
                                                                    <td>{{ preference.titulo }}</td>
                                                                    <td>{{ preference.subtitulo }}</td>
                                                                    <td>{{ preference.valorUnitarioSinIva |
                                                                        currency:'USD':'symbol':'1.2-2'}}</td>
                                                                    <td>{{ preference.porcentajeIva + '%' }}</td>
                                                                    <td>{{ preference.valorIva |
                                                                        currency:'USD':'symbol':'1.2-2'}}</td>
                                                                    <td>{{ preference.precioTotalConIva |
                                                                        currency:'USD':'symbol':'1.2-2' }}
                                                                    </td>
                                                                    <td>
                                                                        <div class="quantity-controls"
                                                                            style="white-space: nowrap;">
                                                                            <button
                                                                                (click)="decrementarCantidad(preference); $event.stopPropagation()">-</button>
                                                                            <span>{{preference.cantidad}}</span>
                                                                            <button
                                                                                (click)="incrementarCantidad(preference); $event.stopPropagation()">+</button>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            </ng-container>

                                                            <!-- Opciones de personalización -->
                                                            <tr *ngIf="hasOpcionesPersonalizacion()">
                                                                <td colspan="8"><strong>Sección de opciones de
                                                                        personalización</strong></td>
                                                            </tr>
                                                            <ng-container *ngFor="let preference of productPreference">
                                                                <tr *ngIf="preference.tipo === 'opcionPersonalizacion'">
                                                                    <td colspan="12">
                                                                        <div
                                                                            style="display: inline-block; white-space: nowrap;">
                                                                            <div class="row"
                                                                                *ngIf="datosEntrega?.controls?.colores?.value?.length > 0">
                                                                                <div class="col-sm-6">
                                                                                    <strong>Color:</strong>
                                                                                </div>
                                                                                <div class="col-sm-6"
                                                                                    style="margin-top: -1rem;">
                                                                                    <ul class="product-color m-t-15">
                                                                                        <li *ngFor="let item of datosEntrega?.controls?.colores?.value"
                                                                                            [style.backgroundColor]="item">
                                                                                        </li>
                                                                                    </ul>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="collapsible-text"
                                                                            [ngClass]="{'collapsed': !mostrarPersonalizacionCompleta}"
                                                                            [innerHtml]="preference.subtitulo"></div>
                                                                        <button
                                                                            *ngIf="preference.subtitulo && preference.subtitulo.length > 100"
                                                                            class="toggle-text-btn"
                                                                            [ngClass]="{'expanded': mostrarPersonalizacionCompleta}"
                                                                            (click)="mostrarPersonalizacionCompleta = !mostrarPersonalizacionCompleta">
                                                                            {{mostrarPersonalizacionCompleta ? 'Ver
                                                                            menos' : 'Ver más' | translate}}
                                                                            <i class="fa"
                                                                                [ngClass]="mostrarPersonalizacionCompleta ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            </ng-container>

                                                            <!-- Sección Tarjetas -->
                                                            <tr *ngIf="!SinTarjeta">
                                                                <td colspan="8"><strong>Sección Tarjetas</strong></td>
                                                            </tr>
                                                            <ng-container *ngIf="!SinTarjeta">
                                                                <tr
                                                                    *ngFor="let tarjeta of this.tarjetas.value; let i = index">
                                                                    <td colspan="8">
                                                                        <div class="card p-2 mb-2">
                                                                            <div><strong>{{'Para:' |
                                                                                    translate}}</strong> {{ tarjeta.para
                                                                                }}</div>
                                                                            <div class="mt-1">
                                                                                <strong>{{'Mensaje:' |
                                                                                    translate}}</strong>
                                                                                <div class="collapsible-text"
                                                                                    [ngClass]="{'collapsed': !tarjetaMostrada[i]}"
                                                                                    style="white-space: normal;">
                                                                                    {{ tarjeta.mensaje }}
                                                                                </div>
                                                                                <button
                                                                                    *ngIf="tarjeta.mensaje && tarjeta.mensaje.length > 100"
                                                                                    class="toggle-text-btn"
                                                                                    [ngClass]="{'expanded': tarjetaMostrada[i]}"
                                                                                    (click)="toggleTarjeta(i)">
                                                                                    {{tarjetaMostrada[i] ? 'Ver menos' :
                                                                                    'Ver más' | translate}}
                                                                                    <i class="fa"
                                                                                        [ngClass]="tarjetaMostrada[i] ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                                                                </button>
                                                                            </div>
                                                                            <div class="mt-1"><strong>{{'De:' |
                                                                                    translate}}</strong> {{ tarjeta.de
                                                                                }}</div>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                            </ng-container>
                                                        </tbody>
                                                        <tfoot>
                                                            <tr>
                                                                <td colspan="2"></td>
                                                                <td><strong>Resumen:</strong></td>
                                                                <td>{{ getTotalValorUnitarioSinIva() |
                                                                    currency:'USD':'symbol':'1.2-2' }}
                                                                </td>
                                                                <td> </td>
                                                                <td>{{ getTotalValorIva() |
                                                                    currency:'USD':'symbol':'1.2-2' }}</td>
                                                                <td>{{ getTotalPrecioTotalConIva() |
                                                                    currency:'USD':'symbol':'1.2-2' }}</td>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                            </ng-template>
                                        </ngb-panel>
                                    </ngb-accordion>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: Configuración del producto (SIMPLIFICADO) -->
            <div class="col-xl-6 xl-cs-35 box-col-6">
                <!-- TODAS LAS SECCIONES EN UNA VISTA ÚNICA -->
                <ngb-accordion #acc="ngbAccordion" [activeIds]="activeAccordionPanel" class="custom-accordion">
                    <!-- Sección 1: Datos entrega -->
                    <ngb-panel id="datosEntregaPanel">
                        <ng-template ngbPanelHeader>
                            <div class="d-flex align-items-center justify-content-between w-100">
                                <button ngbPanelToggle class="accordion-button">
                                    <i class="fa fa-calendar me-2"></i> {{'DATOS PARA LA ENTREGA' | translate}}
                                </button>
                                <span *ngIf="datosEntrega.valid"
                                    class="badge bg-success me-4 d-flex align-items-center">
                                    <i class="fa fa-check me-1"></i> {{'Completado' | translate}}
                                </span>
                            </div>
                        </ng-template>
                        <ng-template ngbPanelContent>
                            <form [formGroup]="datosEntrega" class="datos-entrega-form">
                                <!-- Sección de fecha de entrega -->
                                <div *ngIf="producto?.procesoComercial?.llevaCalendario" class="mb-3">
                                    <h5 class="section-title">{{'1. Fecha de entrega' | translate}}</h5>
                                    <div class="form-group">
                                        <div class="input-group">
                                            <input class="form-control" [ngClass]="{'is-invalid': datosEntrega.get('fechaEntrega')?.invalid && datosEntrega.get('fechaEntrega')?.touched}" placeholder="{{'Fecha de entrega' | translate}}"
                                                name="dp" formControlName="fechaEntrega" ngbDatepicker
                                                #d3="ngbDatepicker" [minDate]="minDate" [placement]="placement"
                                                [positionTarget]="buttonEl" readonly />
                                            <button #buttonEl class="btn btn-primary calendar" (click)="d3.toggle()"
                                                type="button">
                                                <app-feather-icons [icon]="'calendar'"></app-feather-icons>
                                            </button>
                                        </div>
                                        <div *ngIf="datosEntrega.get('fechaEntrega')?.invalid && datosEntrega.get('fechaEntrega')?.touched" class="invalid-feedback d-block">
                                            {{'La fecha de entrega es obligatoria' | translate}}
                                        </div>
                                    </div>

                                    <!-- Forma de entrega -->
                                    <div *ngIf="hasFechaEntrega()" class="mt-3">
                                        <h5 class="section-title">{{'2. Forma de entrega' | translate}}</h5>
                                        <div class="form-group">
                                            <ng-select [items]="formasEntregaProducto" bindLabel="nombre"
                                                bindValue="nombre" placeholder="{{'Forma de entrega' | translate}}"
                                                class="form-control" [ngClass]="{'is-invalid': datosEntrega.get('formaEntrega')?.invalid && datosEntrega.get('formaEntrega')?.touched}"
                                                style="font-family: roboto;" [closeOnSelect]="true"
                                                formControlName="formaEntrega" (change)="changeTipoEntrega($event)">
                                            </ng-select>
                                            <div *ngIf="datosEntrega.get('formaEntrega')?.invalid && datosEntrega.get('formaEntrega')?.touched" class="invalid-feedback d-block">
                                                {{'La forma de entrega es obligatoria' | translate}}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Horarios -->
                                    <div *ngIf="hasFechaEntrega()" class="mt-3">
                                        <h5 class="section-title">{{'3. Horarios' | translate}}</h5>
                                        <div class="form-group">
                                            <ng-select [items]="horarios" class="form-control"
                                                placeholder="{{'Horarios' | translate}}" class="form-control"
                                                [ngClass]="{'is-invalid': datosEntrega.get('horarioEntrega')?.invalid && datosEntrega.get('horarioEntrega')?.touched}"
                                                formControlName="horarioEntrega" style="font-family: roboto;"
                                                [closeOnSelect]="true">
                                            </ng-select>
                                            <div *ngIf="datosEntrega.get('horarioEntrega')?.invalid && datosEntrega.get('horarioEntrega')?.touched" class="invalid-feedback d-block">
                                                {{'El horario de entrega es obligatorio' | translate}}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Texto informativo para entregas estándar -->
                                <div *ngIf="!producto?.procesoComercial?.llevaCalendario"
                                    class="alert alert-light p-3 mb-3">
                                    <i class="fa fa-info-circle me-2"></i>
                                    <p class="mb-0">{{'Entregamos este producto en un plazo que varía desde el mismo día
                                        de la compra hasta un máximo de 2 días hábiles. Recibirás una notificación tan
                                        pronto como comencemos el proceso de envío, para que estés preparado/a para
                                        recibirlo.' | translate}}</p>
                                </div>

                                <!-- Sección de personalización -->
                                <div *ngIf="hasAceptaOcasion || hasAceptaGenero || producto?.procesoComercial?.aceptaComentarios || producto?.procesoComercial.aceptaColorDecoracion"
                                    class="mt-4">
                                    <h5 class="section-title">{{'OBSERVACIONES DE PERSONALIZACIÓN' | translate}}</h5>

                                    <!-- Ocasión -->
                                    <div *ngIf="hasAceptaOcasion" class="form-group">
                                        <label>{{'Ocasión' | translate}} <span class="text-danger">*</span></label>
                                        <ng-select [items]="ocasiones" formControlName="ocasion" class="form-control"
                                            [ngClass]="{'is-invalid': datosEntrega.get('ocasion')?.invalid && datosEntrega.get('ocasion')?.touched}"
                                            placeholder="{{'Ocasión' | translate}}"
                                            (change)="addOpcionesPersonalizacion()" style="font-family: roboto;"
                                            bindLabel="name" bindValue="id" [closeOnSelect]="true">
                                        </ng-select>
                                        <div *ngIf="datosEntrega.get('ocasion')?.invalid && datosEntrega.get('ocasion')?.touched" class="invalid-feedback d-block">
                                            {{'La ocasión es obligatoria' | translate}}
                                        </div>
                                    </div>

                                    <!-- Género -->
                                    <div *ngIf="hasAceptaGenero" class="form-group">
                                        <label>{{'Género' | translate}} <span class="text-danger">*</span></label>
                                        <ng-select style="height:auto !important" [items]="generos"
                                            formControlName="genero" bindLabel="name" bindValue="id"
                                            [ngClass]="{'is-invalid': datosEntrega.get('genero')?.invalid && datosEntrega.get('genero')?.touched}"
                                            (change)="addOpcionesPersonalizacion()" class="form-control"
                                            placeholder="{{'Genero' | translate}}" style="font-family: roboto;"
                                            [multiple]="false" [closeOnSelect]="true">
                                        </ng-select>
                                        <div *ngIf="datosEntrega.get('genero')?.invalid && datosEntrega.get('genero')?.touched" class="invalid-feedback d-block">
                                            {{'El género es obligatorio' | translate}}
                                        </div>
                                    </div>

                                    <!-- Observaciones -->
                                    <div *ngIf="producto?.procesoComercial?.aceptaComentarios" class="form-group">
                                        <label>{{'Observaciones' | translate}} <span class="text-danger">*</span></label>
                                        <textarea class="form-control" formControlName="observaciones"
                                            [ngClass]="{'is-invalid': datosEntrega.get('observaciones')?.invalid && datosEntrega.get('observaciones')?.touched}"
                                            id="exampleFormControlTextarea1" rows="3"
                                            (keyup)="addOpcionesPersonalizacion()"
                                            placeholder="{{'Observaciones' | translate}}"></textarea>
                                        <div *ngIf="datosEntrega.get('observaciones')?.invalid && datosEntrega.get('observaciones')?.touched" class="invalid-feedback d-block">
                                            {{'Las observaciones son obligatorias' | translate}}
                                        </div>
                                    </div>

                                    <!-- Colores -->
                                    <div *ngIf="producto?.procesoComercial.aceptaColorDecoracion" class="form-group">
                                        <label>{{'Seleccione el color' | translate}} <span class="text-danger">*</span></label>
                                        <div>
                                            <ul class="product-color m-t-15">
                                                <li *ngFor="let item of producto.procesoComercial?.colorDecoracion"
                                                    [style.backgroundColor]="item" (click)="selectedColor($event,item)"
                                                    title="{{'Dale click para seleccionar' | translate}}"
                                                    style="cursor: pointer;">
                                                </li>
                                            </ul>
                                        </div>
                                        <div *ngIf="datosEntrega.get('colores')?.invalid && datosEntrega.get('colores')?.touched" class="invalid-feedback d-block">
                                            {{'Debe seleccionar al menos un color' | translate}}
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </ng-template>
                    </ngb-panel>

                    <!-- Sección 2: Preferencias -->
                    <ngb-panel id="preferenciasPanel" *ngIf="producto?.procesoComercial?.aceptaVariable">
                        <ng-template ngbPanelHeader>
                            <div class="d-flex align-items-center justify-content-between w-100">
                                <button ngbPanelToggle class="accordion-button">
                                    <i class="fa fa-list-alt me-2"></i> {{'PREFERENCIAS DEL PRODUCTO' | translate}}
                                </button>
                                <span *ngIf="getVariablesControls().length > 0 && hasPreferencia()"
                                    class="badge bg-success me-4 d-flex align-items-center">
                                    <i class="fa fa-check me-1"></i>
                                </span>
                            </div>
                        </ng-template>
                        <ng-template ngbPanelContent>
                            <form [formGroup]="formulario">
                                <div formArrayName="variables">
                                    <div *ngFor="let item of getVariablesControls(); let i = index" class="row">
                                        <div [formGroupName]="i" class="col-sm-12 preference-section">

                                            <!-- Manejo de la propiedad data -->
                                            <div class="form-group">
                                                <h5 class="section-heading">{{(i+1).toString()}}. {{
                                                    item.get('data')?.get('titulo').value
                                                    }}</h5>
                                                <span>{{
                                                    item.get('data')?.get('subtitulo').value
                                                    }}</span>

                                                <!-- Condiciones para el campo tipoImagen -->
                                                <div *ngIf="item.get('data')?.get('tipoImagen')?.value === 'texto'"
                                                    class="form-group mt-2">
                                                    <textarea formControlName="textoIngresado"
                                                        placeholder="{{'Texto' | translate}}"
                                                        (keyup)="selectedProductPreference($event, item)"
                                                        class="form-control" rows="3"></textarea>
                                                </div>
                                                <div *ngIf="item.get('data')?.get('tipoImagen')?.value === 'imagen'"
                                                    class="form-group mt-2">
                                                    <input formControlName="imagenIngresado" type="file"
                                                        accept="image/*" class="form-control"
                                                        (change)="selectedProductPreference($event, item)"
                                                        placeholder="{{'Subir imagen' | translate}}">
                                                </div>
                                                <div *ngIf="item.get('data')?.get('tipoImagen')?.value === 'archivo'"
                                                    class="form-group mt-2">
                                                    <input formControlName="archivoIngresado" type="file"
                                                        (change)="selectedProductPreference($event, item)"
                                                        placeholder="{{'Adjuntar archivo' | translate}}"
                                                        class="form-control">
                                                </div>
                                            </div>

                                            <div *ngIf="tieneHijos(item)" class="form-group mt-3">
                                                <ng-select [items]="item.get('children').controls"
                                                    bindLabel="value.data.titulo" bindValue="value.data.titulo"
                                                    (change)="selectedProductPreferenceForNgSelect($event, item)"
                                                    placeholder="{{'Selecciona una opción' | translate}}"
                                                    [multiple]="false" [closeOnSelect]="true">
                                                    <ng-template ng-label-tmp let-item="item">
                                                        {{ item.value.data.titulo}} +
                                                        {{
                                                        item.value.data.precioTotalConIva
                                                        | currency}}
                                                    </ng-template>
                                                    <ng-template ng-option-tmp let-item="item">
                                                        <img [src]="getImgAdicion(item.value.data.titulo)" alt="image"
                                                            width="50" height="50" />
                                                        {{ item.value.data.titulo}} +
                                                        {{
                                                        item.value.data.precioTotalConIva
                                                        | currency}}
                                                    </ng-template>
                                                </ng-select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </ng-template>
                    </ngb-panel>

                    <!-- Sección 3: Tarjetas -->
                    <ngb-panel id="tarjetasPanel" *ngIf="producto?.procesoComercial?.llevaTarjeta">
                        <ng-template ngbPanelHeader>
                            <div class="d-flex align-items-center justify-content-between w-100">
                                <button ngbPanelToggle class="accordion-button">
                                    <i class="fa fa-gift me-2"></i> {{'TARJETAS' | translate}} <span
                                        *ngIf="!SinTarjeta">({{tarjetas.length}})</span>
                                </button>
                                <span *ngIf="SinTarjeta || tarjetas.length > 0"
                                    class="badge bg-success me-4 d-flex align-items-center">
                                    <i class="fa fa-check me-1"></i>
                                </span>
                            </div>
                        </ng-template>
                        <ng-template ngbPanelContent>
                            <div class="row">
                                <div class="col-sm-12">
                                    <div class="d-flex align-items-center">
                                        <h5 class="m-15" *ngIf="!SinTarjeta">{{'TARJETAS' | translate}}
                                            ({{tarjetas.length}})</h5>
                                        <h5 class="m-15" *ngIf="SinTarjeta">{{'SIN TARJETAS' | translate}} </h5>
                                        <button class="btn btn-sm btn-primary ms-2" *ngIf="!SinTarjeta"
                                            title="{{'Agregar otra tarjeta' | translate}}" (click)="agregarTarjeta()">
                                            <i class="fa fa-plus me-1"></i> {{'Agregar' | translate}}
                                        </button>
                                    </div>
                                    <div class="form-check mt-2">
                                        <input type="checkbox" class="form-check-input" id="tarjetas" name="tarjetas"
                                            value="tarjetas" (change)="onChangeTarjetas($event)">
                                        <label class="form-check-label" for="tarjetas">{{'Solo quiero una tarjeta para
                                            este producto' | translate}}
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="notarjetas"
                                            name="notarjetas" value="notarjetas" (change)="onChangeNoTarjetas($event)">
                                        <label class="form-check-label" for="notarjetas">{{'No quiero tarjeta para este
                                            producto' | translate}}
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div *ngIf="!SinTarjeta" class="mt-3">
                                <form [formGroup]="tarjetasForm">
                                    <div formArrayName="tarjetas">
                                        <div *ngFor="let tarjeta of tarjetas.controls; let i = index">
                                            <div [formGroupName]="i" class="card p-3 mb-3">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h5 class="mb-0">{{'Tarjeta #' | translate}}{{ i + 1 }}</h5>
                                                    <div>
                                                        <app-katuqintelligence class="me-2"
                                                            [titleInput]="'Generate text with IA for tarjeta' + (i + 1)"
                                                            [katuqIntelligencePrompt]="getKatuqPrompt()"
                                                            [textToSwalHeader]="'Por favor espera mientras generamos el mensaje para la tarjeta ' + (i + 1) + '...'"
                                                            [textToQuiestionSwal]="'¿Desea generar texto para la tarjeta # ' + (i + 1) + '?'"
                                                            [objectToText]="tarjeta"
                                                            (katuqIntelligenceResponse)="katuqIntelligeceResponse($event)"></app-katuqintelligence>
                                                        <button type="button" class="btn btn-sm btn-danger"
                                                            (click)="removeTarjetaForm(i)">
                                                            <i class="fa fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="form-group mb-2">
                                                    <label class="form-label">{{'Para:' | translate}}</label>
                                                    <input class="form-control" formControlName="para" 
                                                           [ngClass]="{'is-invalid': tarjeta.get('para')?.invalid && tarjeta.get('para')?.touched}" />
                                                    <div *ngIf="tarjeta.get('para')?.invalid && tarjeta.get('para')?.touched" 
                                                         class="invalid-feedback">
                                                        {{'Este campo es obligatorio' | translate}}
                                                    </div>
                                                </div>
                                                <div class="form-group mb-2">
                                                    <label class="form-label">{{'Mensaje Para La Tarjeta:' | translate}}</label>
                                                    <textarea class="form-control" formControlName="mensaje" rows="3"
                                                              [ngClass]="{'is-invalid': tarjeta.get('mensaje')?.invalid && tarjeta.get('mensaje')?.touched}"></textarea>
                                                    <div *ngIf="tarjeta.get('mensaje')?.invalid && tarjeta.get('mensaje')?.touched" 
                                                         class="invalid-feedback">
                                                        {{'Este campo es obligatorio' | translate}}
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label">{{'De:' | translate}}</label>
                                                    <input class="form-control" formControlName="de" 
                                                           [ngClass]="{'is-invalid': tarjeta.get('de')?.invalid && tarjeta.get('de')?.touched}" />
                                                    <div *ngIf="tarjeta.get('de')?.invalid && tarjeta.get('de')?.touched" 
                                                         class="invalid-feedback">
                                                        {{'Este campo es obligatorio' | translate}}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </ng-template>
                    </ngb-panel>

                    <!-- Sección 4: Adiciones -->
                    <ngb-panel id="adicionesPanel" *ngIf="producto?.procesoComercial?.aceptaAdiciones">
                        <ng-template ngbPanelHeader>
                            <div class="d-flex align-items-center justify-content-between w-100">
                                <button ngbPanelToggle class="accordion-button">
                                    <i class="fa fa-plus-circle me-2"></i> {{'ADICIONES' | translate}}
                                </button>
                                <span *ngIf="hasAdicion()" class="badge bg-success me-4 d-flex align-items-center">
                                    <i class="fa fa-check me-1"></i> {{getAdicionesCount()}}
                                </span>
                            </div>
                        </ng-template>
                        <ng-template ngbPanelContent>
                            <div class="container-fluid px-0">
                                <div class="row">
                                    <div class="col-sm-12 col-sm-12 input-group">
                                        <h5 class="m-15">{{'Selecciona uno o varios' | translate}}</h5>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="card">
                                            <div class="card-header col-sm-12 col-sm-12 input-group py-2">
                                                <h5 class="mb-0">{{'Adiciones disponibles' | translate}}</h5>
                                            </div>
                                            <div class="card-body scrollable-div p-2">
                                                <div class="row g-sm-4 g-2" *ngFor="let item of adicionesrows">
                                                    <div class="col-xl-12 col-md-6">
                                                        <div class="prooduct-details-box p-2" style="cursor: pointer;"
                                                            (click)="addAdicionToProduct(item)"
                                                            [ngClass]="{ 'active': item?.seleccionado }">
                                                            <div class="media d-flex align-items-center">

                                                                <img [src]="item.imagenPrincipal[0].urls"
                                                                    [alt]="item.titulo" appImageOptimizer
                                                                    [quality]="0.3" [width]="300" [height]="300"
                                                                    [lazy]="true" loading="lazy" priority
                                                                    class="img-fluid img-60 me-3">
                                                                <div class="media-body">
                                                                    <h6 class="mb-1">{{item.titulo}}</h6>
                                                                    <div class="price">
                                                                        <span class="text-muted me-1">{{'Precio:' |
                                                                            translate}}</span>
                                                                        {{item.precioTotal |
                                                                        currency:'USD':'symbol':'1.2-2'}}
                                                                    </div>
                                                                </div>
                                                                <div class="ms-auto">
                                                                    <i class="fa"
                                                                        [ngClass]="item?.seleccionado ? 'fa-check-circle text-success' : 'fa-plus-circle'"></i>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </ng-template>
                    </ngb-panel>

                    <!-- Sección 5: Cantidad -->
                    <ngb-panel id="cantidadPanel">
                        <ng-template ngbPanelHeader>
                            <div class="d-flex align-items-center justify-content-between w-100">
                                <button ngbPanelToggle class="accordion-button">
                                    <i class="fa fa-shopping-basket me-2"></i> {{'CANTIDAD' | translate}}
                                </button>
                                <span *ngIf="cantidad > 0" class="badge bg-primary me-4 d-flex align-items-center">
                                    {{cantidad}}
                                </span>
                            </div>
                        </ng-template>
                        <ng-template ngbPanelContent>
                            <div class="col-12 p-3">
                                <div class="alert alert-light small mb-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fa fa-info-circle me-2 text-primary"></i>
                                        <strong>{{'Información importante' | translate}}:</strong>
                                    </div>
                                    <ul class="mb-0 ps-4">
                                        <li>{{'Cantidad mínima de venta:' | translate}}
                                            {{producto?.disponibilidad?.cantidadMinVenta}}</li>
                                        <li>{{'Unidades disponibles:' | translate}}
                                            {{producto?.disponibilidad?.cantidadDisponible}}</li>
                                    </ul>
                                </div>

                                <div class="d-flex align-items-center justify-content-center my-3">
                                    <label class="me-3 fw-bold">{{'Cantidad a Comprar' | translate}}</label>
                                    <div class="qty-box">
                                        <div class="input-group">
                                            <button class="btn btn-outline-secondary" type="button"
                                                [disabled]="isStockUnavailable()"
                                                (click)="menosCantidad()">
                                                <i class="fa fa-minus"></i>
                                            </button>
                                            <input #cantidad class="form-control input-number text-center" type="text"
                                                name="cantidad" id="cantidad" readonly style="width: 60px;"
                                                [class.is-invalid]="isStockUnavailable()"
                                                min="{{producto?.disponibilidad?.cantidadMinVenta}}" max="100">
                                            <button class="btn btn-outline-secondary" type="button"
                                                [disabled]="isStockUnavailable() || isQuantityAtMaxStock()"
                                                [title]="getQuantityButtonTooltip()"
                                                (click)="masCantidad()">
                                                <i class="fa fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="alert alert-info small mt-3">
                                    <i class="fa fa-lightbulb-o me-2"></i>
                                    {{'Las elecciones en este producto aplican a todos los productos idénticos en tu
                                    compra. Si deseas productos iguales con elecciones diferentes completa la
                                    configuración para cada uno agrégales al carrito y luego dale en continuar
                                    comprando.' | translate}}
                                </div>
                            </div>
                        </ng-template>
                    </ngb-panel>
                </ngb-accordion>

                <!-- Botón flotante mejorado para agregar al carrito -->
                <div class="cart-floating-container" [class.minimized]="isCartMinimized" [class.expanded]="isCartExpanded">
                    <!-- Botón de minimizar/maximizar -->
                    <button class="minimize-toggle" (click)="toggleMinimizeCart()" *ngIf="!isCartMinimized">
                        <i class="fa fa-chevron-down"></i>
                    </button>
                    
                    <!-- Vista compacta (siempre visible) -->
                    <div class="cart-compact-view">
                        <div class="compact-info" (click)="toggleExpandCart()">
                            <div class="compact-price">
                                {{ (getBigTotalProductWithPreferenceAndAdictions()) * (sumar1() || 1) | currency:'USD':'symbol':'1.0-0' }}
                            </div>
                            <div class="compact-quantity" *ngIf="(sumar1() || 1) > 1">
                                x{{ sumar1() || 1 }}
                            </div>
                        </div>
                        
                        <button class="btn-compact-cart" type="button" (click)="addToCar()" 
                                [disabled]="isCartButtonDisabled()"
                                [class]="getCompactCartButtonClass()">
                            <i class="fa fa-shopping-basket"></i>
                            <span class="d-none d-sm-inline ms-1">
                                {{isEdit ? 'Actualizar' : (isStockUnavailable() ? 'Sin stock' : 'Agregar') | translate}}
                            </span>
                        </button>
                    </div>

                    <!-- Vista expandida (opcional) -->
                    <div class="cart-expanded-view" *ngIf="isCartExpanded && !isCartMinimized">
                        <div class="price-summary-expanded">
                            <div class="price-row">
                                <div class="price-label">{{'Producto:' | translate}}</div>
                                <div class="price-value">{{ precioproducto * (sumar1() || 1) |
                                    currency:'USD':'symbol':'1.0-0' }}</div>
                            </div>
                            <div class="price-row" *ngIf="getTotalPrecioTotalConIva() > 0">
                                <div class="price-label">{{'Adiciones:' | translate}}</div>
                                <div class="price-value">{{ (getBigTotalProductWithPreferenceAndAdictions() -
                                    precioproducto) * (sumar1() || 1) | currency:'USD':'symbol':'1.0-0' }}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Mensajes de error/información -->
                    <div *ngIf="isCartButtonDisabled() && !isCartMinimized" class="cart-error-info">
                        <div class="error-message" *ngIf="isStockUnavailable()">
                            <i class="fa fa-exclamation-triangle"></i>
                            <span>{{'Sin stock' | translate}}</span>
                        </div>
                        <div class="error-message" *ngIf="!isStockUnavailable()">
                            <i class="fa fa-info-circle"></i>
                            <span class="d-none d-sm-inline">{{'Faltan campos' | translate}}</span>
                            <button (click)="showDebugInfo()" class="btn-debug">
                                <i class="fa fa-bug"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Botón para expandir cuando está minimizado -->
                    <button class="expand-button" (click)="toggleMinimizeCart()" *ngIf="isCartMinimized">
                        <i class="fa fa-shopping-basket"></i>
                        <span class="price-badge">{{ (getBigTotalProductWithPreferenceAndAdictions()) * (sumar1() || 1) | currency:'USD':'symbol':'1.0-0' }}</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="card mt-3">
    <div class="row product-page-main">
        <div class="col-sm-12">
            <div class="features-tabs">
                <!-- Añadir una casilla de verificación para mostrar características -->
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" [(ngModel)]="mostrarCaracteristicas"
                        id="showFeaturesCheck">
                    <label class="form-check-label" for="showFeaturesCheck">
                        {{'Mostrar características del producto' | translate}}
                    </label>
                </div>

                <!-- Pestañas de características -->
                <div *ngIf="mostrarCaracteristicas">
                    <ul ngbNav #nav="ngbNav" [(activeId)]="active" class="nav-tabs">
                        <li [ngbNavItem]="1">
                            <a ngbNavLink>
                                {{'Características Adicionales *' | translate}}
                                <i *ngIf="caracteristicasRevisadas" class="fa fa-check feature-check"></i>
                            </a>
                            <ng-template ngbNavContent>
                                <div class="feature-content">
                                    <div class="collapsible-text" [ngClass]="{'collapsed': !mostrarDetallesCompletos}">
                                        <div [innerHTML]="producto?.crearProducto?.descripcion"></div>
                                    </div>
                                    <button *ngIf="producto?.crearProducto?.descripcion?.length > 150"
                                        class="toggle-text-btn my-2" [ngClass]="{'expanded': mostrarDetallesCompletos}"
                                        (click)="mostrarDetallesCompletos = !mostrarDetallesCompletos">
                                        {{mostrarDetallesCompletos ? 'Ver menos' : 'Ver más' | translate}}
                                        <i class="fa"
                                            [ngClass]="mostrarDetallesCompletos ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                    </button>

                                    <div class="d-flex justify-content-end mt-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                [(ngModel)]="caracteristicasRevisadas" id="featureCheck1">
                                            <label class="form-check-label" for="featureCheck1">
                                                {{'Marcar como revisado' | translate}}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </ng-template>
                        </li>
                        <li [ngbNavItem]="2">
                            <a ngbNavLink>
                                {{'Garantías propias del producto*' | translate}}
                                <i *ngIf="garantiasRevisadas" class="fa fa-check feature-check"></i>
                            </a>
                            <ng-template ngbNavContent>
                                <div class="feature-content">
                                    <p class="mb-0">{{'Lorem Ipsum is simply dummy text of the printing and typesetting
                                        industry. Lorem Ipsum has been the industry\'s standard dummy text ever since
                                        the 1500s, when an unknown printer took a galley of type and scrambled it to
                                        make a type specimen book.' | translate}}</p>

                                    <div class="d-flex justify-content-end mt-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                [(ngModel)]="garantiasRevisadas" id="featureCheck2">
                                            <label class="form-check-label" for="featureCheck2">
                                                {{'Marcar como revisado' | translate}}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </ng-template>
                        </li>
                        <li [ngbNavItem]="3">
                            <a ngbNavLink>
                                {{'Condiciones/Restricciones*' | translate}}
                                <i *ngIf="condicionesRevisadas" class="fa fa-check feature-check"></i>
                            </a>
                            <ng-template ngbNavContent>
                                <div class="feature-content">
                                    <p class="mb-0">{{'Lorem Ipsum is simply dummy text of the printing and typesetting
                                        industry. Lorem Ipsum has been the industry\'s standard dummy text ever since
                                        the 1500s, when an unknown printer took a galley of type and scrambled it to
                                        make a type specimen book.' | translate}}</p>

                                    <div class="d-flex justify-content-end mt-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox"
                                                [(ngModel)]="condicionesRevisadas" id="featureCheck3">
                                            <label class="form-check-label" for="featureCheck3">
                                                {{'Marcar como revisado' | translate}}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </ng-template>
                        </li>
                    </ul>
                    <div [ngbNavOutlet]="nav" class="mb-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>