<!-- <app-breadcrumb [title]="'Lista pedidos' | translate" [items]="['Gestor de Pedidos' | translate]" [active_item]="'Pedidos' | translate"></app-breadcrumb> -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12 p-2">
            <br />
            <div class="card">

                <div class="loader-box" *ngIf="cargando">
                    <div class="loader-8"></div>
                </div>

                <!-- Header Standar -->
                <div class="row col-12 m-2">
                    <div class="col-6">
                        <p class="text-left fc-secondary fs-24 fw-bold m-0 p-0">{{ "Pedidos" | translate }}</p>
                        <p class="text-left text-muted fs-18 m-0 p-0">{{ "Listado de pedidos" | translate }}</p>
                    </div>
                </div>
<br>

                <div class="col-sm-12">
                    <div class="">
                        <div class="">
                            <div class="p-3">
                                <p-table #dt1 [value]="orders" dataKey="nroPedido" [rows]="50"
                                    [showCurrentPageReport]="true" [rowsPerPageOptions]="[5,10,25,50]"
                                    [loading]="loading" [reorderableColumns]="true" [scrollable]="true"
                                    [paginator]="true"
                                    currentPageReportTemplate="{{'Mostrando {first} a {last} de {totalRecords} pedidos' | translate}}"
                                    [globalFilterFields]="['nroPedido','documento','validacion','formaDePago','estadosPago']"
                                    styleClass="p-datatable p-datatable-gridlines p-datatable-striped"
                                    [tableStyle]="{ 'min-width': '20rem', 'padding':'5px' }"
                                    style="font-size: 0.7em; table-layout: auto;">
                                    <!-- CAPTION: Filtros modernos y selector de columnas -->
                                    <ng-template pTemplate="caption">
                                        <div class="modern-filters-container">
                                            <!-- Header compacto y colapsable -->
                                            <div class="filters-compact-header">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="filter-toggle-section" style="cursor: pointer;" (click)="toggleFilters()">
                                                        <i class="pi me-2 text-primary" [ngClass]="showFilters ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
                                                        <i class="pi pi-filter me-2 text-primary"></i>
                                                        <span class="fw-bold text-dark">{{ 'Filtros' | translate }}</span>
                                                        <span class="filter-count ms-2" *ngIf="hasActiveFilters()">
                                                            <span class="badge bg-primary">{{ getActiveFiltersCount() }}</span>
                                                        </span>
                                                    </div>
                                                    <div class="quick-actions d-flex align-items-center">
                                                        <!-- Filtros rápidos en header -->
                                                        <div class="header-quick-filters d-flex align-items-center">
                                                            <span class="shortcuts-label me-2">{{ 'Rápidos:' | translate }}</span>
                                                            <div class="shortcuts-group d-flex">
                                                                <button type="button"
                                                                    class="btn btn-sm shortcut-btn"
                                                                    [ngClass]="{'btn-primary': quickFilters.estadoPago === 'Pendiente', 'btn-outline-secondary': quickFilters.estadoPago !== 'Pendiente'}"
                                                                    (click)="setQuickFilter('estadoPago', quickFilters.estadoPago === 'Pendiente' ? 'all' : 'Pendiente')"
                                                                    pTooltip="{{ 'Pendientes' | translate }}">
                                                                    <i class="pi pi-clock"></i>
                                                                </button>
                                                                <button type="button"
                                                                    class="btn btn-sm shortcut-btn"
                                                                    [ngClass]="{'btn-success': quickFilters.estadoPago === 'Aprobado', 'btn-outline-secondary': quickFilters.estadoPago !== 'Aprobado'}"
                                                                    (click)="setQuickFilter('estadoPago', quickFilters.estadoPago === 'Aprobado' ? 'all' : 'Aprobado')"
                                                                    pTooltip="{{ 'Aprobados' | translate }}">
                                                                    <i class="pi pi-check"></i>
                                                                </button>
                                                                <button type="button"
                                                                    class="btn btn-sm btn-outline-secondary shortcut-btn"
                                                                    (click)="setDateRange('today')"
                                                                    pTooltip="{{ 'Filtrar por hoy' | translate }}">
                                                                    <i class="pi pi-calendar"></i>
                                                                </button>
                                                            </div>
                                                        </div>

                                                        <div class="vertical-separator mx-3"></div>

                                                        <div class="action-buttons d-flex align-items-center">
                                                            <span class="actions-label me-2">{{ 'Acciones:' | translate }}</span>
                                                            <div class="actions-group d-flex">
                                                                <button pButton type="button"
                                                                    icon="pi pi-search"
                                                                    class="p-button-sm p-button-primary action-btn"
                                                                    pTooltip="{{ 'Filtrar' | translate }}"
                                                                    (click)="refrescar(dt1)">
                                                                </button>
                                                                <button pButton type="button"
                                                                    icon="pi pi-refresh"
                                                                    class="p-button-sm p-button-text action-btn"
                                                                    pTooltip="{{ 'Limpiar filtros' | translate }}"
                                                                    (click)="clearAllFilters()">
                                                                </button>
                                                                <button pButton type="button"
                                                                    icon="pi pi-file-excel"
                                                                    class="p-button-sm p-button-success action-btn"
                                                                    [disabled]="orders.length == 0"
                                                                    pTooltip="{{ 'Exportar Excel' | translate }}"
                                                                    (click)="exportarExcel()">
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Contenido expandible de filtros -->
                                            <div class="filters-expanded-content mt-3" [ngClass]="{'d-none': !showFilters}">

                                                <!-- Indicadores de filtros activos en la parte superior -->
                                                <div class="active-filters-summary mb-3" *ngIf="hasActiveFilters()">
                                                    <div class="d-flex align-items-center flex-wrap gap-2">
                                                        <span class="filter-indicator-label">
                                                            <i class="pi pi-filter me-1"></i>
                                                            {{ 'Filtros activos:' | translate }}
                                                        </span>
                                                        <div class="filter-tags d-flex flex-wrap gap-1">
                                                            <span class="filter-tag" *ngIf="fechaInicial">
                                                                {{ 'Desde: ' + (fechaInicial | date:'dd/MM/yyyy') }}
                                                                <i class="pi pi-times ms-1" (click)="clearDateFilter('inicial')"></i>
                                                            </span>
                                                            <span class="filter-tag" *ngIf="fechaFinal">
                                                                {{ 'Hasta: ' + (fechaFinal | date:'dd/MM/yyyy') }}
                                                                <i class="pi pi-times ms-1" (click)="clearDateFilter('final')"></i>
                                                            </span>
                                                            <span class="filter-tag" *ngIf="nroPedido">
                                                                {{ 'Pedido: ' + (nroPedido.nroPedido || nroPedido) }}
                                                                <i class="pi pi-times ms-1" (click)="clearSearchFilter()"></i>
                                                            </span>
                                                            <span class="filter-tag status-filter-tag" *ngIf="quickFilters.estadoPago !== 'all'">
                                                                {{ 'Estado Pago: ' + quickFilters.estadoPago }}
                                                                <i class="pi pi-times ms-1" (click)="clearQuickFilter('estadoPago')"></i>
                                                            </span>
                                                            <span class="filter-tag status-filter-tag" *ngIf="quickFilters.estadoProceso !== 'all'">
                                                                {{ 'Estado Proceso: ' + quickFilters.estadoProceso }}
                                                                <i class="pi pi-times ms-1" (click)="clearQuickFilter('estadoProceso')"></i>
                                                            </span>
                                                            <button type="button"
                                                                class="btn btn-outline-secondary btn-sm ms-2"
                                                                (click)="clearAllFilters()">
                                                                <i class="pi pi-times me-1"></i>
                                                                {{ 'Limpiar todo' | translate }}
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Configuración de columnas colapsible -->
                                                <div class="column-config-section mb-4">
                                                    <div class="config-header" style="cursor: pointer;" (click)="toggleColumnConfig()">
                                                        <i class="pi" [ngClass]="showColumnConfig ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
                                                        <span class="ms-2 fw-medium">{{ 'Configurar Columnas' | translate }}</span>
                                                    </div>
                                                    <div class="config-content mt-2" [ngClass]="{'d-none': !showColumnConfig}">
                                                        <div class="d-flex align-items-center flex-wrap">
                                                            <p-multiSelect
                                                                [options]="displayedColumns"
                                                                [(ngModel)]="selectedColumns"
                                                                optionLabel="header"
                                                                defaultLabel="{{ 'Seleccionar columnas' | translate }}"
                                                                selectedItemsLabel="{0} columnas seleccionadas"
                                                                styleClass="me-2 column-selector"
                                                                [style]="{'min-width': '250px'}"
                                                                (onChange)="onColumnSelectionChange()">
                                                            </p-multiSelect>
                                                            <button pButton type="button"
                                                                icon="pi pi-undo"
                                                                label="{{ 'Restaurar' | translate }}"
                                                                class="p-button-outlined p-button-sm"
                                                                pTooltip="{{ 'Restaurar columnas por defecto' | translate }}"
                                                                (click)="resetColumnConfig()">
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                            <!-- Filtros principales -->
                                            <div class="main-filters-grid">
                                                <!-- Grupo de fechas -->
                                                <div class="filter-group date-filters">
                                                    <div class="filter-group-header">
                                                        <i class="pi pi-calendar me-2 text-primary"></i>
                                                        <span class="fw-medium">{{ 'Rango de Fechas' | translate }}</span>
                                                    </div>
                                                    <div class="filter-group-content">
                                                        <div class="date-range-container">
                                                            <div class="date-input-wrapper">
                                                                <label class="filter-label">{{ 'Desde' | translate }}</label>
                                                                <input type="date"
                                                                    class="form-control modern-date-input"
                                                                    [(ngModel)]="fechaInicial"
                                                                    (change)="firstEvent($event.target.value)" />
                                                            </div>
                                                            <div class="date-separator">
                                                                <i class="pi pi-arrow-right"></i>
                                                            </div>
                                                            <div class="date-input-wrapper">
                                                                <label class="filter-label">{{ 'Hasta' | translate }}</label>
                                                                <input type="date"
                                                                    class="form-control modern-date-input"
                                                                    [(ngModel)]="fechaFinal"
                                                                    (change)="secondEvent($event.target.value)" />
                                                            </div>
                                                        </div>
                                                        <!-- Filtros rápidos de fecha -->
                                                        <div class="quick-date-filters mt-2">
                                                            <button type="button"
                                                                class="btn btn-outline-primary btn-sm me-2"
                                                                (click)="filtrarParaHoy()">
                                                                <i class="pi pi-sun me-1"></i>
                                                                {{ 'Hoy' | translate }}
                                                            </button>
                                                            <button type="button"
                                                                class="btn btn-outline-primary btn-sm me-2"
                                                                (click)="filtrarParaManana()">
                                                                <i class="pi pi-forward me-1"></i>
                                                                {{ 'Mañana' | translate }}
                                                            </button>
                                                        </div>
                                                        <!-- Rangos predefinidos -->
                                                        <div class="predefined-ranges mt-2">
                                                            <small class="text-muted d-block mb-2">{{ 'Rangos predefinidos:' | translate }}</small>
                                                            <div class="d-flex gap-1 flex-wrap">
                                                                <button type="button"
                                                                    class="btn btn-outline-secondary btn-xs"
                                                                    (click)="setDateRange('today')">
                                                                    {{ 'Hoy' | translate }}
                                                                </button>
                                                                <button type="button"
                                                                    class="btn btn-outline-secondary btn-xs"
                                                                    (click)="setDateRange('week')">
                                                                    {{ 'Esta semana' | translate }}
                                                                </button>
                                                                <button type="button"
                                                                    class="btn btn-outline-secondary btn-xs"
                                                                    (click)="setDateRange('month')">
                                                                    {{ 'Este mes' | translate }}
                                                                </button>
                                                                <button type="button"
                                                                    class="btn btn-outline-secondary btn-xs"
                                                                    (click)="setDateRange('lastWeek')">
                                                                    {{ 'Semana pasada' | translate }}
                                                                </button>
                                                                <button type="button"
                                                                    class="btn btn-outline-secondary btn-xs"
                                                                    (click)="setDateRange('lastMonth')">
                                                                    {{ 'Mes pasado' | translate }}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Filtros rápidos por estado -->
                                                <div class="filter-group status-filters">
                                                    <div class="filter-group-header">
                                                        <i class="pi pi-flag me-2 text-primary"></i>
                                                        <span class="fw-medium">{{ 'Filtros Rápidos' | translate }}</span>
                                                    </div>
                                                    <div class="filter-group-content">
                                                        <div class="status-filter-section">
                                                            <label class="filter-label">{{ 'Estado de Pago' | translate }}</label>
                                                            <div class="status-chips mb-3">
                                                                <button type="button"
                                                                    class="status-chip"
                                                                    [ngClass]="{'active': quickFilters.estadoPago === 'all'}"
                                                                    (click)="setQuickFilter('estadoPago', 'all')">
                                                                    <i class="pi pi-list me-1"></i>
                                                                    {{ 'Todos' | translate }}
                                                                </button>
                                                                <button type="button"
                                                                    class="status-chip status-success"
                                                                    [ngClass]="{'active': quickFilters.estadoPago === 'Aprobado'}"
                                                                    (click)="setQuickFilter('estadoPago', 'Aprobado')">
                                                                    <i class="pi pi-check me-1"></i>
                                                                    {{ 'Aprobados' | translate }}
                                                                </button>
                                                                <button type="button"
                                                                    class="status-chip status-warning"
                                                                    [ngClass]="{'active': quickFilters.estadoPago === 'Pendiente'}"
                                                                    (click)="setQuickFilter('estadoPago', 'Pendiente')">
                                                                    <i class="pi pi-clock me-1"></i>
                                                                    {{ 'Pendientes' | translate }}
                                                                </button>
                                                                <button type="button"
                                                                    class="status-chip status-info"
                                                                    [ngClass]="{'active': quickFilters.estadoPago === 'PreAprobado'}"
                                                                    (click)="setQuickFilter('estadoPago', 'PreAprobado')">
                                                                    <i class="pi pi-eye me-1"></i>
                                                                    {{ 'Pre-aprobados' | translate }}
                                                                </button>
                                                            </div>
                                                        </div>

                                                        <div class="status-filter-section">
                                                            <label class="filter-label">{{ 'Estado de Proceso' | translate }}</label>
                                                            <div class="status-chips">
                                                                <button type="button"
                                                                    class="status-chip"
                                                                    [ngClass]="{'active': quickFilters.estadoProceso === 'all'}"
                                                                    (click)="setQuickFilter('estadoProceso', 'all')">
                                                                    <i class="pi pi-list me-1"></i>
                                                                    {{ 'Todos' | translate }}
                                                                </button>
                                                                <button type="button"
                                                                    class="status-chip status-secondary"
                                                                    [ngClass]="{'active': quickFilters.estadoProceso === 'SinProducir'}"
                                                                    (click)="setQuickFilter('estadoProceso', 'SinProducir')">
                                                                    <i class="pi pi-circle me-1"></i>
                                                                    {{ 'Sin Producir' | translate }}
                                                                </button>
                                                                <button type="button"
                                                                    class="status-chip status-info"
                                                                    [ngClass]="{'active': quickFilters.estadoProceso === 'Producido'}"
                                                                    (click)="setQuickFilter('estadoProceso', 'Producido')">
                                                                    <i class="pi pi-cog me-1"></i>
                                                                    {{ 'Producido' | translate }}
                                                                </button>
                                                                <button type="button"
                                                                    class="status-chip status-success"
                                                                    [ngClass]="{'active': quickFilters.estadoProceso === 'Entregado'}"
                                                                    (click)="setQuickFilter('estadoProceso', 'Entregado')">
                                                                    <i class="pi pi-check-circle me-1"></i>
                                                                    {{ 'Entregado' | translate }}
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Búsqueda de pedidos -->
                                                <div class="filter-group search-filters">
                                                    <div class="filter-group-header">
                                                        <i class="pi pi-search me-2 text-primary"></i>
                                                        <span class="fw-medium">{{ 'Búsqueda' | translate }}</span>
                                                    </div>
                                                    <div class="filter-group-content">
                                                        <div class="search-input-wrapper">
                                                            <label class="filter-label">{{ 'Número de Pedido' | translate }}</label>
                                                            <p-autoComplete
                                                                [(ngModel)]="nroPedido"
                                                                [suggestions]="filteredOrderNumbers"
                                                                (completeMethod)="filtroGlobal($event)"
                                                                field="nroPedido"
                                                                placeholder="{{ 'Buscar por número...' | translate }}"
                                                                (onSelect)="onOrderSelect($event)"
                                                                styleClass="modern-autocomplete w-100">
                                                                <ng-template let-item pTemplate="item">
                                                                    <div class="suggestion-item">
                                                                        <span class="fw-bold">#{{ item.nroPedido }}</span>
                                                                        <small class="text-muted ms-2">{{ item.cliente?.nombres_completos }}</small>
                                                                    </div>
                                                                </ng-template>
                                                            </p-autoComplete>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Acciones -->
                                                <div class="filter-group action-filters">
                                                    <div class="filter-group-header">
                                                        <i class="pi pi-cog me-2 text-primary"></i>
                                                        <span class="fw-medium">{{ 'Acciones' | translate }}</span>
                                                    </div>
                                                    <div class="filter-group-content">
                                                        <div class="action-buttons">
                                                            <button pButton
                                                                type="button"
                                                                icon="pi pi-search"
                                                                label="{{ 'Filtrar' | translate }}"
                                                                class="p-button-primary action-btn"
                                                                (click)="refrescar(dt1)">
                                                            </button>
                                                            <button pButton
                                                                type="button"
                                                                icon="pi pi-file-excel"
                                                                label="{{ 'Exportar' | translate }}"
                                                                class="p-button-success action-btn"
                                                                [disabled]="orders.length == 0"
                                                                (click)="exportarExcel()">
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            </div> <!-- Cierre de filters-expanded-content -->
                                        </div> <!-- Cierre de modern-filters-container -->
                                    </ng-template>

                                    <!-- HEADER: Dos filas (títulos y filtros) -->
                                    <ng-template pTemplate="header">
                                        <!-- <tr>
                                    <th colspan="8" style="text-align: center;">Título de la Tabla</th>
                                </tr> -->
                                        <!-- Fila de encabezados y filtros por columna -->
                                        <tr style="font-size: 0.8em;">
                                            <!-- Columna Detalles -->
                                            <th *ngIf="isColumnVisible('detalles')" style="width: 2.5rem; text-align: center; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex justify-content-center">
                                                    {{'Detalles' | translate}}
                                                </div>
                                            </th>

                                            <!-- Columna # Pedido -->
                                            <th *ngIf="isColumnVisible('nroPedido')" style="width: 8rem; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex text-center align-items-center">
                                                    {{'# Pedido' | translate}}
                                                    <p-columnFilter type="text" field="nroPedido" display="menu"
                                                        placeholder="{{'Buscar número de pedido' | translate}}"
                                                        matchMode="contains" [showMenu]="true">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Fecha Entrega -->
                                            <th *ngIf="isColumnVisible('fechaEntrega')" style="width: 7rem; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Fecha entrega' | translate}}
                                                    <p-columnFilter [matchMode]="'customDate'" field="fechaEntrega"
                                                        type="date" display="menu" [showMatchModes]="false"
                                                        [showOperator]="false" [showAddButton]="false">
                                                        <ng-template pTemplate="filter" let-value
                                                            let-filter="filterCallback">
                                                            <p-calendar (onSelect)="filter($event)"
                                                                dateFormat="yy-mm-dd">
                                                            </p-calendar>
                                                        </ng-template>
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Opciones -->
                                            <th *ngIf="isColumnVisible('opciones')"
                                                style="width: 5rem; text-align: center; white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex justify-content-center">
                                                    {{'Opciones' | translate}}
                                                </div>
                                            </th>

                                            <!-- Columna Estado de Pago -->
                                            <th *ngIf="isColumnVisible('estadoPago')" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex text-center align-items-center">
                                                    {{'Estado de Pago' | translate}}
                                                    <p-columnFilter field="estadoPago" matchMode="equals"
                                                        [showMenu]="true" display="menu">
                                                        <ng-template pTemplate="filter" let-value
                                                            let-filter="filterCallback">
                                                            <p-multiSelect [ngModel]="value" [options]="estadosPago"
                                                                placeholder="{{'Seleccione' | translate}}"
                                                                (onChange)="filter($event.value)"
                                                                style="width: 100%; font-size: 0.8em;">
                                                            </p-multiSelect>
                                                        </ng-template>
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Estado de Proceso -->
                                            <th *ngIf="isColumnVisible('estadoProceso')" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Estado de Proceso' | translate}}
                                                    <p-columnFilter field="estadoProceso" matchMode="equals"
                                                        [showMenu]="true" display="menu">
                                                        <ng-template pTemplate="filter" let-value
                                                            let-filter="filterCallback">
                                                            <p-multiSelect [ngModel]="value" [options]="estadosProcesos"
                                                                placeholder="{{'Seleccione' | translate}}"
                                                                (onChange)="filter($event.value)"
                                                                style="width: 100%; font-size: 0.8em;">
                                                            </p-multiSelect>
                                                        </ng-template>
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Validación -->
                                            <th *ngIf="isColumnVisible('validacion') && !isFromProduction" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Validación' | translate}}
                                                    <p-columnFilter field="validacion" matchMode="equals"
                                                        [showMenu]="true" display="menu">
                                                        <ng-template pTemplate="filter" let-value
                                                            let-filter="filterCallback">
                                                            <p-multiSelect [ngModel]="value" [options]="validaciones"
                                                                optionLabel="nombre" optionValue="value"
                                                                placeholder="{{'Seleccione' | translate}}"
                                                                (onChange)="filter($event.value)"
                                                                style="width: 100%; font-size: 0.8em;">
                                                            </p-multiSelect>
                                                        </ng-template>
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Cliente -->
                                            <th *ngIf="isColumnVisible('cliente') && !isFromProduction" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Cliente' | translate}}
                                                    <p-columnFilter type="text" field="cliente.nombres_completos"
                                                        matchMode="contains" placeholder="{{'Cliente' | translate}}"
                                                        [showMenu]="true" display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Valor Bruto -->
                                            <th *ngIf="isColumnVisible('valorBruto') && !isFromProduction" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Valor Bruto' | translate}}
                                                    <p-columnFilter type="numeric" field="totalPedidoSinDescuento"
                                                        matchMode="contains" placeholder="{{'V. Bruto' | translate}}"
                                                        [showMenu]="true" display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Descuento -->
                                            <th *ngIf="isColumnVisible('descuento') && !isFromProduction" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Descuento' | translate}}
                                                    <p-columnFilter type="numeric" field="totalDescuento"
                                                        matchMode="contains" placeholder="{{'Desc.' | translate}}"
                                                        [showMenu]="true" display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Domicilio -->
                                            <th *ngIf="isColumnVisible('domicilio') && !isFromProduction" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Domicilio' | translate}}
                                                    <p-columnFilter type="numeric" field="totalEnvio"
                                                        matchMode="contains" placeholder="{{'Domicilio' | translate}}"
                                                        [showMenu]="true" display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Subtotal -->
                                            <th *ngIf="isColumnVisible('subtotal') && !isFromProduction" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Subtotal' | translate}}
                                                    <p-columnFilter type="numeric" field="subtotal" matchMode="contains"
                                                        placeholder="{{'Subt.' | translate}}" [showMenu]="true"
                                                        display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna IVA -->
                                            <th *ngIf="isColumnVisible('iva') && !isFromProduction" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'IVA' | translate}}
                                                    <p-columnFilter type="numeric" field="totalImpuesto"
                                                        matchMode="contains" placeholder="{{'IVA' | translate}}"
                                                        [showMenu]="true" display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Total -->
                                            <th *ngIf="isColumnVisible('total') && !isFromProduction" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Total' | translate}}
                                                    <p-columnFilter type="numeric" field="totalPedididoConDescuento"
                                                        matchMode="contains" placeholder="{{'Total' | translate}}"
                                                        [showMenu]="true" display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Anticipo -->
                                            <th *ngIf="isColumnVisible('anticipo') && !isFromProduction" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Anticipo' | translate}}
                                                    <p-columnFilter type="numeric" field="anticipo" matchMode="contains"
                                                        placeholder="{{'Anticipo' | translate}}" [showMenu]="true"
                                                        display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Falta por Pagar -->
                                            <th *ngIf="isColumnVisible('faltaPorPagar') && !isFromProduction" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Falta por Pagar' | translate}}
                                                    <p-columnFilter type="numeric" field="faltaPorPagar"
                                                        matchMode="contains" placeholder="{{'Falta' | translate}}"
                                                        [showMenu]="true" display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Fecha de compra -->
                                            <th *ngIf="isColumnVisible('fechaCreacion')" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Fecha de compra' | translate}}
                                                    <p-columnFilter [matchMode]="'customDate'" field="fechaCreacion"
                                                        type="date" display="menu" [showMatchModes]="false"
                                                        [showOperator]="false" [showAddButton]="false">
                                                        <ng-template pTemplate="filter" let-value
                                                            let-filter="filterCallback">
                                                            <p-calendar (onSelect)="filter($event)"
                                                                dateFormat="yy-mm-dd">
                                                            </p-calendar>
                                                        </ng-template>
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Ciudad -->
                                            <th *ngIf="isColumnVisible('ciudad') && !isFromProduction" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Ciudad' | translate}}
                                                    <p-columnFilter type="text" field="envio.ciudad"
                                                        matchMode="contains" placeholder="{{'Ciudad' | translate}}"
                                                        [showMenu]="true" display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Zona de Entrega -->
                                            <th *ngIf="isColumnVisible('zonaCobro') && !isFromProduction" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Zona de Entrega' | translate}}
                                                    <p-columnFilter type="text" field="envio.zonaCobro"
                                                        matchMode="contains" placeholder="{{'Zona' | translate}}"
                                                        [showMenu]="true" display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Forma de Entrega -->
                                            <th *ngIf="isColumnVisible('formaEntrega')" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Forma de Entrega' | translate}}
                                                    <p-columnFilter type="text" field="formaEntrega"
                                                        matchMode="contains" placeholder="{{'Entrega' | translate}}"
                                                        [showMenu]="true" display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Horario de Entrega -->
                                            <th *ngIf="isColumnVisible('horarioEntrega')" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Horario de Entrega' | translate}}
                                                    <p-columnFilter type="text" field="horarioEntrega"
                                                        matchMode="contains" placeholder="{{'Horario' | translate}}"
                                                        [showMenu]="true" display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>

                                            <!-- Columna Vendedor -->
                                            <th *ngIf="isColumnVisible('vendedor') && !isFromProduction" style="white-space: nowrap; text-overflow: ellipsis; overflow: hidden;">
                                                <div class="flex align-items-center">
                                                    {{'Vendedor' | translate}}
                                                    <p-columnFilter type="text" field="asesorAsignado.name"
                                                        matchMode="contains" placeholder="{{'Vendedor' | translate}}"
                                                        [showMenu]="true" display="menu">
                                                    </p-columnFilter>
                                                </div>
                                            </th>
                                        </tr>
                                    </ng-template>

                                    <!-- CUERPO: filas y row expansion -->
                                    <ng-template pTemplate="body" let-pedido let-expanded="expanded">
                                        <tr class="p-table-tr-td" style="font-size: 0.85em;">
                                            <!-- Columna Detalles -->
                                            <td *ngIf="isColumnVisible('detalles')" style="width: 2.0rem; text-align: center; vertical-align: middle; padding: 0.5rem 0.25rem;">
                                                <button type="button" pButton pRipple [pRowToggler]="pedido"
                                                    class="p-button-text p-button-rounded p-button-plain p-button-sm"
                                                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                                            </td>

                                            <!-- Columna # Pedido -->
                                            <td *ngIf="isColumnVisible('nroPedido')" class="pedido-number-cell" style="width: 8rem;">
                                                <span class="pedido-number">{{ pedido.nroPedido }}</span>
                                            </td>

                                            <!-- Columna Fecha Entrega -->
                                            <td *ngIf="isColumnVisible('fechaEntrega')" class="fecha-cell" style="width: 7rem;">
                                                {{ convertFechaEntregaString(pedido.carrito[0]?.configuracion?.datosEntrega?.fechaEntrega) }}
                                            </td>

                                            <!-- Columna Opciones -->
                                            <td *ngIf="isColumnVisible('opciones')" class="text-center options-cell" style="width: 5rem; padding: 0.5rem 0.25rem;">
                                                <button class="btn btn-outline-primary btn-sm" 
                                                        type="button" 
                                                        (click)="openOptionsModal(pedido)"
                                                        [title]="'Opciones del pedido' | translate">
                                                    <i class="pi pi-cog"></i>
                                                </button>
                                            </td>

                                            <!-- Columna Estado de Pago -->
                                            <td *ngIf="isColumnVisible('estadoPago')" class="estado-cell text-center">
                                                <span class="modern-badge" [ngClass]="{
                                                    'badge-warning': pedido?.estadoPago === 'Pendiente' || pedido?.estadoPago === 'Pospendiente',
                                                    'badge-success': pedido?.estadoPago === 'Aprobado',
                                                    'badge-info': pedido?.estadoPago === 'PreAprobado',
                                                    'badge-danger': pedido?.estadoPago === 'Rechazado' || pedido?.estadoPago === 'Cancelado' || pedido?.estadoPago === 'Precancelado'
                                                }">
                                                    <i class="status-icon pi" [ngClass]="{
                                                        'pi-clock': pedido?.estadoPago === 'Pendiente' || pedido?.estadoPago === 'Pospendiente',
                                                        'pi-check-circle': pedido?.estadoPago === 'Aprobado',
                                                        'pi-eye': pedido?.estadoPago === 'PreAprobado',
                                                        'pi-times-circle': pedido?.estadoPago === 'Rechazado' || pedido?.estadoPago === 'Cancelado' || pedido?.estadoPago === 'Precancelado'
                                                    }"></i>
                                                    {{ pedido?.estadoPago }}
                                                </span>
                                            </td>

                                            <!-- Columna Estado de Proceso -->
                                            <td *ngIf="isColumnVisible('estadoProceso')" class="estado-cell text-center">
                                                <span class="modern-badge" [ngClass]="{
                                                    'badge-secondary': pedido?.estadoProceso === 'SinProducir',
                                                    'badge-info': pedido?.estadoProceso === 'Producido' || pedido?.estadoProceso === 'ProducidoTotalmente' || pedido?.estadoProceso === 'ProducidoParcialmente',
                                                    'badge-primary': pedido?.estadoProceso === 'Empacado',
                                                    'badge-warning': pedido?.estadoProceso === 'Despachado' || pedido?.estadoProceso === 'ParaDespachar',
                                                    'badge-success': pedido?.estadoProceso === 'Entregado',
                                                    'badge-danger': pedido?.estadoProceso === 'Rechazado'
                                                }">
                                                    <i class="status-icon pi" [ngClass]="{
                                                        'pi-circle': pedido?.estadoProceso === 'SinProducir',
                                                        'pi-cog': pedido?.estadoProceso === 'Producido' || pedido?.estadoProceso === 'ProducidoTotalmente' || pedido?.estadoProceso === 'ProducidoParcialmente',
                                                        'pi-box': pedido?.estadoProceso === 'Empacado',
                                                        'pi-truck': pedido?.estadoProceso === 'Despachado' || pedido?.estadoProceso === 'ParaDespachar',
                                                        'pi-check-circle': pedido?.estadoProceso === 'Entregado',
                                                        'pi-times-circle': pedido?.estadoProceso === 'Rechazado'
                                                    }"></i>
                                                    {{ pedido?.estadoProceso }}
                                                </span>
                                            </td>

                                            <!-- Columna Validación -->
                                            <td *ngIf="isColumnVisible('validacion') && !isFromProduction" class="estado-cell text-center">
                                                <span class="modern-badge validation-badge" [ngClass]="{
                                                    'badge-success': pedido.validacion == true,
                                                    'badge-secondary': pedido.validacion == false
                                                }">
                                                    <i class="status-icon pi" [ngClass]="{
                                                        'pi-check': pedido.validacion == true,
                                                        'pi-minus': pedido.validacion == false
                                                    }"></i>
                                                    {{ pedido.validacion == true ? 'Sí' : 'No' }}
                                                </span>
                                            </td>

                                            <!-- Columna Cliente -->
                                            <td *ngIf="isColumnVisible('cliente') && !isFromProduction" class="text-nowrap cliente-cell">
                                                <span class="cliente-info" (click)="editDatosClientes(clientesModal,pedido)">
                                                    {{ pedido.cliente.nombres_completos }}
                                                    {{ pedido.cliente.apellidos_completos }}
                                                </span>
                                            </td>

                                            <!-- Columna Valor Bruto -->
                                            <td *ngIf="isColumnVisible('valorBruto') && !isFromProduction" class="td-money text-nowrap money-cell">
                                                {{ pedido?.totalPedidoSinDescuento | currency }}
                                            </td>

                                            <!-- Columna Descuento -->
                                            <td *ngIf="isColumnVisible('descuento') && !isFromProduction" class="td-money text-nowrap">
                                                {{ pedido?.totalDescuento | currency }}
                                            </td>

                                            <!-- Columna Domicilio -->
                                            <td *ngIf="isColumnVisible('domicilio') && !isFromProduction" class="td-money text-nowrap">
                                                {{ pedido?.totalEnvio | currency }}
                                            </td>

                                            <!-- Columna Subtotal -->
                                            <td *ngIf="isColumnVisible('subtotal') && !isFromProduction" class="td-money text-nowrap">
                                                {{ pedido?.subtotal | currency }}
                                            </td>

                                            <!-- Columna IVA -->
                                            <td *ngIf="isColumnVisible('iva') && !isFromProduction" class="td-money text-nowrap">
                                                {{ pedido?.totalImpuesto | currency }}
                                            </td>

                                            <!-- Columna Total -->
                                            <td *ngIf="isColumnVisible('total') && !isFromProduction" class="td-money text-nowrap money-cell total-cell">
                                                <span class="total-amount">{{ pedido.totalPedididoConDescuento | currency }}</span>
                                            </td>

                                            <!-- Columna Anticipo -->
                                            <td *ngIf="isColumnVisible('anticipo') && !isFromProduction" class="td-money text-nowrap">
                                                {{ pedido?.anticipo | currency }}
                                            </td>

                                            <!-- Columna Falta por Pagar -->
                                            <td *ngIf="isColumnVisible('faltaPorPagar') && !isFromProduction" class="td-money text-nowrap">
                                                {{ pedido?.faltaPorPagar | currency }}
                                            </td>

                                            <!-- Columna Fecha de compra -->
                                            <td *ngIf="isColumnVisible('fechaCreacion')" class="text-nowrap fecha-cell">
                                                {{ pedido.fechaCreacion | date: 'dd/MM/yyyy' }}
                                            </td>

                                            <!-- Columna Ciudad -->
                                            <td *ngIf="isColumnVisible('ciudad') && !isFromProduction" class="text-nowrap">{{ pedido.envio?.ciudad }}</td>

                                            <!-- Columna Zona de Entrega -->
                                            <td *ngIf="isColumnVisible('zonaCobro') && !isFromProduction" class="text-nowrap">{{ pedido.envio?.zonaCobro }}</td>

                                            <!-- Columna Forma de Entrega -->
                                            <td *ngIf="isColumnVisible('formaEntrega')" class="text-nowrap">{{ pedido.carrito[0]?.configuracion?.datosEntrega?.formaEntrega }}</td>

                                            <!-- Columna Horario de Entrega -->
                                            <td *ngIf="isColumnVisible('horarioEntrega')" class="text-nowrap">{{ pedido.carrito[0]?.configuracion?.datosEntrega?.horarioEntrega }}</td>

                                            <!-- Columna Vendedor -->
                                            <td *ngIf="isColumnVisible('vendedor') && !isFromProduction" class="text-nowrap">
                                                {{ pedido.asesorAsignado?.name }}
                                            </td>
                                        </tr>
                                    </ng-template>

                                    <!-- EXPANSIÓN DE FILAS -->
                                    <ng-template pTemplate="rowexpansion" let-pedido>
                                        <tr style="font-size: 0.85em;">
                                            <td [attr.colspan]="getVisibleColumnsCount()">
                                                <div class="p-2">
                                                    <p-table [value]="pedido.carrito" dataKey="pedido.carrito" styleClass="p-datatable-sm expanded-table">
                                                        <ng-template pTemplate="header">
                                        <tr>
                                            <th style="width: 2rem;"></th>
                                            <th>{{'Imagen' | translate}}</th>
                                            <th>{{'Producto' | translate}}</th>
                                            <th>{{'Cantidad' | translate}}</th>
                                            <th *ngIf="!isFromProduction">{{'Configuración' | translate}}</th>
                                        </tr>
                                    </ng-template>

                                    <ng-template pTemplate="body" let-item let-expanded="expanded">
                                        <tr>
                                            <td>
                                                <button type="button" pButton pRipple [pRowToggler]="item"
                                                    class="p-button-text p-button-rounded p-button-plain"
                                                    [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></button>
                                            </td>
                                            <td>
                                                <img height="40" width="40"
                                                    [src]="item.producto?.crearProducto?.imagenesPrincipales[0].urls"
                                                    [alt]="item.producto?.crearProducto?.imagenesPrincipales[0].nombreImagen"
                                                    style="border:1px solid #ccc;" />
                                            </td>
                                            <td>{{ item.producto?.crearProducto?.titulo }}</td>
                                            <td>{{ item.cantidad }}</td>
                                            <td *ngIf="!isFromProduction">
                                                <button type="button" pButton pRipple
                                                    (click)="confProductToCart(confProductToCartModal,item,pedido)"
                                                    class="p-button-text p-button-rounded p-button-plain"
                                                    style="font-size: 0.8em;">
                                                    <i class="fa fa-cogs"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </ng-template>

                                    <ng-template pTemplate="rowexpansion" let-configuracion>
                                        <tr>
                                            <td colspan="7">
                                                <div class="p-2">
                                                    <h5>{{'Preferencias' | translate}}</h5>
                                                    <p-table [value]="configuracion?.configuracion?.preferencias"
                                                        dataKey="configuracion.id" styleClass="p-datatable-sm expanded-table">
                                                        <ng-template pTemplate="header">
                                        <tr>
                                            <th>{{'Imagen' | translate}}</th>
                                            <th>{{'Título' | translate}}</th>
                                            <th>{{'SubTítulo' | translate}}</th>
                                            <th>{{'Iva' | translate}}</th>
                                            <th>{{'Total Iva' | translate}}</th>
                                            <th>{{'Total sin Iva' | translate}}</th>
                                            <th>{{'Cantidad' | translate}}</th>
                                            <th>{{'Total con Iva' | translate}}</th>
                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="body" let-itemconf>
                                        <tr>
                                            <td>
                                                <img height="40" width="40" [src]="itemconf.imagen"
                                                    style="border:1px solid #ccc;" />
                                            </td>
                                            <td>{{ itemconf.titulo }}</td>
                                            <td>{{ itemconf.subtitulo }}</td>
                                            <td>{{ itemconf.porcentajeIva }}</td>
                                            <td>{{ itemconf.valorIva | currency }}</td>
                                            <td>{{ itemconf.valorUnitarioSinIva | currency }}</td>
                                            <td>1</td>
                                            <td>{{ itemconf.precioTotalConIva | currency }}</td>
                                        </tr>
                                    </ng-template>
                                </p-table>

                                <h5 *ngIf="configuracion?.configuracion?.adiciones.length > 0">{{'Adiciones' |
                                    translate}}</h5>
                                <p-table *ngIf="configuracion?.configuracion?.adiciones.length > 0"
                                    [value]="configuracion?.configuracion?.adiciones" dataKey="configuracion.id"
                                    styleClass="p-datatable-sm expanded-table">
                                    <ng-template pTemplate="header">
                                        <tr>
                                            <th>{{'Imagen' | translate}}</th>
                                            <th>{{'Título' | translate}}</th>
                                            <th>{{'SubTítulo' | translate}}</th>
                                            <th>{{'Iva' | translate}}</th>
                                            <th>{{'Total Iva' | translate}}</th>
                                            <th>{{'Total sin Iva' | translate}}</th>
                                            <th>{{'Cantidad' | translate}}</th>
                                            <th>{{'Total con Iva' | translate}}</th>
                                        </tr>
                                    </ng-template>
                                    <ng-template pTemplate="body" let-itemconf>
                                        <tr>
                                            <td>
                                                <img height="40" width="40" [src]="itemconf.imagen"
                                                    style="border:1px solid #ccc;" />
                                            </td>
                                            <td>{{ itemconf.titulo }}</td>
                                            <td>{{ itemconf.subtitulo }}</td>
                                            <td>{{ itemconf.porcentajeIva }}</td>
                                            <td>{{ itemconf.valorIva | currency }}</td>
                                            <td>{{ itemconf.valorUnitarioSinIva | currency }}</td>
                                            <td>1</td>
                                            <td>{{ itemconf.precioTotalConIva | currency }}</td>
                                        </tr>
                                    </ng-template>
                                </p-table>
                            </div>
                            </td>
                            </tr>
                            </ng-template>

                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="4">{{'No hay productos en el carrito para este pedido.' | translate}}
                                    </td>
                                </tr>
                            </ng-template>
                            </p-table>
                        </div>
                        </td>
                        </tr>
                        </ng-template>

                        <!-- MENSAJE SI LA TABLA ESTÁ VACÍA -->
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td [attr.colspan]="getVisibleColumnsCount()" class="text-center">
                                    <div class="p-4">
                                        <span class="fs-18 text-muted">
                                            {{'No hay datos.' | translate}}
                                        </span>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                        </p-table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--Modales-->
<ng-template #modalContent let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">{{'Vista pedido para imprimir' | translate}}</h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <div [innerHtml]="htmlModal" #htmlPdf id="htmlPdf"></div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-outline-dark" (click)="modal.close('Save click')">{{'Cerrar' |
            translate}}</button>
        <button type="button" class="btn btn-outline-dark" (click)="imprimirToPdf()">{{'Imprimir' | translate}}</button>
    </div>
</ng-template>

<ng-template #clientesModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title"></h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <app-clientes #clientes name="clientes" id="clientes" [isEdit]="true"
            [clienteEdit]="clienteSeleccionado"></app-clientes>
    </div>
</ng-template>


<ng-template #datosEnregaModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title"></h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <pedido-entrega #entrega [pedidoGral]="pedidoSeleccionado" [formulario]="formulario" [isEdit]="true"
            [documentoBusqueda]="clienteSeleccionado.documento"
            (overridePedido)="overridePedidoByEntrega($event)"></pedido-entrega>
    </div>
</ng-template>

<ng-template #datosFacturacionModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title"></h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <app-pedido-facturacion #facturacion [pedidoGral]="pedidoSeleccionado" [formulario]="formulario" [isEdit]="true"
            [documentoBusqueda]="clienteSeleccionado.documento"></app-pedido-facturacion>
    </div>
</ng-template>

<ng-template #notasModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title"></h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <app-notas #notaspedidos 
                   [pedido]="pedidoSeleccionado" 
                   [isEdit]="true"
                   (notasActualizadas)="onNotasActualizadas($event)"></app-notas>
    </div>
</ng-template>

<ng-template #cambioEstadoPagoModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">{{'Cambiar estado de pago' | translate}}</h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <p>{{'Estás a punto de cambiar el estado de pago. Por favor, selecciona el nuevo estado de pago:' | translate}}
        </p>
        <select class="form-control" [(ngModel)]="pedidoSeleccionado.estadoPago">
            <option *ngFor="let estado of estadosPago" [value]="estado">{{estado}}</option>
        </select>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="modal.dismiss('cancel')">{{'Cancelar' |
            translate}}</button>
        <button type="button" class="btn btn-primary" (click)="cambiarEstadoPago(pedidoSeleccionado)">{{'Confirmar' |
            translate}}</button>
    </div>
</ng-template>

<!--modal pára app-conf-product-to-cart-->
<ng-template #confProductToCartModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">{{'Configurar producto' | translate}}</h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <app-conf-product-to-cart #confProductToCart [producto]="productoSeleccionado"
            [configuracionCarrito]="configuracionCarritoSeleccionado" [isEdit]="true"></app-conf-product-to-cart>
    </div>
</ng-template>


<ng-template #recompraModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">{{'Recompra' | translate}}</h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">

        <!-- Selector de Bodega (similar al de crear-ventas) -->
        <div class="warehouse-selector mb-3" *ngIf="bodegas?.length > 0">
            <div class="row align-items-center g-2">
                <div class="col-auto">
                    <div class="select-header">
                        <i class="fa fa-warehouse me-1"></i>
                        <span class="warehouse-title">{{ 'Bodega' | translate }}</span>
                    </div>
                </div>
                <div class="col">
                    <div class="position-relative">
                        <select class="form-select custom-select" (change)="onWarehouseChange($event)">
                            <option value="">{{ 'Seleccione una bodega' | translate }}</option>
                            <option *ngFor="let bodega of bodegas" [value]="bodega.idBodega">
                                {{ bodega.nombre }} ({{ bodega.idBodega }})
                            </option>
                        </select>
                        <i class="fa fa-warehouse select-icon"></i>
                    </div>
                </div>
                <div class="col-auto" *ngIf="selectedWarehouse">
                    <span class="selected-warehouse">
                        <i class="fa fa-check-circle me-1"></i><strong>{{ selectedWarehouse?.nombre }}</strong>
                    </span>
                </div>
            </div>
        </div>

        <app-ecomerce-products #recompra [ciudad]="ciudadSeleccionada" [bodega]="selectedWarehouse?.idBodega" [isRebuy]="true"></app-ecomerce-products>
    </div>
</ng-template>


<ng-template #pagosModal let-modal>
    <div class="modal-header">
        <h4 class="modal-title" id="modal-basic-title">{{'Historial pagos' | translate}}</h4>
        <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div class="modal-body">
        <app-asentarpagomanual #asentarpago [pedido]="pedidoSeleccionado" [formulario]="formulario"
            [isEdit]="true"></app-asentarpagomanual>
    </div>
</ng-template>

<!-- Modal de Opciones -->
<div *ngIf="modalVisible" class="custom-modal-overlay" (click)="onBackdropClick($event)">
  <div class="custom-modal">
    <div class="custom-modal-content">
      <!-- Modal Header -->
      <div class="modal-header border-0 pb-2">
        <div class="d-flex align-items-center">
          <div class="option-modal-icon me-3">
            <i class="pi pi-cog"></i>
          </div>
          <div>
            <h5 class="modal-title mb-0">{{ 'Opciones del Pedido' | translate }}</h5>
            <small class="text-muted">{{ 'Pedido #' | translate }}{{ selectedOrder?.nroPedido }}</small>
          </div>
        </div>
        <button type="button" class="btn-close" (click)="closeOptionsModal()" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body pt-2">
        <div class="options-grid">
          
          <!-- Imprimir PDF -->
          <button class="option-btn" type="button" (click)="pdfOrder(modalContent, selectedOrder); closeOptionsModal()">
            <div class="option-icon pdf-icon">
              <i class="fa fa-file-pdf-o"></i>
            </div>
            <div class="option-content">
              <span class="option-title">{{ 'Imprimir PDF' | translate }}</span>
              <small class="option-description">{{ 'Generar documento del pedido' | translate }}</small>
            </div>
          </button>

          <!-- Producción (solo si isFromProduction) -->
          <button *ngIf="isFromProduction" class="option-btn" type="button" (click)="produceOrder(selectedOrder); closeOptionsModal()">
            <div class="option-icon production-icon">
              <i class="fa fa-sitemap"></i>
            </div>
            <div class="option-content">
              <span class="option-title">{{ 'Producción' | translate }}</span>
              <small class="option-description">{{ 'Gestionar proceso productivo' | translate }}</small>
            </div>
          </button>

          <!-- Editar Cliente -->
          <button *ngIf="!isFromProduction" class="option-btn" type="button" (click)="editDatosClientes(clientesModal, selectedOrder); closeOptionsModal()">
            <div class="option-icon client-icon">
              <i class="fa fa-user"></i>
            </div>
            <div class="option-content">
              <span class="option-title">{{ 'Editar Cliente' | translate }}</span>
              <small class="option-description">{{ 'Modificar datos del cliente' | translate }}</small>
            </div>
          </button>

          <!-- Editar Dirección -->
          <button *ngIf="!isFromProduction" class="option-btn" type="button" (click)="editDatosEntrega(datosEnregaModal, selectedOrder); closeOptionsModal()">
            <div class="option-icon address-icon">
              <i class="fa fa-map-marker"></i>
            </div>
            <div class="option-content">
              <span class="option-title">{{ 'Editar Dirección' | translate }}</span>
              <small class="option-description">{{ 'Modificar dirección de entrega' | translate }}</small>
            </div>
          </button>

          <!-- Editar Facturación -->
          <button *ngIf="!isFromProduction" class="option-btn" type="button" (click)="editDatosFacturacion(datosFacturacionModal, selectedOrder); closeOptionsModal()">
            <div class="option-icon billing-icon">
              <i class="fa fa-credit-card"></i>
            </div>
            <div class="option-content">
              <span class="option-title">{{ 'Editar Facturación' | translate }}</span>
              <small class="option-description">{{ 'Modificar datos de facturación' | translate }}</small>
            </div>
          </button>

          <!-- Editar Notas -->
          <button *ngIf="!isFromProduction" class="option-btn" type="button" (click)="editNotas(notasModal, selectedOrder); closeOptionsModal()">
            <div class="option-icon notes-icon">
              <i class="fa fa-sticky-note"></i>
            </div>
            <div class="option-content">
              <span class="option-title">{{ 'Editar Notas' | translate }}</span>
              <small class="option-description">{{ 'Agregar o modificar notas' | translate }}</small>
            </div>
          </button>

          <!-- Estado de Pago -->
          <button *ngIf="!isFromProduction" class="option-btn" type="button" (click)="editarEstadoPago(cambioEstadoPagoModal, selectedOrder); closeOptionsModal()">
            <div class="option-icon payment-icon">
              <i class="fa fa-credit-card-alt"></i>
            </div>
            <div class="option-content">
              <span class="option-title">{{ 'Estado de Pago' | translate }}</span>
              <small class="option-description">{{ 'Cambiar estado del pago' | translate }}</small>
            </div>
          </button>

          <!-- Agregar Productos -->
          <button *ngIf="!isFromProduction" class="option-btn" type="button" (click)="addProductToCart(recompraModal, selectedOrder); closeOptionsModal()">
            <div class="option-icon cart-icon">
              <i class="fa fa-shopping-cart"></i>
            </div>
            <div class="option-content">
              <span class="option-title">{{ 'Agregar Productos' | translate }}</span>
              <small class="option-description">{{ 'Añadir más productos al pedido' | translate }}</small>
            </div>
          </button>

          <!-- Asignar Asesor -->
          <button *ngIf="!isFromProduction" class="option-btn" type="button" (click)="editSeller(selectedOrder); closeOptionsModal()">
            <div class="option-icon seller-icon">
              <i class="fa fa-users"></i>
            </div>
            <div class="option-content">
              <span class="option-title">{{ 'Asignar Asesor' | translate }}</span>
              <small class="option-description">{{ 'Cambiar asesor responsable' | translate }}</small>
            </div>
          </button>

          <!-- Historial de Pagos -->
          <button *ngIf="!isFromProduction" class="option-btn" type="button" (click)="AsentarPago(pagosModal, selectedOrder); closeOptionsModal()">
            <div class="option-icon history-icon">
              <i class="fa fa-history"></i>
            </div>
            <div class="option-content">
              <span class="option-title">{{ 'Historial Pagos' | translate }}</span>
              <small class="option-description">{{ 'Ver historial de pagos' | translate }}</small>
            </div>
          </button>

          <!-- Eliminar Pedido (Solo usuarios autorizados) -->
          <button *ngIf="canDeleteOrder() && !isFromProduction" class="option-btn danger-btn" type="button" (click)="confirmDeleteOrder(selectedOrder); closeOptionsModal()">
            <div class="option-icon delete-icon">
              <i class="fa fa-trash"></i>
            </div>
            <div class="option-content">
              <span class="option-title">{{ 'Eliminar Pedido' | translate }}</span>
              <small class="option-description">{{ 'Eliminar permanentemente' | translate }}</small>
            </div>
          </button>

        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer border-0 pt-2">
        <button type="button" class="btn btn-secondary btn-sm" (click)="closeOptionsModal()">
          <i class="fa fa-times me-1"></i>
          {{ 'Cancelar' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>

<!--Fin Modales-->
