<div class="floating-button-container" 
     *ngIf="authService.isLoggedIn"
     [ngClass]="{
        'open': chatFormVisible, 
        'minimized': chatMinimized,
        'options-visible': optionsPanelVisible,
        'voice-mode': selectedMode === 'voice' && isListening,
        'voice-call-mode': selectedMode === 'voice' && isListening && isMobile
     }">
  
  <!-- Botón flotante principal -->
  <button class="floating-button" 
          (click)="toggleOptionsPanel($event)" 
          [ngClass]="{
            'active': chatFormVisible || optionsPanelVisible, 
            'has-unread': hasUnreadMessages,
            'listening': isListening
          }">
    <span class="notification-indicator" *ngIf="hasUnreadMessages"></span>
    <i *ngIf="isListening" class="listening-indicator"></i>
  </button>
  
  <!-- Panel de opciones - Envolver en un div posicionado -->
  <div class="options-wrapper" *ngIf="optionsPanelVisible">
    <div class="options-panel">
      <div class="options-header">
        <span>¿Cómo puedo ayudarte?</span>
        <button class="close-options-btn" (click)="closeEverything($event)" title="Cerrar">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="options-list">
        <div class="option-item" (click)="selectMode('chat', $event)" [ngClass]="{'selected': selectedMode === 'chat'}">
          <div class="option-icon">
            <i class="fa fa-comments"></i>
          </div>
          <div class="option-details">
            <span class="option-title">Chat</span>
            <span class="option-description">Conversa con K.A.I. por mensajes</span>
          </div>
        </div>
        
        <div class="option-item" (click)="selectMode('voice', $event)" [ngClass]="{'selected': selectedMode === 'voice'}">
          <div class="option-icon">
            <i class="fa fa-microphone"></i>
          </div>
          <div class="option-details">
            <span class="option-title">Voz</span>
            <span class="option-description">Habla con K.A.I. usando tu micrófono</span>
          </div>
        </div>
        
        <div class="option-item" (click)="selectMode('help', $event)" [ngClass]="{'selected': selectedMode === 'help'}">
          <div class="option-icon">
            <i class="fa fa-question-circle"></i>
          </div>
          <div class="option-details">
            <span class="option-title">Ayuda</span>
            <span class="option-description">Guía de uso y preguntas frecuentes</span>
          </div>
        </div>
        
        <div class="option-item" (click)="selectMode('feedback', $event)" [ngClass]="{'selected': selectedMode === 'feedback'}">
          <div class="option-icon">
            <i class="fa fa-star"></i>
          </div>
          <div class="option-details">
            <span class="option-title">Feedback</span>
            <span class="option-description">Califica y mejora a K.A.I.</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tooltip que se muestra cuando el botón está en estado normal -->
  <span class="tooltip-text-floating" *ngIf="!chatFormVisible && !chatMinimized && !optionsPanelVisible && !isListening">
    Pregúntale a K.A.I.
  </span>
  
  <!-- Modo de voz - versión normal y móvil -->
  <div *ngIf="selectedMode === 'voice' && isListening" class="voice-mode-container" [ngClass]="{'voice-call-mode': isMobile}">
    <!-- Vista tipo llamada para móvil -->
    <div *ngIf="isMobile" class="voice-call-ui">
      <div class="call-header">
        <span class="call-status">Llamada en curso con K.A.I.</span>
        <span class="call-timer">{{callDuration}}</span>
      </div>
      
      <div class="call-avatar-container">
        <div class="call-avatar"></div>
        <div class="call-name">K.A.I.</div>
        <div class="call-status-text">{{currentStepText || 'Escuchando...'}}</div>
      </div>
      
      <!-- Nueva área para mostrar imágenes por pasos -->
      <div class="call-visual-content" [ngClass]="{'has-content': hasVisualContent}">
        <div class="content-steps" *ngIf="hasVisualContent">
          <!-- Indicador de pasos mejorado -->
          <div class="steps-indicator">
            <div class="step-dot" *ngFor="let step of visualSteps; let i = index" 
                 [ngClass]="{'active': currentStepIndex === i}"
                 (click)="goToStep(i, $event)"
                 [title]="'Paso ' + (i+1)"></div>
          </div>
          
          <!-- Contenedor de imágenes con animación de carrusel -->
          <div class="steps-carousel">
            <div class="step-item" *ngFor="let step of visualSteps; let i = index"
                 [ngClass]="{'active': currentStepIndex === i}">
              <h5 class="step-title">Paso {{i+1}} de {{visualSteps.length}}</h5>
              <div class="step-image" [style.background-image]="'url(' + step.imageUrl + ')'"></div>
              <div class="step-caption" *ngIf="step.caption">
                {{step.caption.includes(':') ? step.caption.split(':')[1] : step.caption}}
              </div>
            </div>
          </div>
          
          <!-- Controles de navegación de pasos -->
          <div class="steps-controls" *ngIf="visualSteps.length > 1">
            <button class="step-control prev" (click)="previousStep($event)" [disabled]="currentStepIndex === 0">
              <i class="fa fa-chevron-left"></i>
            </button>
            <span class="step-counter">{{currentStepIndex + 1}} / {{visualSteps.length}}</span>
            <button class="step-control next" (click)="nextStep($event)" [disabled]="currentStepIndex >= visualSteps.length - 1">
              <i class="fa fa-chevron-right"></i>
            </button>
          </div>
        </div>
        
        <!-- Mensaje cuando no hay contenido visual -->
        <div class="no-content-message" *ngIf="!hasVisualContent">
          <i class="fa fa-image"></i>
          <span>Te mostraré los pasos para crear una venta</span>
        </div>
      </div>
      
      <div class="call-visualizer">
        <div class="call-wave"></div>
        <div class="call-wave"></div>
        <div class="call-wave"></div>
        <div class="call-wave"></div>
        <div class="call-wave"></div>
      </div>
      
      <div class="call-controls">
        <button class="call-control-btn mute-btn" (click)="toggleMute($event)" [ngClass]="{'muted': isMuted}">
          <i class="fa" [ngClass]="isMuted ? 'fa-microphone-slash' : 'fa-microphone'"></i>
        </button>
        <button class="call-control-btn end-call-btn" (click)="stopVoiceMode($event)">
          <i class="fa fa-phone"></i>
        </button>
        <button class="call-control-btn speaker-btn" (click)="toggleSpeaker($event)" [ngClass]="{'active': isSpeakerOn}">
          <i class="fa fa-volume-up"></i>
        </button>
      </div>
      
      <div *ngIf="audioError" class="call-error">{{audioError}}</div>
    </div>
    
    <!-- Vista estándar para escritorio (mantener la existente) -->
    <div *ngIf="!isMobile" class="voice-mode-standard">
      <div class="voice-mode-header">
        <span class="voice-title">K.A.I. está escuchando...</span>
        <button class="stop-voice-btn" (click)="stopVoiceMode($event)" title="Detener">
          <i class="fa fa-stop-circle"></i>
        </button>
      </div>
      <div class="voice-visualizer">
        <div class="voice-wave"></div>
        <div class="voice-wave"></div>
        <div class="voice-wave"></div>
        <div class="voice-wave"></div>
        <div class="voice-wave"></div>
      </div>
      <div class="voice-instructions">
        Habla claramente. Puedes decir "Ayuda" para obtener instrucciones.
      </div>
    </div>
  </div>
  
  <!-- Burbuja de chat minimizada -->
  <div *ngIf="chatMinimized" class="minimized-chat-bubble" (click)="maximizeChat($event)">
    <span class="minimize-text">K.A.I. asistente</span>
    <span class="notification-indicator" *ngIf="hasUnreadMessages"></span>
    <button class="maximize-chat-btn" (click)="maximizeChat($event)">
      <i class="fa fa-expand"></i>
    </button>
  </div>
  
  <!-- Contenedor de chat completo -->
  <div *ngIf="chatFormVisible && !chatMinimized" class="floating-chat-overlay">
    <!-- Barra de título del chat -->
    <div class="chat-header">
      <span class="chat-title">K.A.I. - Asistente Virtual</span>
      <div class="chat-controls">
        <button class="minimize-chat-btn" (click)="minimizeChat($event)" title="Minimizar">
          <i class="fa fa-minus"></i>
        </button>
        <button class="close-chat-btn" (click)="closeChat($event)" title="Cerrar">
          <i class="fa fa-times"></i>
        </button>
      </div>
    </div>
    
    <!-- Componente de chat -->
    <app-chat 
      [isFloating]="true" 
      class="floating-chat"
      (newMessage)="onNewMessage($event)"
      (saveConversation)="saveConversation($event)">
    </app-chat>
  </div>
</div>